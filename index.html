<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lead Studio Pro — YouTube Channel Finder</title>
<style>
  /* =========================
     THEME — Apple-ish + Purple
     ========================= */
  :root{
    --bg-0:#07080c;            /* page base */
    --bg-1:#0b0d14;            /* panels */
    --bg-2:#0f1320;            /* deeper */
    --glass: rgba(255,255,255,.06);
    --glass-2: rgba(255,255,255,.08);
    --muted:#a6b0c3;
    --text:#f5f7ff;
    --accent:#7c3aed;          /* purple */
    --accent-2:#a78bfa;        /* light purple */
    --ok:#22c55e;              /* green */
    --warn:#f59e0b;            /* amber */
    --danger:#ef4444;
    --radius:14px;
    --radius-sm:10px;
    --shadow: 0 30px 70px rgba(0,0,0,.45);
  }

  /* Base reset */
  * { box-sizing:border-box; }
  html,body { height:100%; }
  body {
    margin:0;
    font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Roboto, Inter, Arial;
    color: var(--text);
    background:
      radial-gradient(1200px 800px at 10% -20%, #24103e 0%, transparent 60%),
      radial-gradient(1200px 800px at 110% 120%, #1f1440 0%, transparent 60%),
      linear-gradient(180deg, #080910, #0a0c14 60%, #090b12);
    overflow:hidden; /* prevent random page scrollbars */
    overscroll-behavior:none;
  }

  a { color: var(--accent-2); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* ===== App shell ===== */
  .app {
    max-width: 1350px;
    margin: 0 auto;
    padding: 18px;
    display: grid;
    gap: 14px;
    grid-template-rows: auto 1fr;
    height: 100vh;
  }

  /* ===== Topbar ===== */
  .topbar {
    display:flex; gap:12px; align-items:center;
    padding: 14px;
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
  }
  .brand { display:flex; gap:2px; flex-direction:column; min-width: 230px; }
  .brand h1 { margin:0; font-size:18px; letter-spacing:.2px; color:#e9e8ff; }
  .brand p { margin:0; color: var(--muted); font-size:12px; }

  .bar-controls { display:flex; gap:8px; align-items:center; flex:1; }

  input[type="text"], input[type="number"], input[type="url"], select, textarea {
    background: var(--glass);
    border: 1px solid rgba(255,255,255,.07);
    color: var(--text);
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    outline: none;
    transition: box-shadow .18s ease, transform .12s ease, border-color .18s ease;
  }
  textarea { min-height: 44px; resize: vertical; }
  input::placeholder, textarea::placeholder { color: #8f9ab2; }

  input:focus, select:focus, textarea:focus {
    box-shadow: 0 10px 26px rgba(124,58,237,.18);
    border-color: rgba(124,58,237,.35);
    transform: translateY(-1px);
  }

  .btn {
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid rgba(255,255,255,.08);
    background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
    color: var(--text);
    font-weight: 700;
    cursor: pointer;
    transition: transform .12s ease, box-shadow .2s ease, background .2s ease;
  }
  .btn:hover { transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }
  .btn-primary {
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    border-color: transparent;
    color:#0b0d14;
    box-shadow: 0 12px 28px rgba(124,58,237,.25);
  }
  .btn-danger {
    background: linear-gradient(90deg, #d83a56, #ef4444);
    border-color: transparent;
  }
  
  /* =========================
     CUSTOM BUTTON ALIGNMENT
     ========================= */
  .button-group {
      display: flex;
      gap: 8px;
  }
  .button-group .btn {
      flex: 1;
      text-align: center;
  }

  /* ===== Main layout (3 columns) ===== */
  .main {
    display: grid;
    gap: 14px;
    grid-template-columns: 350px 1fr 420px;
    grid-template-rows: 1fr;
    min-height: 0; /* enable child overflow scrolling */
  }

  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
    padding: 14px;
    min-height: 0; /* important for overflow children */
    overflow: hidden; /* contain */
  }

  /* Filters panel (left) */
  .filters { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  .filters .full { grid-column: 1/-1; }
  .filters small { color: var(--muted); }
  .switch { display:flex; gap:8px; align-items:center; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }

  /* Results panel (center) */
  .results-wrap {
    height: 100%;
    display:grid;
    grid-template-rows: auto auto 1fr auto;
    gap: 10px;
    min-height:0;
  }
  .results-toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; }
  .results-toolbar .left { display:flex; gap:8px; align-items:center; }
  .results-toolbar .right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  .progress {
    width:180px; height:9px; border-radius: 999px;
    background: rgba(255,255,255,.07);
    overflow:hidden;
  }
  .progress > i {
    display:block; height:100%; width:0%;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    transition: width .25s ease;
  }

  .table-wrap {
    overflow:auto;
    border-radius: calc(var(--radius) - 6px);
    border: 1px solid rgba(255,255,255,.06);
  }
  table {
    width:100%;
    border-collapse: collapse;
    background: transparent;
  }
  thead th {
    position: sticky; top: 0; backdrop-filter: blur(10px);
    background: rgba(16,18,30,.6);
    color: var(--muted);
    font-weight: 600;
    font-size: 13px;
    text-align: left;
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  tbody td {
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,.06);
    vertical-align: middle;
    font-size: 14px;
  }
  tbody tr {
    transition: background .18s ease, transform .14s ease;
  }
  tbody tr:hover {
    background: rgba(124,58,237,.12);
    transform: translateY(-1px);
    cursor: pointer;
  }
  .avatar { width:42px; height:42px; border-radius: 12px; object-fit: cover; margin-right:10px; }

  /* Details panel (right) */
  .details {
    height: 100%;
    display:grid;
    grid-template-rows: auto auto 1fr;
    gap:10px; min-height:0;
  }
  .banner {
    height: 120px; border-radius: 12px; background-size: cover; background-position: center;
    border:1px solid rgba(255,255,255,.06);
  }
  .about { overflow:auto; }
  .meta { color: var(--muted); font-size: 13px; }
  .stats { display:grid; grid-template-columns: repeat(3,1fr); gap:10px; }
  .stat {
    text-align:center; padding:10px; border-radius:12px; background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
  }
  .stat b { display:block; font-size: 16px; color: #eef; }

  .videos-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .video-card { background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px; }
  .video-card img { width:100%; height:110px; object-fit:cover; border-radius:10px; }
  .video-card h4 { font-size: 13px; margin:8px 0 4px; }

  /* Custom selects + scrollbar (subtle) */
  select {
    appearance: none;
    background-image:
      linear-gradient(45deg, transparent 50%, #cfd6ea 50%),
      linear-gradient(135deg, #cfd6ea 50%, transparent 50%),
      linear-gradient(to right, transparent, transparent);
    background-position:
      calc(100% - 18px) calc(50% - 3px),
      calc(100% - 12px) calc(50% - 3px),
      calc(100% - 2.5em) 0.5em;
    background-size: 6px 6px, 6px 6px, 1px 1.8em;
    background-repeat: no-repeat;
  }

  ::-webkit-scrollbar { width: 10px; height:10px; }
  ::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, var(--accent), var(--accent-2));
    border-radius: 999px;
    border: 3px solid rgba(0,0,0,.25);
  }
  ::-webkit-scrollbar-track { background: transparent; }

  /* Responsive */
  @media (max-width: 1200px){
    .main { grid-template-columns: 1fr; grid-template-rows: 420px 1fr 520px; }
    .details { grid-template-rows: auto 1fr 1fr; }
  }
  
  /* Additional styles for authentication and admin controls */
  .auth-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 320px;
      margin: 10vh auto;
      padding: 24px;
      background: var(--bg-1);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
  }
  .auth-form h2 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 24px;
  }
  .auth-form input {
      width: 100%;
  }
  .auth-form button {
      width: 100%;
  }
  .user-info {
      display: flex;
      gap: 8px;
      align-items: center;
  }
  
  /* Message Box Styling */
  .message-box-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
  }
  .message-box {
      background: var(--bg-1);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 400px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 16px;
  }

  /* =========================
     CUSTOM CHECKBOX
     ========================= */
  .switch input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }
  .switch {
    display: flex;
    gap: 8px;
    align-items: center;
    cursor: pointer;
  }
  .switch-visual {
    width: 28px;
    height: 16px;
    background: rgba(255, 255, 255, .1);
    border-radius: 999px;
    position: relative;
    transition: background .2s ease;
  }
  .switch-visual::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 12px;
    height: 12px;
    background-color: var(--text);
    border-radius: 50%;
    transition: transform .2s ease;
  }
  .switch input[type="checkbox"]:checked + .switch-visual {
    background: var(--accent);
  }
  .switch input[type="checkbox"]:checked + .switch-visual::before {
    transform: translateX(12px);
    background-color: #fff;
  }
  .switch input[type="checkbox"]:focus + .switch-visual {
    box-shadow: 0 0 0 2px rgba(124, 58, 237, .5);
  }

  /* =========================
     CUSTOM SELECT
     ========================= */
  select {
      appearance: none;
      background: var(--glass);
      border: 1px solid rgba(255,255,255,.07);
      color: var(--text);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      outline: none;
      transition: box-shadow .18s ease, transform .12s ease, border-color .18s ease;
      cursor: pointer;
      background-image:
          linear-gradient(45deg, transparent 50%, #cfd6ea 50%),
          linear-gradient(135deg, #cfd6ea 50%, transparent 50%);
      background-position:
          calc(100% - 18px) calc(50% + 1px),
          calc(100% - 12px) calc(50% + 1px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
  }

  select:hover {
    border-color: rgba(124,58,237,.35);
    box-shadow: 0 4px 12px rgba(124,58,237,.12);
    transform: translateY(-1px);
  }
  
  /* NEW: Video Detail Panel Styles */
  .video-detail-panel {
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background-color:rgba(0,0,0,.8);
    z-index:1000;
    display: none; /* This is a key fix, it's hidden by default */
    justify-content:center;
    align-items:center;
  }
  .video-detail-panel.visible {
    display: flex;
  }
  .video-detail-content {
    background-color:var(--bg-1);
    padding:20px;
    border-radius:var(--radius);
    max-width:800px;
    width:90%;
    position:relative;
  }
  .video-container {
    position:relative;
    padding-bottom:56.25%; /* 16:9 Aspect Ratio */
    height:0;
    overflow:hidden;
  }
  .video-container iframe {
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
  }
</style>
</head>
<body>
    <div id="auth-view" class="auth-form">
        <h2>Welcome to Lead Studio Pro</h2>
        <input id="authEmail" type="email" placeholder="Email" autocomplete="username">
        <input id="authPass" type="password" placeholder="Password" autocomplete="current-password">
        <button class="btn btn-primary" id="btnSignIn">Sign In</button>
        <button class="btn" id="btnSignUp">Sign Up</button>
        <div id="authStatus" class="meta" style="text-align: center;"></div>
    </div>

    <div id="app-view" class="app" style="display:none">
        <div class="topbar">
            <div class="brand">
                <h1>Lead Studio Pro</h1>
                <p>Apple-grade UI • Advanced YouTube lead extractor</p>
            </div>
            <div class="bar-controls">
                <input id="apiKey" type="text" placeholder="YouTube API Key" value="AIzaSyBo5wWMC5T5lemycWNqtfs2_SAjApsLuFA"/>
                <textarea id="query" placeholder="Enter one or more queries (comma or newline separated)"></textarea>
                <div class="button-group" style="margin-left:auto;">
                  <button class="btn btn-primary" id="btnSearch">Search</button>
                  <button class="btn btn-primary" id="btnDeepSearch" style="background: linear-gradient(90deg, #d946ef, #a855f7);">Deep Search</button>
                  <button class="btn" id="btnClear">Clear</button>
                </div>
            </div>
        </div>

        <div class="main">
            <div class="panel">
                <div class="row" style="justify-content:space-between;margin-bottom:8px">
                    <div class="meta">Advanced Filters</div>
                    <div class="meta" id="status">Idle</div>
                </div>
                <div class="filters">
                    <select id="order"><option value="relevance">Order: Relevance</option><option value="date">Order: Date</option><option value="viewCount">Order: Views</option><option value="rating">Order: Rating</option></select>
                    <select id="duration"><option value="">Duration: Any</option><option value="short">Short (<4m)</option><option value="medium">Medium (4–20m)</option><option value="long">Long (>20m)</option></select>
                    <select id="upload"><option value="">Upload Time: Any</option><option value="hour">Last hour</option><option value="today">Today</option><option value="week">This week</option><option value="month">This month</option></select>
                    <select id="region"><option value="">Region: Any</option><option>US</option><option>IN</option><option>GB</option><option>CA</option><option>AU</option><option>DE</option></select>
                    <select id="definition"><option value="">Definition: Any</option><option value="high">HD</option><option value="standard">SD</option></select>
                    <select id="safe"><option value="">Safe: Any</option><option value="none">None</option><option value="moderate">Moderate</option><option value="strict">Strict</option></select>

                    <input id="perPage" class="full" type="number" min="1" max="50" value="25" placeholder="Results per page (1–50)"/>
                    <input id="pages" class="full" type="number" min="1" max="10" value="2" placeholder="Pages per query (1–10)"/>

                    <div class="full row">
                        <input id="minSubs" type="number" placeholder="Min subs"/>
                        <input id="maxSubs" type="number" placeholder="Max subs"/>
                        <input id="searchInResults" type="text" placeholder="Search within results (title / ID)"/>
                    </div>

                    <div class="full row">
                        <input id="corsProxy" type="url" placeholder="Optional CORS proxy for verification (best-effort)"/>
                        <label class="switch">
                            <input id="doVerify" type="checkbox"/>
                            <span class="switch-visual"></span>
                            <small>Attempt verify check</small>
                        </label>
                    </div>

                    <div class="full row" style="justify-content:space-between;margin-top:2px">
                        <div class="progress"><i id="progressBar"></i></div>
                        <small id="count">0 channels</small>
                    </div>
                </div>
            </div>

            <div class="panel results-wrap">
                <div class="results-toolbar">
                    <div class="left button-group">
                        <button class="btn" id="btnSelectAll">Select All</button>
                        <button class="btn" id="btnDeselectAll">Deselect</button>
                        <button class="btn" id="btnSaveLib">Save Library</button>
                        <button class="btn" id="btnLoadLib">Load Library</button>
                    </div>
                    <div class="right button-group">
                        <select id="clientSort">
                            <option value="subs-desc">Sort: Subs ↓</option>
                            <option value="subs-asc">Sort: Subs ↑</option>
                            <option value="views-desc">Sort: Views ↓</option>
                            <option value="views-asc">Sort: Views ↑</option>
                            <option value="title-asc">Sort: Title A→Z</option>
                            <option value="title-desc">Sort: Title Z→A</option>
                        </select>
                        <button class="btn btn-primary" id="btnExportCSV">Export CSV</button>
                        <button class="btn" id="btnExportJSON">Export JSON</button>
                        <button class="btn" id="btnCopyIDs">Copy Channel IDs</button>
                        <button class="btn btn-danger" id="btnClearResults">Clear</button>
                    </div>
                </div>

                <div class="table-wrap" id="resultsScroller">
                    <table aria-label="Channel results">
                        <thead>
                            <tr>
                                <th style="width:42px"></th>
                                <th>Channel</th>
                                <th>Subs</th>
                                <th>Videos</th>
                                <th>Views</th>
                                <th>Verified</th>
                                <th>Preview</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTbody"></tbody>
                    </table>
                </div>

                <div class="row" style="justify-content:flex-end">
                    <small class="meta">Tip: Click a row to open full details in the panel on the right.</small>
                </div>
            </div>

            <div class="panel details">
                <div>
                    <div class="row" style="justify-content:space-between">
                        <div>
                            <div class="meta">Channel Details</div>
                            <h3 id="detailTitle" style="margin:6px 0 0">Select a channel</h3>
                        </div>
                        <div class="row button-group">
                            <button class="btn" id="btnExportSelected">Export Selected</button>
                            <button class="btn" id="btnCopySelected">Copy Selected CSV</button>
                        </div>
                    </div>
                </div>
                <div id="banner" class="banner" style="display:none"></div>
                <div class="about" id="detailContent">
                    <div class="meta">No channel selected.</div>
                </div>
                <div class="meta">
                    <div class="row" style="justify-content:space-between;align-items:flex-end">
                        <div class="user-info">
                            <div id="userEmail"></div>
                        </div>
                        <button class="btn" id="btnSignOut">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="videoDetailPanel" class="video-detail-panel">
      <div class="video-detail-content">
        <button id="closeBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; color:var(--muted); font-size:1.5rem; cursor:pointer;">×</button>
        <h3 id="videoTitle" style="margin-bottom:10px;"></h3>
        <div class="video-container">
          <iframe id="videoPlayer" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p id="videoDescription" style="margin-top:20px; font-size:.9rem;"></p>
      </div>
    </div>

    <div id="messageBoxOverlay" class="message-box-overlay">
        <div id="messageBox" class="message-box">
            <h4 id="messageTitle"></h4>
            <p id="messageText"></p>
            <button class="btn btn-primary" id="messageBoxOk">OK</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";
        
        /* =========================
           STATE + HELPERS
           ========================= */
        const $ = id => document.getElementById(id);
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const esc = s => String(s ?? '').replace(/"/g,'""');
        const savedLibraryKey = 'lead_studio_pro_lib_v1';
        let currentUser = null;
        function setStatus(t){ $('status').innerText = t; }
        function setProgress(p){ $('progressBar').style.width = Math.min(100, Math.round(p*100)) + '%'; }
        let LIB = []; // enriched channels
        let VIEW = []; // filtered/sorted view
        let lastExport = [];
        let lastSearch = {};
        // Custom message box to replace alert()
        function showMessage(title, message) {
            $('messageTitle').innerText = title;
            $('messageText').innerText = message;
            const messageBox = $('messageBox');
            // Remove any existing dynamic buttons
            const dynamicButtons = messageBox.querySelectorAll('.btn:not(#messageBoxOk)');
            dynamicButtons.forEach(btn => btn.remove());
            $('messageBoxOk').style.display = 'block';
            $('messageBoxOverlay').style.display = 'flex';
        }
        $('messageBoxOk').addEventListener('click', () => {
            $('messageBoxOverlay').style.display = 'none';
        });
        // === FIREBASE CONFIGURATION ===
        const firebaseConfig = {
            apiKey: "AIzaSyBvU3_Njbi1JQr_wD1a16h5coTW2ifaRDU",
            authDomain: "youleadmax.firebaseapp.com",
            projectId: "youleadmax",
            storageBucket: "youleadmax.firebasestorage.app",
            messagingSenderId: "710806971072",
            appId: "1:710806971072:web:ced903befe8693f886c325",
            measurementId: "G-JW9W20C1LQ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const logSearchCallable = httpsCallable(functions, 'logSearch');
        /* ========================= AUTHENTICATION ========================= */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('app-view').style.display = 'grid';
                $('auth-view').style.display = 'none';
                $('userEmail').innerText = `Logged in as: ${user.email}`;
                // Log user usage for tracking purposes
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, { lastLogin: new Date().toISOString() }, { merge: true });
            } else {
                currentUser = null;
                $('app-view').style.display = 'none';
                $('auth-view').style.display = 'flex';
            }
        });
        $('btnSignIn').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                $('authStatus').innerText = 'Sign-in failed: ' + error.message;
            }
        });
        $('btnSignUp').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                $('authStatus').innerText = 'Sign-up failed: ' + error.message;
            }
        });
        $('btnSignOut').addEventListener('click', async () => {
            await signOut(auth);
            resetResults();
        });
        /* ========================= SEARCH / FETCH ========================= */
        $('btnSearch').addEventListener('click', () => searchAll(false));
        $('btnDeepSearch').addEventListener('click', () => {
            const queryRaw = $('query').value.trim();
            if (!queryRaw.length) {
                showMessage('Search Error', 'Please enter at least one query.');
                return;
            }
            if (!currentUser) {
                showMessage('Authentication Required', 'Please sign in first.');
                return;
            }
            // Display a confirmation message box
            $('messageTitle').innerText = 'Deep Search Confirmation';
            $('messageText').innerText = 'Deep Search will consume more API credits by searching more pages. Do you want to continue?';
            const messageBox = $('messageBox');
            const oldOkBtn = $('messageBoxOk');
            const confirmButton = document.createElement('button');
            confirmButton.className = 'btn btn-primary';
            confirmButton.innerText = 'Yes, Continue';
            confirmButton.addEventListener('click', () => {
                $('messageBoxOverlay').style.display = 'none';
                searchAll(true);
            });
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn';
            cancelButton.innerText = 'Cancel';
            cancelButton.addEventListener('click', () => {
                $('messageBoxOverlay').style.display = 'none';
            });
            oldOkBtn.style.display = 'none';
            messageBox.appendChild(confirmButton);
            messageBox.appendChild(cancelButton);
            $('messageBoxOverlay').style.display = 'flex';
        });
        async function searchAll(isDeepSearch = false) {
            const queries = $('query').value.split(/,?\n/).map(q => q.trim()).filter(q => q.length > 0);
            const apiKey = $('apiKey').value;
            const pagesToFetch = isDeepSearch ? parseInt($('pages').value) : 1;
            if (!queries.length) return showMessage('Search Error', 'Please enter at least one query.');
            if (!apiKey) return showMessage('API Key Missing', 'Please enter your YouTube API key.');

            resetResults();
            setStatus('Searching...');
            const startTime = performance.now();
            let allChannelIds = new Set();
            try {
                for (const [i, query] of queries.entries()) {
                    await fetchAndEnrich(query, apiKey, pagesToFetch);
                    setProgress((i + 1) / queries.length);
                }
                setStatus(`Search complete! Fetched ${allChannelIds.size} channels in ${((performance.now() - startTime) / 1000).toFixed(2)}s.`);
            } catch (error) {
                console.error('Search failed:', error);
                setStatus('Search failed');
                showMessage('Search Failed', `An error occurred: ${error.message}`);
            }
            logSearchCallable({
                query: queries.join(', '),
                deepSearch: isDeepSearch,
                results: VIEW.length,
                duration: ((performance.now() - startTime) / 1000).toFixed(2)
            });
        }
        async function fetchAndEnrich(query, apiKey, pagesToFetch) {
            let nextPageToken = null;
            let fetchedCount = 0;
            const perPage = $('perPage').value;
            const order = $('order').value;
            const duration = $('duration').value;
            const upload = $('upload').value;
            const definition = $('definition').value;
            const safe = $('safe').value;
            for (let i = 0; i < pagesToFetch; i++) {
                let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=channel&maxResults=${perPage}&order=${order}&videoDuration=${duration}&uploadTime=${upload}&videoDefinition=${definition}&safeSearch=${safe}&key=${apiKey}`;
                if (nextPageToken) url += `&pageToken=${nextPageToken}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.error) throw new Error(data.error.message);
                if (!data.items || data.items.length === 0) break;

                const channelIds = data.items.map(item => item.snippet.channelId);
                const enrichedChannels = await getChannelDetails(channelIds);
                
                enrichedChannels.forEach(c => {
                    const isNew = !LIB.some(libC => libC.id === c.id);
                    if (isNew) {
                        LIB.push(c);
                    }
                });

                fetchedCount += data.items.length;
                nextPageToken = data.nextPageToken;

                updateMetrics();
                renderResults(LIB);
                
                if (!nextPageToken) break;
            }
            return fetchedCount;
        }

        async function getChannelDetails(channelIds) {
            const apiKey = $('apiKey').value;
            const joinedIds = channelIds.join(',');
            const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings&id=${joinedIds}&key=${apiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            const details = data.items.map(item => ({
                id: item.id,
                title: item.snippet.title,
                subscribers: parseInt(item.statistics.subscriberCount),
                videoCount: parseInt(item.statistics.videoCount),
                viewCount: parseInt(item.statistics.viewCount),
                thumbnail: item.snippet.thumbnails.default.url,
                banner: item.brandingSettings?.image?.bannerExternalUrl,
                description: item.snippet.description
            }));
            if ($('doVerify').checked) {
                for (let channel of details) {
                    channel.isVerified = await isVerified(channel.id);
                }
            }
            return details;
        }
        
        // NEW: Function to get the latest video for a channel
        async function getLatestVideo(channelId) {
            const apiKey = $('apiKey').value;
            const url = `https://www.googleapis.com/youtube/v3/search?part=id,snippet&channelId=${channelId}&order=date&maxResults=1&key=${apiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.items.length > 0) {
                const item = data.items[0];
                return {
                    id: item.id.videoId,
                    title: item.snippet.title,
                    description: item.snippet.description
                };
            }
            return null;
        }

        async function isVerified(channelId) {
            const proxy = $('corsProxy').value || 'https://corsproxy.io/?';
            const url = `${proxy}https://www.youtube.com/channel/${channelId}`;
            try {
                const response = await fetch(url);
                const html = await response.text();
                return html.includes('aria-label="Verified"');
            } catch (error) {
                console.error(`CORS proxy failed or channel not found: ${channelId}`, error);
                return 'N/A';
            }
        }
        
        async function getSocialLinksFromAboutPage(channelId) {
            const proxyUrl = $('corsProxy').value || '';
            const aboutUrl = `${proxyUrl}https://www.youtube.com/channel/${channelId}/about`;
            
            try {
                const response = await fetch(aboutUrl);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const socialLinks = {};
                const linkElements = doc.querySelectorAll('.yt-formatted-string a');
                
                linkElements.forEach(link => {
                    const url = link.href;
                    if (url.includes('twitter.com')) socialLinks.twitter = url;
                    else if (url.includes('instagram.com')) socialLinks.instagram = url;
                    else if (url.includes('facebook.com')) socialLinks.facebook = url;
                    else if (url.includes('tiktok.com')) socialLinks.tiktok = url;
                    else if (url.includes('linkedin.com')) socialLinks.linkedin = url;
                    else if (!socialLinks.website) socialLinks.website = url;
                });
                
                return socialLinks;
            } catch (error) {
                console.error('Failed to retrieve social links:', error);
                return {};
            }
        }
        
        /* ========================= RENDER / UI ========================= */
        function renderResults(channels) {
            VIEW = filterAndSort(channels);
            const tbody = $('resultsTbody');
            tbody.innerHTML = '';
            if (VIEW.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:var(--muted)">No results found.</td></tr>`;
                return;
            }
            VIEW.forEach(channel => {
                const tr = document.createElement('tr');
                tr.dataset.channelId = channel.id;
                tr.innerHTML = `
                    <td class="select-cell"><input type="checkbox" class="channel-select"/></td>
                    <td>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img src="${channel.thumbnail}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                            <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" style="color:var(--text); text-decoration:none;">${channel.title}</a>
                        </div>
                    </td>
                    <td>${formatNumber(channel.subscribers)}</td>
                    <td>${formatNumber(channel.videoCount)}</td>
                    <td>${formatNumber(channel.viewCount)}</td>
                    <td>${channel.isVerified === true ? '✅' : channel.isVerified === false ? '❌' : 'N/A'}</td>
                    <td>
                        <button class="btn preview-btn" data-channel-id="${channel.id}">Preview Video</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateMetrics();
        }
        
        // NEW: Function to display the video preview panel
        async function showVideoPreview(channelId) {
            const video = await getLatestVideo(channelId);
            if (video) {
                $('videoTitle').innerText = video.title;
                $('videoDescription').innerText = video.description;
                $('videoPlayer').src = `https://www.youtube.com/embed/${video.id}?autoplay=1`;
                $('videoDetailPanel').classList.add('visible'); // Show the panel
            } else {
                showMessage('Video Not Found', 'Could not find a recent video for this channel.');
            }
        }
        
        // NEW: Function to hide the video preview panel
        function hideVideoPreview() {
            $('videoDetailPanel').classList.remove('visible'); // Hide the panel
            $('videoPlayer').src = ''; // Stop the video
        }

        function filterAndSort(channels) {
            let filtered = channels;
            const minSubs = parseInt($('minSubs').value) || 0;
            const maxSubs = parseInt($('maxSubs').value) || Infinity;
            const searchInResults = $('searchInResults').value.toLowerCase();

            filtered = filtered.filter(c => {
                const titleMatch = c.title.toLowerCase().includes(searchInResults);
                const idMatch = c.id.toLowerCase().includes(searchInResults);
                const subsMatch = c.subscribers >= minSubs && c.subscribers <= maxSubs;
                return (titleMatch || idMatch) && subsMatch;
            });
            
            const sortKey = $('clientSort').value;
            filtered.sort((a, b) => {
                switch (sortKey) {
                    case 'subs-desc': return b.subscribers - a.subscribers;
                    case 'subs-asc': return a.subscribers - b.subscribers;
                    case 'views-desc': return b.viewCount - a.viewCount;
                    case 'views-asc': return a.viewCount - b.viewCount;
                    case 'title-asc': return a.title.localeCompare(b.title);
                    case 'title-desc': return b.title.localeCompare(a.title);
                }
            });
            return filtered;
        }

        function updateMetrics() {
            $('count').innerText = `${VIEW.length} channels (${LIB.length} total)`;
        }
        function resetResults() {
            LIB = [];
            VIEW = [];
            $('resultsTbody').innerHTML = '';
            updateMetrics();
        }

        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return num;
        }
        
        function downloadFile(filename, mimeType, content) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getSelectedChannels() {
            const selectedRows = Array.from($('resultsTbody').querySelectorAll('.channel-select:checked'));
            const selectedIds = selectedRows.map(input => input.closest('tr').dataset.channelId);
            return LIB.filter(c => selectedIds.includes(c.id));
        }

        // === EVENT LISTENERS ===
        
        // NEW: Event listeners for the new functionality
        $('resultsTbody').addEventListener('click', (e) => {
            const btn = e.target.closest('.preview-btn');
            if (btn) {
                const channelId = btn.dataset.channelId;
                showVideoPreview(channelId);
            }
        });

        $('closeBtn').addEventListener('click', () => {
            hideVideoPreview();
        });

        $('btnClear').addEventListener('click', resetResults);
        $('btnClearResults').addEventListener('click', resetResults);
        $('clientSort').addEventListener('change', () => renderResults(LIB));
        $('minSubs').addEventListener('input', () => renderResults(LIB));
        $('maxSubs').addEventListener('input', () => renderResults(LIB));
        $('searchInResults').addEventListener('input', () => renderResults(LIB));
        
        $('btnExportCSV').addEventListener('click', () => {
            lastExport = LIB;
            const rows = lastExport.map(c => `"${esc(c.title)}","${c.id}","${c.subscribers}","${c.videoCount}","${c.viewCount}","${c.isVerified}"`);
            const csvContent = "data:text/csv;charset=utf-8," + "Channel,ID,Subscribers,Videos,Views,Verified\n" + rows.join('\n');
            downloadFile('channels.csv', 'text/csv', csvContent);
        });

        $('btnExportJSON').addEventListener('click', () => {
            lastExport = LIB;
            const jsonContent = JSON.stringify(lastExport, null, 2);
            downloadFile('channels.json', 'application/json', jsonContent);
        });

        $('btnCopyIDs').addEventListener('click', () => {
            const ids = LIB.map(c => c.id).join('\n');
            navigator.clipboard.writeText(ids).then(() => {
                showMessage('Success', 'Copied all channel IDs to clipboard!');
            }).catch(e => {
                showMessage('Failed', 'Could not copy IDs. Please try again.');
            });
        });
        
        $('btnExportSelected').addEventListener('click', () => {
            const selected = getSelectedChannels();
            const rows = selected.map(c => `"${esc(c.title)}","${c.id}","${c.subscribers}","${c.videoCount}","${c.viewCount}","${c.isVerified}"`);
            const csvContent = "data:text/csv;charset=utf-8," + "Channel,ID,Subscribers,Videos,Views,Verified\n" + rows.join('\n');
            downloadFile('selected_channels.csv', 'text/csv', csvContent);
        });
        
        $('btnCopySelected').addEventListener('click', () => {
            const selected = getSelectedChannels();
            const rows = selected.map(c => `"${esc(c.title)}","${c.id}","${c.subscribers}","${c.videoCount}","${c.viewCount}","${c.isVerified}"`);
            const csvContent = "Channel,ID,Subscribers,Videos,Views,Verified\n" + rows.join('\n');
            navigator.clipboard.writeText(csvContent).then(() => {
                showMessage('Success', 'Copied selected channels as CSV to clipboard!');
            }).catch(e => {
                showMessage('Failed', 'Could not copy. Please try again.');
            });
        });
        
        $('resultsTbody').addEventListener('click', async (e) => {
            const row = e.target.closest('tr');
            if (row && !e.target.closest('.preview-btn')) {
                const channelId = row.dataset.channelId;
                const channel = LIB.find(c => c.id === channelId);
                if (channel) {
                    renderDetailPanel(channel);
                }
            }
        });
        
        function renderDetailPanel(channel) {
            $('detailTitle').innerText = channel.title;
            
            const aboutContent = $('detailContent');
            aboutContent.innerHTML = '';
            
            if (channel.banner) {
                $('banner').style.backgroundImage = `url(${channel.banner})`;
                $('banner').style.display = 'block';
            } else {
                $('banner').style.display = 'none';
            }
            
            const statsHtml = `
                <div class="stats">
                    <div class="stat"><b>${formatNumber(channel.subscribers)}</b><small>Subs</small></div>
                    <div class="stat"><b>${formatNumber(channel.videoCount)}</b><small>Videos</small></div>
                    <div class="stat"><b>${formatNumber(channel.viewCount)}</b><small>Views</small></div>
                </div>
            `;
            
            const descriptionHtml = `
                <div style="margin-top: 12px;">
                    <small class="meta">Description</small>
                    <p>${channel.description || 'No description provided.'}</p>
                </div>
            `;
            
            aboutContent.innerHTML = statsHtml + descriptionHtml;
        }

        $('btnSelectAll').addEventListener('click', () => {
            document.querySelectorAll('.channel-select').forEach(checkbox => checkbox.checked = true);
        });

        $('btnDeselectAll').addEventListener('click', () => {
            document.querySelectorAll('.channel-select').forEach(checkbox => checkbox.checked = false);
        });
        
        // Firestore Public Library Save/Load
        const PUBLIC_LIBRARIES_COLLECTION = 'userLibraries';
        import { getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        $('btnSaveLib').addEventListener('click', async () => {
            if (!currentUser) {
                return showMessage('Save Failed', 'Please sign in to save your library.');
            }
            if (LIB.length === 0) {
                return showMessage('Save Failed', 'No channels to save.');
            }
            try {
                const userDocRef = doc(db, PUBLIC_LIBRARIES_COLLECTION, currentUser.uid);
                await setDoc(userDocRef, {
                    library: LIB,
                    timestamp: new Date().toISOString()
                }, { merge: true });
                showMessage('Save Success', `Saved ${LIB.length} channels to your library.`);
            } catch (e) {
                console.error(e);
                showMessage('Save Failed', 'Failed to save library to Firestore. Check console for details.');
            }
        });

        $('btnLoadLib').addEventListener('click', async () => {
            if (!currentUser) {
                return showMessage('Load Failed', 'Please sign in to load your library.');
            }
            try {
                const userDocRef = doc(db, PUBLIC_LIBRARIES_COLLECTION, currentUser.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists() && docSnap.data().library) {
                    LIB = docSnap.data().library;
                    renderResults(LIB);
                    updateMetrics();
                    showMessage('Load Success', `Loaded ${LIB.length} channels from your library.`);
                } else {
                    showMessage('Load Failed', 'No saved library found.');
                }
            } catch (e) {
                console.error(e);
                showMessage('Load Failed', 'Failed to load library from Firestore. Data may be corrupted or permission denied.');
            }
        });
    </script>
</body>
</html>
