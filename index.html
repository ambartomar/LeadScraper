<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lead Studio Pro — YouTube Channel Finder</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* =========================
     THEME — Tailwind Custom
     ========================= */
  :root {
      --bg-dark: #07090D;
      --panel-bg: rgba(255, 255, 255, 0.04);
      --border-color: rgba(255, 255, 255, 0.1);
      --purple-accent: #8b5cf6; /* Tailwind's purple-500 */
      --purple-hover: #7c3aed; /* Tailwind's purple-600 */
      --text-light: #e2e8f0;
      --text-muted: #94a3b8;
  }
  
  /* Base reset */
  body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-light);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
  }
  
  /* Custom scrollbar for WebKit browsers */
  ::-webkit-scrollbar {
      width: 8px;
  }
  
  ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 999px;
  }
  
  ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
  }
  
  /* Custom Select Arrow */
  select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-chevron-down'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-size: 16px;
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
  }
  
  /* Animation for new rows */
  .fade-in {
      animation: fadeIn 0.5s ease-in-out;
  }
  
  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
  }
  
  /* Responsive */
  @media (max-width: 1280px) {
      .grid-layout {
          grid-template-columns: 1fr !important;
          grid-template-rows: auto 1fr auto !important;
      }
      .filters-panel {
          height: 480px;
      }
      .details-panel {
          height: 520px;
      }
  }
  
</style>
</head>
<body class="bg-[#07090D] text-gray-200 antialiased font-inter overflow-hidden">

<div id="auth-view" class="flex flex-col gap-4 p-8 bg-gray-900 rounded-3xl shadow-2xl max-w-sm mx-auto my-[10vh]">
    <h2 class="text-center text-3xl font-bold text-white mb-2">Welcome to Lead Studio Pro</h2>
    <input id="authEmail" type="email" placeholder="Email" autocomplete="username" class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
    <input id="authPass" type="password" placeholder="Password" autocomplete="current-password" class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
    <button id="btnSignIn" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">Sign In</button>
    <button id="btnSignUp" class="w-full py-3 bg-transparent border border-gray-700 text-gray-300 font-bold rounded-xl hover:bg-gray-800 transition-colors">Sign Up</button>
    <div id="authStatus" class="text-xs text-gray-500 text-center mt-2"></div>
</div>

<div id="app-view" class="p-4 md:p-6 lg:p-8 grid grid-rows-[auto_1fr] h-screen gap-4 md:gap-6 lg:gap-8 overflow-hidden" style="display:none">
    <div class="topbar flex items-center gap-4 bg-gray-800/50 backdrop-blur-lg border border-gray-700/50 rounded-2xl p-4 shadow-2xl">
        <div class="brand flex-shrink-0 flex flex-col min-w-[200px]">
            <h1 class="text-xl font-bold text-white tracking-wide">Lead Studio Pro</h1>
            <p class="text-sm text-gray-400">Advanced YouTube lead extractor</p>
        </div>
        <div class="bar-controls flex-1 flex flex-wrap items-center gap-4">
            <input id="apiKey" type="text" placeholder="YouTube API Key" value="AIzaSyBo5wWMC5T5lemycWNqtfs2_SAjApsLuFA" class="flex-1 min-w-[150px] bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
            <textarea id="query" placeholder="Enter one or more queries (comma or newline separated)" class="flex-1 min-w-[200px] bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all resize-none h-12"></textarea>
            <div class="button-group flex-shrink-0 flex items-center gap-3 ml-auto">
                <button id="btnSearch" class="btn btn-primary py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-all">Search</button>
                <button id="btnDeepSearch" class="btn btn-primary py-3 px-6 bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold rounded-xl transition-all">Deep Search</button>
                <button id="btnClear" class="btn btn-secondary py-3 px-6 bg-gray-800 hover:bg-gray-700 text-gray-200 font-bold rounded-xl transition-colors">Clear</button>
            </div>
        </div>
    </div>

    <div class="main grid grid-cols-[350px_1fr_420px] gap-4 md:gap-6 lg:gap-8 overflow-hidden grid-layout">
        <div class="panel filters-panel flex flex-col p-6 bg-gray-800/50 backdrop-blur-lg border border-gray-700/50 rounded-2xl shadow-2xl overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div class="text-sm text-gray-400 font-semibold">Advanced Filters</div>
                <div id="status" class="text-sm text-purple-400 font-semibold">Idle</div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <select id="order" class="bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"><option value="relevance">Order: Relevance</option><option value="date">Order: Date</option><option value="viewCount">Order: Views</option><option value="rating">Order: Rating</option></select>
                <select id="duration" class="bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"><option value="">Duration: Any</option><option value="short">Short (&lt;4m)</option><option value="medium">Medium (4–20m)</option><option value="long">Long (&gt;20m)</option></select>
                <select id="upload" class="bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"><option value="">Upload Time: Any</option><option value="hour">Last hour</option><option value="today">Today</option><option value="week">This week</option><option value="month">This month</option></select>
                <select id="region" class="bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"><option value="">Region: Any</option><option>US</option><option>IN</option><option>GB</option><option>CA</option><option>AU</option><option>DE</option></select>
                <select id="definition" class="bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"><option value="">Definition: Any</option><option value="high">HD</option><option value="standard">SD</option></select>
                <select id="safe" class="bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"><option value="">Safe: Any</option><option value="none">None</option><option value="moderate">Moderate</option><option value="strict">Strict</option></select>
            </div>
            <div class="flex flex-col gap-3">
                <input id="perPage" class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" type="number" min="1" max="50" value="25" placeholder="Results per page (1–50)"/>
                <input id="pages" class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" type="number" min="1" max="10" value="2" placeholder="Pages per query (1–10)"/>
            </div>
            <div class="mt-4 flex flex-col gap-3">
                <div class="flex gap-3">
                    <input id="minSubs" type="number" placeholder="Min subs" class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"/>
                    <input id="maxSubs" type="number" placeholder="Max subs" class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"/>
                </div>
                <input id="searchInResults" type="text" placeholder="Search within results (title / ID)" class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"/>
            </div>
            <div class="mt-4 flex flex-col gap-3">
                <input id="corsProxy" type="url" placeholder="Optional CORS proxy" class="w-full bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-3 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"/>
                <label class="switch flex items-center cursor-pointer">
                    <input id="doVerify" type="checkbox" class="sr-only"/>
                    <div class="relative w-11 h-6 bg-gray-600 rounded-full peer-checked:bg-purple-600 transition-colors">
                        <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform transform peer-checked:translate-x-5"></div>
                    </div>
                    <span class="ml-2 text-sm text-gray-400">Attempt verify check</span>
                </label>
            </div>
            <div class="flex items-center justify-between mt-auto pt-4">
                <div class="w-40 h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-purple-500 to-fuchsia-500 transition-all duration-300 ease-out" style="width:0%"></div>
                </div>
                <small id="count" class="text-sm text-gray-400">0 channels</small>
            </div>
        </div>

        <div class="panel results-panel flex flex-col p-6 bg-gray-800/50 backdrop-blur-lg border border-gray-700/50 rounded-2xl shadow-2xl overflow-hidden">
            <div class="results-toolbar flex flex-wrap items-center justify-between gap-4 mb-4">
                <div class="left button-group flex items-center flex-wrap gap-3">
                    <button id="btnSelectAll" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Select All</button>
                    <button id="btnDeselectAll" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Deselect</button>
                    <button id="btnSaveLib" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Save Library</button>
                    <button id="btnLoadLib" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Load Library</button>
                </div>
                <div class="right button-group flex items-center flex-wrap gap-3 ml-auto">
                    <select id="clientSort" class="bg-gray-800 text-white border border-gray-700 rounded-xl px-4 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="subs-desc">Sort: Subs ↓</option>
                        <option value="subs-asc">Sort: Subs ↑</option>
                        <option value="views-desc">Sort: Views ↓</option>
                        <option value="views-asc">Sort: Views ↑</option>
                        <option value="title-asc">Sort: Title A→Z</option>
                        <option value="title-desc">Sort: Title Z→A</option>
                    </select>
                    <button id="btnExportCSV" class="btn btn-primary py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">Export CSV</button>
                    <button id="btnExportJSON" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Export JSON</button>
                    <button id="btnCopyIDs" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Copy Channel IDs</button>
                    <button id="btnClearResults" class="btn btn-danger py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition-colors">Clear</button>
                </div>
            </div>
            <div class="table-wrap flex-1 overflow-auto rounded-xl border border-gray-700">
                <table aria-label="Channel results" class="w-full border-collapse">
                    <thead class="sticky top-0 bg-gray-900/70 backdrop-blur-md z-10">
                        <tr>
                            <th class="text-left text-gray-400 text-sm font-semibold p-4 w-12"></th>
                            <th class="text-left text-gray-400 text-sm font-semibold p-4">Channel</th>
                            <th class="text-left text-gray-400 text-sm font-semibold p-4">Subs</th>
                            <th class="text-left text-gray-400 text-sm font-semibold p-4">Videos</th>
                            <th class="text-left text-gray-400 text-sm font-semibold p-4">Views</th>
                            <th class="text-left text-gray-400 text-sm font-semibold p-4">Verified</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTbody"></tbody>
                </table>
            </div>
            <div class="text-right mt-3 text-sm text-gray-500">Tip: Click a row to open full details in the panel on the right.</div>
        </div>

        <div class="panel details-panel flex flex-col p-6 bg-gray-800/50 backdrop-blur-lg border border-gray-700/50 rounded-2xl shadow-2xl overflow-hidden">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <div class="text-sm text-gray-400 font-semibold">Channel Details</div>
                    <h3 id="detailTitle" class="text-2xl font-bold text-white mt-1">Select a channel</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btnExportSelected" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Export Selected</button>
                    <button id="btnCopySelected" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Copy Selected CSV</button>
                </div>
            </div>
            <div id="banner" class="w-full h-32 rounded-lg bg-gray-700 mb-4 bg-cover bg-center" style="display:none"></div>
            <div id="detailContent" class="about text-gray-300 text-sm flex-1 overflow-y-auto pr-2">
                <p class="text-gray-400">No channel selected.</p>
            </div>
            <div class="mt-auto pt-4 border-t border-gray-700 flex items-center justify-between">
                <div class="user-info flex items-center gap-2">
                    <div id="userEmail" class="text-sm text-gray-400"></div>
                </div>
                <button id="btnSignOut" class="btn btn-secondary py-2 px-4 bg-gray-800 hover:bg-gray-700 text-gray-200 font-semibold rounded-xl transition-colors">Sign Out</button>
            </div>
        </div>
    </div>
</div>

<div id="messageBoxOverlay" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[1000]" style="display:none">
    <div id="messageBox" class="bg-gray-900 p-8 rounded-2xl shadow-2xl max-w-sm text-center flex flex-col gap-4">
        <h4 id="messageTitle" class="text-xl font-bold text-white"></h4>
        <p id="messageText" class="text-gray-300"></p>
        <button id="messageBoxOk" class="btn btn-primary w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">OK</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";

    /* =========================
       STATE + HELPERS
       ========================= */
    const $ = id => document.getElementById(id);
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const esc = s => String(s ?? '').replace(/"/g,'""');
    
    const savedLibraryKey = 'lead_studio_pro_lib_v1';
    let currentUser = null;
    let selectedChannel = null;
    
    function setStatus(t){ $('status').innerText = t; }
    function setProgress(p){ $('progressBar').style.width = Math.min(100, Math.round(p*100)) + '%'; }
    
    let LIB = []; // enriched channels
    let VIEW = []; // filtered/sorted view
    let lastExport = [];
    let lastSearch = {};
    
    const PUBLIC_LIBRARIES_COLLECTION = 'publicLibraries';

    // Custom message box to replace alert()
    function showMessage(title, message, okCallback) {
      $('messageTitle').innerText = title;
      $('messageText').innerText = message;
      const messageBox = $('messageBox');
      const oldOkBtn = $('messageBoxOk');
    
      // Remove any existing dynamic buttons
      const dynamicButtons = messageBox.querySelectorAll('.btn:not(#messageBoxOk)');
      dynamicButtons.forEach(btn => btn.remove());
    
      oldOkBtn.style.display = 'block';
    
      // Add a single event listener that can be removed
      const okHandler = () => {
        $('messageBoxOverlay').style.display = 'none';
        oldOkBtn.removeEventListener('click', okHandler);
        if (okCallback) okCallback();
      };
      oldOkBtn.addEventListener('click', okHandler);
    
      $('messageBoxOverlay').style.display = 'flex';
    }

    // Function to show a confirmation box with a custom button
    function showConfirm(title, message, okText, okCallback, cancelText, cancelCallback) {
        $('messageTitle').innerText = title;
        $('messageText').innerText = message;
        const messageBox = $('messageBox');
        const oldOkBtn = $('messageBoxOk');

        oldOkBtn.style.display = 'none';

        // Remove old buttons
        const dynamicButtons = messageBox.querySelectorAll('.btn');
        dynamicButtons.forEach(btn => btn.remove());

        const confirmButton = document.createElement('button');
        confirmButton.className = 'btn btn-primary w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors';
        confirmButton.innerText = okText;
        confirmButton.addEventListener('click', () => {
            $('messageBoxOverlay').style.display = 'none';
            if (okCallback) okCallback();
        });

        const cancelButton = document.createElement('button');
        cancelButton.className = 'btn btn-secondary w-full py-3 bg-gray-800 hover:bg-gray-700 text-gray-200 font-bold rounded-xl transition-colors';
        cancelButton.innerText = cancelText;
        cancelButton.addEventListener('click', () => {
            $('messageBoxOverlay').style.display = 'none';
            if (cancelCallback) cancelCallback();
        });

        messageBox.appendChild(confirmButton);
        messageBox.appendChild(cancelButton);

        $('messageBoxOverlay').style.display = 'flex';
    }
    
    // === FIREBASE CONFIGURATION ===
    const firebaseConfig = {
      apiKey: "AIzaSyBvU3_Njbi1JQr_wD1a16h5coTW2ifaRDU",
      authDomain: "youleadmax.firebaseapp.com",
      projectId: "youleadmax",
      storageBucket: "youleadmax.firebasestorage.app",
      messagingSenderId: "710806971072",
      appId: "1:710806971072:web:ced903befe8693f886c325",
      measurementId: "G-JW9W20C1LQ"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);
    const logSearchCallable = httpsCallable(functions, 'logSearch');
    
    /* ========================= AUTHENTICATION ========================= */
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            $('app-view').style.display = 'grid';
            $('auth-view').style.display = 'none';
            $('userEmail').innerText = `Logged in as: ${user.email}`;
            // Log user usage for tracking purposes
            const userRef = doc(db, 'users', user.uid);
            await setDoc(userRef, { lastLogin: new Date().toISOString() }, { merge: true });
        } else {
            currentUser = null;
            $('app-view').style.display = 'none';
            $('auth-view').style.display = 'flex';
        }
    });

    $('btnSignIn').addEventListener('click', async () => {
        const email = $('authEmail').value;
        const pass = $('authPass').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            $('authStatus').innerText = 'Sign-in failed: ' + error.message;
        }
    });

    $('btnSignUp').addEventListener('click', async () => {
        const email = $('authEmail').value;
        const pass = $('authPass').value;
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            $('authStatus').innerText = 'Sign-up failed: ' + error.message;
        }
    });

    $('btnSignOut').addEventListener('click', async () => {
        await signOut(auth);
        resetResults();
    });

    /* ========================= SEARCH / FETCH ========================= */
    $('btnSearch').addEventListener('click', () => searchAll(false));
    $('btnDeepSearch').addEventListener('click', () => {
        const queryRaw = $('query').value.trim();
        if (!queryRaw.length) {
            showMessage('Search Error', 'Please enter at least one query');
            return;
        }
        if (!currentUser) {
            showMessage('Authentication Required', 'Please sign in first.');
            return;
        }
        showConfirm('Deep Search Confirmation', 'Deep Search will consume more API credits by searching more pages. Do you want to continue?', 'Yes, Continue', () => searchAll(true), 'Cancel', () => {});
    });

    $('btnClear').addEventListener('click', resetResults);
    $('btnClearResults').addEventListener('click', resetResults);

    async function searchAll(isDeepSearch) {
      if (!currentUser) {
          showMessage('Authentication Required', 'Please sign in first.');
          return;
      }
      const apiKey = $('apiKey').value.trim();
      const queryRaw = $('query').value.trim();
      const perPage = $('perPage').value;
      const pages = isDeepSearch ? 10 : $('pages').value;

      if (!apiKey || !queryRaw) {
          showMessage('Input Error', 'Please provide a valid API key and search query.');
          return;
      }

      resetResults();
      setStatus('Searching...');
      
      const queries = queryRaw.split(/[\n,]/).map(q => q.trim()).filter(q => q.length > 0);
      let channelsFound = 0;
      
      try {
          await logSearchCallable({ query: queries.join(', ') });
      } catch (e) {
          console.error('Failed to log search:', e);
      }

      for (let i = 0; i < queries.length; i++) {
        const query = queries[i];
        try {
          setStatus(`Searching for "${query}" (${i+1}/${queries.length})`);
          await fetchChannels(apiKey, query, perPage, pages);
          channelsFound += (LIB.length - channelsFound);
        } catch (error) {
          console.error(`Error searching for "${query}":`, error);
          showMessage('Search Failed', `Failed to get results for "${query}". Check your API key and query. Details: ${error.message}`);
          setStatus('Error');
          return;
        }
      }

      setStatus('Enriching channels...');
      await enrichChannels();
      updateMetrics();
      setStatus('Idle');
    }

    async function fetchChannels(apiKey, query, perPage, pages) {
        let nextPageToken = null;
        for (let i = 0; i < pages; i++) {
            setProgress(((i + 1) / pages) * 0.5);
            const url = new URL('https://www.googleapis.com/youtube/v3/search');
            url.searchParams.append('key', apiKey);
            url.searchParams.append('q', query);
            url.searchParams.append('type', 'channel');
            url.searchParams.append('part', 'snippet');
            url.searchParams.append('maxResults', perPage);
            
            // Filters
            url.searchParams.append('order', $('order').value);
            if ($('duration').value) url.searchParams.append('videoDuration', $('duration').value);
            if ($('upload').value) url.searchParams.append('publishedAfter', getPublishedAfterDate($('upload').value));
            if ($('region').value) url.searchParams.append('regionCode', $('region').value);
            if ($('definition').value) url.searchParams.append('videoDefinition', $('definition').value);
            if ($('safe').value) url.searchParams.append('safeSearch', $('safe').value);
            
            if (nextPageToken) url.searchParams.append('pageToken', nextPageToken);
            
            const res = await fetch(url);
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error.message);
            }
            const data = await res.json();
            
            if (data.items) {
                const channelIds = data.items.map(item => item.snippet.channelId).filter(id => id);
                if (channelIds.length > 0) {
                    const channels = await getChannelStats(apiKey, channelIds);
                    LIB = [...LIB, ...channels];
                    renderResults(LIB);
                }
            }
            nextPageToken = data.nextPageToken;
            if (!nextPageToken) break;
            await sleep(500);
        }
    }

    async function getChannelStats(apiKey, channelIds) {
      const url = new URL('https://www.googleapis.com/youtube/v3/channels');
      url.searchParams.append('key', apiKey);
      url.searchParams.append('part', 'snippet,statistics,brandingSettings');
      url.searchParams.append('id', channelIds.join(','));
      
      const res = await fetch(url);
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error.message);
      }
      const data = await res.json();
      return data.items.map(item => {
          const stats = item.statistics;
          const snippet = item.snippet;
          const branding = item.brandingSettings;
          return {
              id: item.id,
              title: snippet.title,
              description: snippet.description,
              subs: stats.subscriberCount,
              videos: stats.videoCount,
              views: stats.viewCount,
              country: snippet.country,
              customUrl: snippet.customUrl,
              publishedAt: snippet.publishedAt,
              thumbnail: snippet.thumbnails.high.url,
              banner: branding?.image?.bannerExternalUrl,
              verified: snippet.isVerified || false,
              socialLinks: {}, // Placeholder
              aboutPageInfo: null // Placeholder
          };
      });
    }

    async function enrichChannels() {
        if (!$('doVerify').checked) {
            setProgress(1); // Finish progress bar
            return;
        }

        const toEnrich = LIB.filter(c => !c.socialLinks?.twitter && !c.socialLinks?.website);
        let completed = 0;
        
        for (const channel of toEnrich) {
            setProgress(0.5 + (completed / LIB.length) * 0.5);
            try {
                const socialLinks = await getSocialLinksFromAboutPage(channel.id);
                Object.assign(channel.socialLinks, socialLinks);
            } catch (error) {
                console.error(`Failed to enrich channel ${channel.id}:`, error);
            }
            completed++;
            await sleep(50);
        }
        
        setProgress(1); // Finish progress bar
        renderResults(LIB);
    }
    
    // Attempt to get social links by scraping the channel's About page
    async function getSocialLinksFromAboutPage(channelId) {
        const proxyUrl = $('corsProxy').value || '';
        const aboutUrl = `https://www.youtube.com/channel/${channelId}/about`;

        try {
            const response = await fetch(`${proxyUrl}${aboutUrl}`);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const socialLinks = {};
            const linkElements = doc.querySelectorAll('a[href*="external_link_click"]');
            
            linkElements.forEach(link => {
                const url = new URL(decodeURIComponent(link.href.split('url=')[1].split('&')[0]));
                if (url.hostname.includes('twitter.com')) socialLinks.twitter = url.href;
                else if (url.hostname.includes('instagram.com')) socialLinks.instagram = url.href;
                else if (url.hostname.includes('facebook.com')) socialLinks.facebook = url.href;
                else if (url.hostname.includes('tiktok.com')) socialLinks.tiktok = url.href;
                else if (url.hostname.includes('linkedin.com')) socialLinks.linkedin = url.href;
                else if (!socialLinks.website) socialLinks.website = url.href;
            });
            
            return socialLinks;
        } catch (error) {
            console.error('Failed to retrieve social links:', error);
            return {};
        }
    }

    function getPublishedAfterDate(period) {
        const d = new Date();
        switch (period) {
            case 'hour': d.setHours(d.getHours() - 1); break;
            case 'today': d.setHours(0, 0, 0, 0); break;
            case 'week': d.setDate(d.getDate() - 7); break;
            case 'month': d.setMonth(d.getMonth() - 1); break;
        }
        return d.toISOString();
    }
    
    /* ========================= VIEW & RENDERING ========================= */
    function renderResults(channels) {
        const filterText = ($('searchInResults').value || '').toLowerCase();
        VIEW = channels.filter(c => 
            !filterText || 
            c.title.toLowerCase().includes(filterText) ||
            c.id.toLowerCase().includes(filterText)
        );
    
        const sortKey = $('clientSort').value;
        VIEW.sort((a, b) => {
            let valA, valB;
            switch (sortKey) {
                case 'subs-desc': valA = parseInt(a.subs); valB = parseInt(b.subs); return valB - valA;
                case 'subs-asc': valA = parseInt(a.subs); valB = parseInt(b.subs); return valA - valB;
                case 'views-desc': valA = parseInt(a.views); valB = parseInt(b.views); return valB - valA;
                case 'views-asc': valA = parseInt(a.views); valB = parseInt(b.views); return valA - valB;
                case 'title-asc': return a.title.localeCompare(b.title);
                case 'title-desc': return b.title.localeCompare(a.title);
            }
        });
    
        const tbody = $('resultsTbody');
        tbody.innerHTML = '';
        if (VIEW.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No channels found.</td></tr>';
            return;
        }
    
        VIEW.forEach(channel => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-700/50 transition-colors cursor-pointer fade-in';
            row.addEventListener('click', () => renderDetails(channel));
    
            row.innerHTML = `
                <td class="p-3 border-b border-gray-700"><img src="${channel.thumbnail}" alt="${channel.title}" class="w-10 h-10 rounded-lg object-cover"></td>
                <td class="p-3 border-b border-gray-700 text-sm font-medium text-white">${channel.title}</td>
                <td class="p-3 border-b border-gray-700 text-sm text-gray-300">${formatNumber(channel.subs)}</td>
                <td class="p-3 border-b border-gray-700 text-sm text-gray-300">${formatNumber(channel.videos)}</td>
                <td class="p-3 border-b border-gray-700 text-sm text-gray-300">${formatNumber(channel.views)}</td>
                <td class="p-3 border-b border-gray-700 text-sm text-gray-300">${channel.verified ? '✅' : '❌'}</td>
            `;
            tbody.appendChild(row);
        });
        updateMetrics();
    }
    
    function renderDetails(channel) {
        selectedChannel = channel;
        $('detailTitle').innerText = channel.title;
        
        const bannerEl = $('banner');
        if (channel.banner) {
            bannerEl.style.display = 'block';
            bannerEl.style.backgroundImage = `url(${channel.banner})`;
        } else {
            bannerEl.style.display = 'none';
        }
    
        const detailContentEl = $('detailContent');
        detailContentEl.innerHTML = `
            <div class="flex flex-col gap-4">
                <div class="grid grid-cols-3 gap-3">
                    <div class="stat p-4 bg-gray-700/50 rounded-xl text-center">
                        <div class="text-sm text-gray-400">Subscribers</div>
                        <b class="text-xl text-white mt-1 block">${formatNumber(channel.subs)}</b>
                    </div>
                    <div class="stat p-4 bg-gray-700/50 rounded-xl text-center">
                        <div class="text-sm text-gray-400">Videos</div>
                        <b class="text-xl text-white mt-1 block">${formatNumber(channel.videos)}</b>
                    </div>
                    <div class="stat p-4 bg-gray-700/50 rounded-xl text-center">
                        <div class="text-sm text-gray-400">Views</div>
                        <b class="text-xl text-white mt-1 block">${formatNumber(channel.views)}</b>
                    </div>
                </div>
                <div class="text-gray-300 leading-relaxed">
                    <p class="text-gray-500 mb-2">Description</p>
                    ${channel.description.replace(/\n/g, '<br>')}
                </div>
                <div>
                    <p class="text-gray-500 mb-2">Social Links</p>
                    <div class="flex flex-wrap gap-2 text-sm">
                        ${Object.keys(channel.socialLinks).length > 0
                            ? Object.entries(channel.socialLinks).map(([key, url]) =>
                                `<a href="${url}" target="_blank" class="px-3 py-1 bg-purple-600/20 text-purple-300 rounded-full hover:bg-purple-600/30 transition-colors">${key.charAt(0).toUpperCase() + key.slice(1)}</a>`
                              ).join('')
                            : `<span class="text-gray-500">No social links found.</span>`
                        }
                    </div>
                </div>
                <div class="text-sm text-gray-500">
                    <p><b>Channel ID:</b> ${channel.id}</p>
                    <p><b>Published:</b> ${new Date(channel.publishedAt).toLocaleDateString()}</p>
                    ${channel.country ? `<p><b>Country:</b> ${channel.country}</p>` : ''}
                    ${channel.customUrl ? `<p><b>Custom URL:</b> <a href="https://youtube.com/${channel.customUrl}" target="_blank" class="text-purple-400 hover:underline">${channel.customUrl}</a></p>` : ''}
                </div>
            </div>
        `;
    }

    function resetResults() {
        LIB = [];
        VIEW = [];
        selectedChannel = null;
        $('resultsTbody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No channels found.</td></tr>';
        $('count').innerText = '0 channels';
        $('progressBar').style.width = '0%';
        $('detailTitle').innerText = 'Select a channel';
        $('detailContent').innerHTML = '<div class="text-gray-400">No channel selected.</div>';
        $('banner').style.display = 'none';
        setStatus('Idle');
    }

    function updateMetrics() {
        $('count').innerText = `${VIEW.length} channels`;
    }

    $('searchInResults').addEventListener('input', () => renderResults(LIB));
    $('clientSort').addEventListener('change', () => renderResults(LIB));
    
    /* ========================= EXPORT & UTILS ========================= */
    function formatNumber(num) {
      if (num === undefined || num === null) return 'N/A';
      if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
      return num;
    }

    function generateCSV(data, filename) {
        const header = ["Channel ID", "Title", "Subscribers", "Videos", "Views", "Country", "Custom URL", "Published Date", "Twitter", "Instagram", "Facebook", "TikTok", "LinkedIn", "Website"];
        const rows = data.map(c => {
            return [
                esc(c.id), esc(c.title), esc(c.subs), esc(c.videos), esc(c.views), esc(c.country), esc(c.customUrl), esc(c.publishedAt),
                esc(c.socialLinks.twitter), esc(c.socialLinks.instagram), esc(c.socialLinks.facebook), esc(c.socialLinks.tiktok), esc(c.socialLinks.linkedin), esc(c.socialLinks.website)
            ].join(',');
        }).join('\n');
        const csvContent = "data:text/csv;charset=utf-8," + encodeURIComponent(header.join(',') + '\n' + rows);
        const link = document.createElement('a');
        link.setAttribute('href', csvContent);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showMessage('Export Complete', `Successfully exported ${data.length} channels to CSV.`);
    }

    $('btnExportCSV').addEventListener('click', () => {
        if (VIEW.length > 0) {
            lastExport = VIEW;
            generateCSV(VIEW, 'channels.csv');
        } else {
            showMessage('Export Failed', 'No results to export.');
        }
    });

    $('btnExportJSON').addEventListener('click', () => {
        if (VIEW.length > 0) {
            const jsonContent = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(VIEW, null, 2));
            const link = document.createElement('a');
            link.setAttribute('href', jsonContent);
            link.setAttribute('download', 'channels.json');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('Export Complete', `Successfully exported ${VIEW.length} channels to JSON.`);
        } else {
            showMessage('Export Failed', 'No results to export.');
        }
    });

    $('btnCopyIDs').addEventListener('click', () => {
        if (VIEW.length > 0) {
            const ids = VIEW.map(c => c.id).join('\n');
            navigator.clipboard.writeText(ids).then(() => {
                showMessage('Copy Complete', `Successfully copied ${VIEW.length} channel IDs to clipboard.`);
            }).catch(err => {
                showMessage('Copy Failed', 'Failed to copy IDs to clipboard. ' + err);
            });
        } else {
            showMessage('Copy Failed', 'No results to copy.');
        }
    });

    $('btnExportSelected').addEventListener('click', () => {
        if (selectedChannel) {
            generateCSV([selectedChannel], `channel-${selectedChannel.id}.csv`);
        } else {
            showMessage('Export Failed', 'Please select a channel first.');
        }
    });

    $('btnCopySelected').addEventListener('click', () => {
        if (selectedChannel) {
            const header = ["Channel ID", "Title", "Subscribers", "Videos", "Views", "Country", "Custom URL", "Published Date", "Twitter", "Instagram", "Facebook", "TikTok", "LinkedIn", "Website"];
            const row = [
                esc(selectedChannel.id), esc(selectedChannel.title), esc(selectedChannel.subs), esc(selectedChannel.videos), esc(selectedChannel.views), esc(selectedChannel.country), esc(selectedChannel.customUrl), esc(selectedChannel.publishedAt),
                esc(selectedChannel.socialLinks.twitter), esc(selectedChannel.socialLinks.instagram), esc(selectedChannel.socialLinks.facebook), esc(selectedChannel.socialLinks.tiktok), esc(selectedChannel.socialLinks.linkedin), esc(selectedChannel.socialLinks.website)
            ].join(',');
            const csvData = header.join(',') + '\n' + row;
            navigator.clipboard.writeText(csvData).then(() => {
                showMessage('Copy Complete', `Successfully copied selected channel's CSV data to clipboard.`);
            }).catch(err => {
                showMessage('Copy Failed', 'Failed to copy data to clipboard. ' + err);
            });
        } else {
            showMessage('Copy Failed', 'Please select a channel first.');
        }
    });

    $('btnSelectAll').addEventListener('click', () => {
        // No-op for this UI, as selection is handled differently
        showMessage('Action Info', 'This feature is for visual selection. All channels in the table are included in exports.');
    });

    $('btnDeselectAll').addEventListener('click', () => {
        // No-op for this UI
        showMessage('Action Info', 'This feature is for visual selection.');
    });

    $('btnSaveLib').addEventListener('click', async () => {
        if (!currentUser) {
            return showMessage('Save Failed', 'Please sign in to save your library.');
        }
        if (LIB.length === 0) {
            return showMessage('Save Failed', 'No channels to save.');
        }
        try {
            const userDocRef = doc(db, PUBLIC_LIBRARIES_COLLECTION, currentUser.uid);
            await setDoc(userDocRef, {
                library: LIB,
                timestamp: new Date().toISOString()
            }, { merge: true });
            showMessage('Save Success', `Saved ${LIB.length} channels to your library.`);
        } catch (e) {
            console.error(e);
            showMessage('Save Failed', 'Failed to save library to Firestore. Check console for details.');
        }
    });

    $('btnLoadLib').addEventListener('click', async () => {
        if (!currentUser) {
            return showMessage('Load Failed', 'Please sign in to load your library.');
        }
        try {
            const userDocRef = doc(db, PUBLIC_LIBRARIES_COLLECTION, currentUser.uid);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists() && docSnap.data().library) {
                LIB = docSnap.data().library;
                renderResults(LIB);
                updateMetrics();
                showMessage('Load Success', `Loaded ${LIB.length} channels from your library.`);
            } else {
                showMessage('Load Failed', 'No saved library found.');
            }
        } catch (e) {
            console.error(e);
            showMessage('Load Failed', 'Failed to load library from Firestore. Data may be corrupted or permission denied.');
        }
    });
</script>
</body>
</html>
