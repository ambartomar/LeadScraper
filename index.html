<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lead Studio Pro — YouTube Channel Finder</title>
<style>
  /* =========================
     THEME — Apple-ish + Purple (base file)
     (kept your original CSS and added tiny improvements)
     ========================= */
  :root{
    --bg-0:#07080c; --bg-1:#0b0d14; --bg-2:#0f1320;
    --glass: rgba(255,255,255,.06); --glass-2: rgba(255,255,255,.08);
    --muted:#a6b0c3; --text:#f5f7ff;
    --accent:#7c3aed; --accent-2:#a78bfa;
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --radius:14px; --radius-sm:10px;
    --shadow: 0 30px 70px rgba(0,0,0,.45);
  }
  * { box-sizing:border-box; }
  html,body { height:100%; }
  body {
    margin:0;
    font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Roboto, Inter, Arial;
    color: var(--text);
    background:
      radial-gradient(1200px 800px at 10% -20%, #24103e 0%, transparent 60%),
      radial-gradient(1200px 800px at 110% 120%, #1f1440 0%, transparent 60%),
      linear-gradient(180deg, #080910, #0a0c14 60%, #090b12);
    overflow:hidden; overscroll-behavior:none;
  }
  a { color: var(--accent-2); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* App shell */
  .app { max-width: 1350px; margin: 0 auto; padding: 18px; display: grid; gap: 14px; grid-template-rows: auto 1fr; height: 100vh; }

  /* Topbar */
  .topbar {
    display:flex; gap:12px; align-items:center; padding: 14px;
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    border: 1px solid rgba(255,255,255,.06); border-radius: var(--radius); backdrop-filter: blur(10px); box-shadow: var(--shadow);
  }
  .brand { display:flex; gap:2px; flex-direction:column; min-width: 230px; }
  .brand h1 { margin:0; font-size:18px; letter-spacing:.2px; color:#e9e8ff; }
  .brand p { margin:0; color: var(--muted); font-size:12px; }

  .bar-controls { display:flex; gap:8px; align-items:center; flex:1; }
  input[type="text"], input[type="number"], input[type="url"], select, textarea {
    background: var(--glass); border: 1px solid rgba(255,255,255,.07); color: var(--text);
    padding: 10px 12px; border-radius: var(--radius-sm); outline: none; transition: box-shadow .18s ease, transform .12s ease, border-color .18s ease;
  }
  textarea { min-height: 44px; resize: vertical; }
  input::placeholder, textarea::placeholder { color: #8f9ab2; }

  input:focus, select:focus, textarea:focus { box-shadow: 0 10px 26px rgba(124,58,237,.18); border-color: rgba(124,58,237,.35); transform: translateY(-1px); }

  .btn { padding: 10px 14px; border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,.08); background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05)); color: var(--text); font-weight: 700; cursor: pointer; transition: transform .12s ease, box-shadow .2s ease, background .2s ease; }
  .btn:hover { transform: translateY(-1px); }
  .btn-primary { background: linear-gradient(90deg, var(--accent), var(--accent-2)); border-color: transparent; color:#0b0d14; box-shadow: 0 12px 28px rgba(124,58,237,.25); }
  .btn-danger { background: linear-gradient(90deg, #d83a56, #ef4444); border-color: transparent; }

  .button-group { display:flex; gap:8px; }
  .button-group .btn { flex: 1; text-align:center; }

  /* Main layout */
  .main { display: grid; gap: 14px; grid-template-columns: 350px 1fr 420px; grid-template-rows: 1fr; min-height: 0; }

  .panel { background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03)); border: 1px solid rgba(255,255,255,.06); border-radius: var(--radius); backdrop-filter: blur(10px); box-shadow: var(--shadow); padding: 14px; min-height: 0; overflow: hidden; }

  /* Filters panel */
  .filters { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  .filters .full { grid-column: 1/-1; }
  .filters small { color: var(--muted); }
  .switch { display:flex; gap:8px; align-items:center; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }

  /* Results */
  .results-wrap { height: 100%; display:grid; grid-template-rows: auto auto 1fr auto; gap: 10px; min-height:0; }
  .results-toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; }
  .results-toolbar .left { display:flex; gap:8px; align-items:center; }
  .results-toolbar .right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  .progress { width:180px; height:9px; border-radius: 999px; background: rgba(255,255,255,.07); overflow:hidden; }
  .progress > i { display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .25s ease; }

  .table-wrap { overflow:auto; border-radius: calc(var(--radius) - 6px); border: 1px solid rgba(255,255,255,.06); }
  table { width:100%; border-collapse: collapse; background: transparent; }
  thead th { position: sticky; top: 0; backdrop-filter: blur(10px); background: rgba(16,18,30,.6); color: var(--muted); font-weight: 600; font-size: 13px; text-align: left; padding: 12px; border-bottom: 1px solid rgba(255,255,255,.08); }
  tbody td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,.06); vertical-align: middle; font-size: 14px; }
  tbody tr { transition: background .18s ease, transform .14s ease; }
  tbody tr:hover { background: rgba(124,58,237,.12); transform: translateY(-1px); cursor: pointer; }
  .avatar { width:42px; height:42px; border-radius: 12px; object-fit: cover; margin-right:10px; }

  /* Details */
  .details { height: 100%; display:grid; grid-template-rows: auto auto 1fr; gap:10px; min-height:0; }
  .banner { height: 120px; border-radius: 12px; background-size: cover; background-position: center; border:1px solid rgba(255,255,255,.06); }
  .about { overflow:auto; }
  .meta { color: var(--muted); font-size: 13px; }
  .stats { display:grid; grid-template-columns: repeat(3,1fr); gap:10px; }
  .stat { text-align:center; padding:10px; border-radius:12px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); }
  .stat b { display:block; font-size: 16px; color: #eef; }

  .videos-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .video-card { background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px; }
  .video-card img { width:100%; height:110px; object-fit:cover; border-radius:10px; }
  .video-card h4 { font-size: 13px; margin:8px 0 4px; }

  /* selects & scrollbar improvements */
  select { appearance: none; background-image: linear-gradient(45deg, transparent 50%, #cfd6ea 50%), linear-gradient(135deg, #cfd6ea 50%, transparent 50%), linear-gradient(to right, transparent, transparent); background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px), calc(100% - 2.5em) 0.5em; background-size: 6px 6px, 6px 6px, 1px 1.8em; background-repeat: no-repeat; }
  ::-webkit-scrollbar { width: 10px; height:10px; }
  ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent), var(--accent-2)); border-radius: 999px; border: 3px solid rgba(0,0,0,.25); }
  ::-webkit-scrollbar-track { background: transparent; }

  /* Responsive */
  @media (max-width: 1200px){ .main { grid-template-columns: 1fr; grid-template-rows: 420px 1fr 520px; } .details { grid-template-rows: auto 1fr 1fr; } }

  /* extras: message box & UI niceties */
  .message-box-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:10000; }
  .message-box { background: var(--bg-1); padding:20px; border-radius:12px; min-width:320px; max-width:560px; box-shadow: var(--shadow); color:var(--text); }
  .message-box .row { justify-content:center; margin-top:12px; }
  .chip { display:inline-block; padding:8px 10px; border-radius:999px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.04); color:var(--text); cursor:pointer; margin-right:6px; font-size:13px; }
</style>
</head>
<body>
    <!-- AUTH VIEW (kept) -->
    <div id="auth-view" class="auth-form" style="display:block">
        <h2>Welcome to Lead Studio Pro</h2>
        <input id="authEmail" type="email" placeholder="Email" autocomplete="username">
        <input id="authPass" type="password" placeholder="Password" autocomplete="current-password">
        <button class="btn btn-primary" id="btnSignIn">Sign In</button>
        <button class="btn" id="btnSignUp">Sign Up</button>
        <div id="authStatus" class="meta" style="text-align: center;"></div>
    </div>

    <!-- APP VIEW (kept, display toggled by auth) -->
    <div id="app-view" class="app" style="display:none">
        <div class="topbar">
            <div class="brand">
                <h1>Lead Studio Pro</h1>
                <p>Apple-grade UI • Advanced YouTube lead extractor</p>
            </div>

            <div class="bar-controls">
                <input id="apiKey" type="text" placeholder="YouTube API Key" value="AIzaSyBo5wWMC5T5lemycWNqtfs2_SAjApsLuFA"/>
                <textarea id="query" placeholder="Enter one or more queries (comma or newline separated)"></textarea>

                <div class="button-group" style="margin-left:auto;">
                  <button class="btn btn-primary" id="btnSearch">Search</button>
                  <button class="btn btn-primary" id="btnDeepSearch" style="background: linear-gradient(90deg, #d946ef, #a855f7);">Deep Search</button>
                  <button class="btn" id="btnClear">Clear</button>
                </div>
            </div>
        </div>

        <div class="main">
            <!-- FILTERS -->
            <div class="panel">
                <div class="row" style="justify-content:space-between;margin-bottom:8px">
                    <div class="meta">Advanced Filters</div>
                    <div class="meta" id="status">Idle</div>
                </div>
                <div class="filters">
                    <select id="order"><option value="relevance">Order: Relevance</option><option value="date">Order: Date</option><option value="viewCount">Order: Views</option><option value="rating">Order: Rating</option></select>
                    <select id="duration"><option value="">Duration: Any</option><option value="short">Short (&lt;4m)</option><option value="medium">Medium (4–20m)</option><option value="long">Long (&gt;20m)</option></select>
                    <select id="upload"><option value="">Upload Time: Any</option><option value="hour">Last hour</option><option value="today">Today</option><option value="week">This week</option><option value="month">This month</option></select>
                    <select id="region"><option value="">Region: Any</option><option>US</option><option>IN</option><option>GB</option><option>CA</option><option>AU</option><option>DE</option></select>
                    <select id="definition"><option value="">Definition: Any</option><option value="high">HD</option><option value="standard">SD</option></select>
                    <select id="safe"><option value="">Safe: Any</option><option value="none">None</option><option value="moderate">Moderate</option><option value="strict">Strict</option></select>

                    <input id="perPage" class="full" type="number" min="1" max="50" value="25" placeholder="Results per page (1–50)"/>
                    <input id="pages" class="full" type="number" min="1" max="10" value="2" placeholder="Pages per query (1–10)"/>

                    <div class="full row">
                        <input id="minSubs" type="number" placeholder="Min subs"/>
                        <input id="maxSubs" type="number" placeholder="Max subs"/>
                        <input id="searchInResults" type="text" placeholder="Search within results (title / ID)"/>
                    </div>

                    <div class="full row">
                        <input id="corsProxy" type="url" placeholder="Optional CORS proxy for verification (best-effort)"/>
                        <label class="switch" title="Filter out Shorts (when on)"><input id="filterShorts" type="checkbox" checked/><span class="switch-visual"></span><small>Filter out Shorts</small></label>
                    </div>

                    <div class="full row">
                        <label class="switch" title="Attempt to verify channel badges"><input id="doVerify" type="checkbox"/><span class="switch-visual"></span><small>Attempt verify check</small></label>
                        <div style="flex:1"></div>
                    </div>

                    <div class="full row" style="justify-content:space-between;margin-top:2px">
                        <div class="progress"><i id="progressBar"></i></div>
                        <small id="count">0 channels</small>
                    </div>
                </div>
            </div>

            <!-- RESULTS -->
            <div class="panel results-wrap">
                <div class="results-toolbar">
                    <div class="left button-group">
                        <button class="btn" id="btnSelectAll">Select All</button>
                        <button class="btn" id="btnDeselectAll">Deselect</button>
                        <button class="btn" id="btnOpenSelected">Open Selected</button>
                        <button class="btn" id="btnSaveLib">Save Library</button>
                        <button class="btn" id="btnLoadLib">Load Library</button>
                    </div>
                    <div class="right button-group">
                        <select id="clientSort">
                            <option value="subs-desc">Sort: Subs ↓</option>
                            <option value="subs-asc">Sort: Subs ↑</option>
                            <option value="views-desc">Sort: Views ↓</option>
                            <option value="views-asc">Sort: Views ↑</option>
                            <option value="title-asc">Sort: Title A→Z</option>
                            <option value="title-desc">Sort: Title Z→A</option>
                        </select>
                        <button class="btn btn-primary" id="btnExportCSV">Export CSV</button>
                        <button class="btn" id="btnExportJSON">Export JSON</button>
                        <button class="btn" id="btnCopyIDs">Copy Channel IDs</button>
                        <button class="btn btn-danger" id="btnClearResults">Clear</button>
                    </div>
                </div>

                <div class="table-wrap" id="resultsScroller">
                    <table aria-label="Channel results">
                        <thead>
                            <tr>
                                <th style="width:42px"></th>
                                <th>Channel</th>
                                <th>Subs</th>
                                <th>Videos</th>
                                <th>Views</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTbody"></tbody>
                    </table>
                </div>

                <div class="row" style="justify-content:flex-end">
                    <small class="meta">Tip: Click a row to open full details in the panel on the right.</small>
                </div>
            </div>

            <!-- DETAILS -->
            <div class="panel details">
                <div>
                    <div class="row" style="justify-content:space-between">
                        <div>
                            <div class="meta">Channel Details</div>
                            <h3 id="detailTitle" style="margin:6px 0 0">Select a channel</h3>
                        </div>
                        <div class="row button-group">
                            <button class="btn" id="btnExportSelected">Export Selected</button>
                            <button class="btn" id="btnCopySelected">Copy Selected CSV</button>
                        </div>
                    </div>
                </div>

                <div id="banner" class="banner" style="display:none"></div>

                <div class="about" id="detailContent">
                    <div class="meta">No channel selected.</div>
                </div>

                <!-- preview area (new) -->
                <div id="videoPreviewContainer" style="display:none;margin-top:8px"></div>

                <div class="meta">
                    <div class="row" style="justify-content:space-between;align-items:flex-end">
                        <div class="user-info">
                            <div id="userEmail"></div>
                        </div>
                        <button class="btn" id="btnSignOut">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- message box -->
    <div id="messageBoxOverlay" class="message-box-overlay">
        <div id="messageBox" class="message-box">
            <h4 id="messageTitle"></h4>
            <p id="messageText"></p>
            <div class="row" style="justify-content:center;">
                <button class="btn btn-primary" id="messageBoxOk">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";

        /* =========================
           STATE + HELPERS
           ========================= */
        const $ = id => document.getElementById(id);
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const esc = s => String(s ?? '').replace(/"/g,'""');

        const savedLibraryKey = 'lead_studio_pro_lib_v1';
        let currentUser = null;
        function setStatus(t){ if($('status')) $('status').innerText = t; if($('footerInfo')) $('footerInfo').innerText = t; }
        function setProgress(p){ if($('progressBar')) $('progressBar').style.width = Math.min(100, Math.round(p*100)) + '%'; if($('progressText')) $('progressText').innerText = Math.round(Math.min(100, Math.max(0, p*100))) + '%'; }

        let LIB = [];        // enriched channels
        let VIEW = [];       // filtered/sorted view
        let lastExport = [];
        let lastSearch = {};

        // custom message box
        function showMessage(title, message) {
            $('messageTitle').innerText = title;
            $('messageText').innerText = message;
            $('messageBoxOverlay').style.display = 'flex';
        }
        $('messageBoxOk').addEventListener('click', ()=> { $('messageBoxOverlay').style.display = 'none'; });

        // ===== FIREBASE (kept as-is) =====
        const firebaseConfig = {
          apiKey: "AIzaSyBvU3_Njbi1JQr_wD1a16h5coTW2ifaRDU",
          authDomain: "youleadmax.firebaseapp.com",
          projectId: "youleadmax",
          storageBucket: "youleadmax.firebasestorage.app",
          messagingSenderId: "710806971072",
          appId: "1:710806971072:web:ced903befe8693f886c325",
          measurementId: "G-JW9W20C1LQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const logSearchCallable = httpsCallable(functions, 'logSearch');

        /* ========================= AUTH ========================= */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('app-view').style.display = 'grid';
                $('auth-view').style.display = 'none';
                $('userEmail').innerText = `Logged in as: ${user.email}`;

                // log user
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, { lastLogin: new Date().toISOString() }, { merge: true });
            } else {
                currentUser = null;
                $('app-view').style.display = 'none';
                $('auth-view').style.display = 'block';
            }
        });

        $('btnSignIn').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                $('authStatus').innerText = 'Sign-in failed: ' + error.message;
            }
        });

        $('btnSignUp').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                $('authStatus').innerText = 'Sign-up failed: ' + error.message;
            }
        });

        $('btnSignOut').addEventListener('click', async () => {
            await signOut(auth);
            resetResults();
        });

        /* ========================= SEARCH / FETCH ========================= */
        $('btnSearch').addEventListener('click', () => searchAll(false));
        $('btnDeepSearch').addEventListener('click', () => {
          const queryRaw = $('query').value.trim();
          if (!queryRaw.length) { showMessage('Search Error','Please enter at least one query'); return; }
          if (!currentUser) { showMessage('Authentication Required','Please sign in first.'); return; }

          // confirmation UI
          $('messageTitle').innerText = 'Deep Search Confirmation';
          $('messageText').innerText = 'Deep Search will use more API quota by searching more pages. Continue?';
          const confirmBtn = document.createElement('button');
          confirmBtn.className='btn btn-primary';
          confirmBtn.innerText='Yes, Continue';
          const cancelBtn = document.createElement('button');
          cancelBtn.className='btn';
          cancelBtn.innerText='Cancel';
          const messageBox = $('messageBox');
          const okBtn = $('messageBoxOk');
          okBtn.style.display='none';
          // remove previous dynamic buttons
          const prev = messageBox.querySelectorAll('.btn.dynamic'); prev.forEach(b=>b.remove());
          confirmBtn.classList.add('dynamic'); cancelBtn.classList.add('dynamic');
          confirmBtn.addEventListener('click', ()=>{ $('messageBoxOverlay').style.display='none'; searchAll(true); okBtn.style.display='block'; confirmBtn.remove(); cancelBtn.remove(); });
          cancelBtn.addEventListener('click', ()=>{ $('messageBoxOverlay').style.display='none'; okBtn.style.display='block'; confirmBtn.remove(); cancelBtn.remove(); });
          messageBox.appendChild(confirmBtn); messageBox.appendChild(cancelBtn);
          $('messageBoxOverlay').style.display='flex';
        });

        $('btnClear').addEventListener('click', () => { $('query').value=''; resetResults(); });
        $('query').addEventListener('keydown', e => { if(e.key==='Enter' && (e.ctrlKey || e.metaKey)) searchAll(); });

        function getPublishedAfterISO(choice){
          const d = new Date();
          if(choice==='hour') d.setHours(d.getHours()-1);
          else if(choice==='today') d.setHours(0,0,0,0);
          else if(choice==='week') d.setDate(d.getDate()-7);
          else if(choice==='month') d.setMonth(d.getMonth()-1);
          return d.toISOString();
        }

        async function searchAll(isDeepSearch=false){
            if(!currentUser){ showMessage('Authentication Required','Please sign in first.'); return; }
            const apiKey = $('apiKey').value.trim();
            if(!apiKey) { showMessage('API Key Missing','Enter YouTube API key'); return; }

            const raw = $('query').value.trim();
            if(!raw) { showMessage('Input required','Enter at least one query'); return; }
            const queries = raw.split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
            if(!queries.length) { showMessage('No queries','No valid queries found'); return; }

            const order = $('order').value || 'relevance';
            const duration = $('duration').value || '';
            const upload = $('upload').value || '';
            const region = $('region').value || '';
            const definition = $('definition').value || '';
            const safe = $('safe').value || '';
            const perPage = clamp(Number($('perPage').value)||25, 1, 50);
            const pages = isDeepSearch ? 20 : clamp(Number($('pages').value)||2, 1, 10);
            const filterShorts = !!$('filterShorts').checked;

            // attempt to log search (best-effort)
            try { await logSearchCallable({ query: raw }); } catch(e){ console.warn('logSearch failure', e); }

            resetResults();
            setStatus('Searching…');
            setProgress(0);

            let chanIds = new Set();
            const totalSteps = queries.length * pages;
            let done = 0;

            for(const q of queries){
                let pageToken = '';
                for(let p=0;p<pages;p++){
                    const url = new URL('https://www.googleapis.com/youtube/v3/search');
                    url.searchParams.set('part','snippet');
                    url.searchParams.set('type','video');
                    url.searchParams.set('q', q);
                    url.searchParams.set('maxResults', String(perPage));
                    url.searchParams.set('order', order);
                    if(region) url.searchParams.set('regionCode', region);
                    if(duration) url.searchParams.set('videoDuration', duration);
                    if(definition) url.searchParams.set('videoDefinition', definition);
                    if(safe) url.searchParams.set('safeSearch', safe);
                    if(upload) url.searchParams.set('publishedAfter', getPublishedAfterISO(upload));
                    if(pageToken) url.searchParams.set('pageToken', pageToken);
                    url.searchParams.set('key', apiKey);

                    let resp;
                    try { resp = await fetch(url.toString()); }
                    catch(e){ console.error(e); showMessage('Network Error','Network error during search'); setStatus('Network Error'); return; }

                    if(!resp.ok){ const t = await resp.text(); showMessage('YouTube Search Error', `Status ${resp.status}\n${t}`); setStatus('API Error'); return; }
                    const data = await resp.json();

                    (data.items || []).forEach(item => {
                        const t = (item.snippet && item.snippet.title) ? item.snippet.title.toLowerCase() : '';
                        const d = (item.snippet && item.snippet.description) ? item.snippet.description.toLowerCase() : '';
                        if(filterShorts) {
                          if(t.includes('#shorts') || t.includes('shorts ') || t.endsWith('shorts') || d.includes('#shorts') || d.includes('shorts ')) return;
                        }
                        const cid = item.snippet ? item.snippet.channelId : '';
                        if(cid) chanIds.add(cid);
                    });

                    pageToken = data.nextPageToken || '';
                    done++;
                    setProgress(done/totalSteps * 0.55);
                    await sleep(140);
                    if(!pageToken) break;
                }
            }

            if(chanIds.size === 0){ setStatus('No channels'); setProgress(1); showMessage('No Results','No channels found for your queries.'); return; }
            setStatus(`Found ${chanIds.size} channels — fetching details…`);

            const ids = Array.from(chanIds);
            for(let i=0;i<ids.length;i+=50){
                const batch = ids.slice(i,i+50);
                const chURL = new URL('https://www.googleapis.com/youtube/v3/channels');
                chURL.searchParams.set('part','snippet,statistics,brandingSettings');
                chURL.searchParams.set('id', batch.join(','));
                chURL.searchParams.set('key', apiKey);
                let resp;
                try { resp = await fetch(chURL.toString()); }
                catch(e){ console.error(e); showMessage('Network Error','Error fetching channel details'); setStatus('Network Error'); return; }
                if(!resp.ok){ const t = await resp.text(); showMessage('Channels API Error', `Status ${resp.status}\n${t}`); setStatus('API Error'); return; }
                const data = await resp.json();

                (data.items || []).forEach(ch => {
                    if(!ch.snippet || !ch.snippet.title) return;
                    const stats = ch.statistics || {};
                    const subs = Number(stats.subscriberCount||0);
                    const views = Number(stats.viewCount||0);
                    const vids = Number(stats.videoCount||0);
                    if(subs < 10) return; // filter out junk channels
                    const country = ch.snippet.country || (ch.brandingSettings && ch.brandingSettings.channel && ch.brandingSettings.channel.country) || 'N/A';
                    LIB.push({
                        channelId: ch.id,
                        title: ch.snippet.title,
                        description: ch.snippet.description || '',
                        avatar: (ch.snippet.thumbnails && (ch.snippet.thumbnails.medium || ch.snippet.thumbnails.default)) ? (ch.snippet.thumbnails.medium || ch.snippet.thumbnails.default).url : '',
                        banner: (ch.brandingSettings && ch.brandingSettings.image && ch.brandingSettings.image.bannerExternalUrl) ? ch.brandingSettings.image.bannerExternalUrl : '',
                        subs, views, videos: vids,
                        hidden: !!stats.hiddenSubscriberCount,
                        country: country,
                        createdAt: (ch.snippet.publishedAt||'').split('T')[0] || '',
                        verified: 'Unknown'
                    });
                });

                setProgress(0.55 + Math.min((i+50)/ids.length, 1) * 0.4);
                await sleep(120);
            }

            // optional verification (best-effort)
            if($('doVerify').checked && $('corsProxy').value.trim()){
                setStatus('Verifying channels (best-effort)…');
                const proxy = $('corsProxy').value.trim().replace(/\/$/,'');
                for(let i=0;i<LIB.length;i++){
                    const c = LIB[i];
                    try {
                        const url = proxy + '/' + encodeURIComponent('https://www.youtube.com/channel/' + c.channelId);
                        const r = await fetch(url);
                        if(r && r.ok){
                            const txt = (await r.text()).toLowerCase();
                            if(/verified|checkmark|channelbadge/.test(txt)) c.verified = 'Yes';
                            else c.verified = 'No';
                        }
                    } catch(e){}
                    setProgress(0.9 + i/LIB.length * 0.08);
                }
            }

            applyClientFiltersAndRender();
            setProgress(1); setStatus('Ready');
            lastSearch = { queries, perPage, pages };
        }

        function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

        /* =========================
           apply filters + render
           ========================= */
        $('clientSort').addEventListener('change', applyClientFiltersAndRender);
        $('minSubs').addEventListener('input', () => setTimeout(applyClientFiltersAndRender, 120));
        $('maxSubs').addEventListener('input', () => setTimeout(applyClientFiltersAndRender, 120));
        $('searchInResults').addEventListener('input', () => setTimeout(applyClientFiltersAndRender, 150));

        function applyClientFiltersAndRender(){
            const min = Number($('minSubs').value||0);
            const maxRaw = Number($('maxSubs').value||0);
            const max = maxRaw>0? maxRaw : Infinity;
            const needle = $('searchInResults').value.trim().toLowerCase();

            VIEW = LIB.filter(c => {
                if(c.subs < min) return false;
                if(c.subs > max) return false;
                if(needle){
                    const hit = (c.title && c.title.toLowerCase().includes(needle)) || (c.channelId && c.channelId.toLowerCase().includes(needle));
                    if(!hit) return false;
                }
                return true;
            });

            // client sort
            const sort = $('clientSort').value;
            VIEW.sort((a,b) => {
                if(sort==='subs-desc') return (b.subs||0) - (a.subs||0);
                if(sort==='subs-asc') return (a.subs||0) - (b.subs||0);
                if(sort==='views-desc')return (b.views||0) - (a.views||0);
                if(sort==='views-asc') return (a.views||0) - (b.views||0);
                if(sort==='title-asc') return (a.title||'').localeCompare(b.title||'');
                if(sort==='title-desc')return (b.title||'').localeCompare(a.title||'');
                return 0;
            });

            renderResults(VIEW);
            lastExport = VIEW.slice();
            $('count').innerText = VIEW.length + ' channels';
        }

        /* =========================
           render results + details
           ========================= */
        function renderResults(list){
            const tbody = $('resultsTbody');
            tbody.innerHTML = '';
            if(!list.length){
                tbody.innerHTML = `<tr><td colspan="6" class="meta">No channels match your filters.</td></tr>`;
                return;
            }
            list.forEach((c, idx) => {
                const tr = document.createElement('tr');

                // build cells safely
                const tdCheck = document.createElement('td');
                tdCheck.innerHTML = `<input type="checkbox" class="sel" data-idx="${idx}"/>`;

                const tdChannel = document.createElement('td');
                tdChannel.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px">
                        <img class="avatar" src="${escapeAttr(c.avatar || '')}" alt="">
                        <div>
                            <div style="font-weight:700">${escapeHtml(c.title)}</div>
                            <div class="meta">${escapeHtml(c.channelId)}</div>
                        </div>
                    </div>
                `;

                const tdSubs = document.createElement('td'); tdSubs.textContent = c.hidden ? 'Hidden' : (c.subs||0).toLocaleString();
                const tdVideos = document.createElement('td'); tdVideos.textContent = (c.videos||0).toLocaleString();
                const tdViews = document.createElement('td'); tdViews.textContent = (c.views||0).toLocaleString();
                const tdVerified = document.createElement('td'); tdVerified.textContent = c.verified || 'Unknown';

                tr.appendChild(tdCheck); tr.appendChild(tdChannel); tr.appendChild(tdSubs); tr.appendChild(tdVideos); tr.appendChild(tdViews); tr.appendChild(tdVerified);

                tr.addEventListener('click', (e) => {
                    // ignore clicks on the checkbox itself
                    if(e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'A' || e.target.tagName === 'BUTTON')) return;
                    renderDetails(c);
                });

                tbody.appendChild(tr);
            });
        }

        /* render details uses an About-page scrape to show socials (best-effort) */
        async function renderDetails(c){
            $('detailTitle').innerText = c.title;

            // show banner if available
            if(c.banner){
                $('banner').style.display = 'block';
                $('banner').style.backgroundImage = `url(${escapeAttr(c.banner)})`;
            } else {
                $('banner').style.display = 'none';
            }

            // fetch social links from about page (best-effort)
            const socialLinks = await getSocialLinksFromAboutPage(c.channelId);

            $('detailContent').innerHTML = `
                <div class="meta">Channel ID: ${escapeHtml(c.channelId)} • ${escapeHtml(c.country)} • Created: ${escapeHtml(c.createdAt)}</div>
                <p style="margin-top:10px;line-height:1.5;font-size:14px;color:var(--muted)">${escapeHtml(c.description || '')}</p>
                <div class="stats" style="margin-top:14px">
                    <div class="stat"><b>${(c.subs||0).toLocaleString()}</b><div class="meta">Subscribers</div></div>
                    <div class="stat"><b>${(c.views||0).toLocaleString()}</b><div class="meta">Total Views</div></div>
                    <div class="stat"><b>${(c.videos||0).toLocaleString()}</b><div class="meta">Total Videos</div></div>
                </div>

                <h4 style="margin:20px 0 8px">Social Links</h4>
                <div id="socialLinksContainer" class="row" style="flex-wrap:wrap;gap:8px"></div>

                <h4 style="margin:20px 0 8px">Latest Videos <small class="meta">(up to 6)</small></h4>
                <div class="videos-grid" id="latestVideos"><div class="meta">Loading...</div></div>
            `;

            // populate social buttons
            const container = $('socialLinksContainer');
            container.innerHTML = '';
            const addSocialBtn = (label, url) => {
                const a = document.createElement('a');
                a.className = 'btn';
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener';
                a.textContent = label;
                container.appendChild(a);
            };
            if(socialLinks.website) addSocialBtn('Website', socialLinks.website);
            if(socialLinks.twitter) addSocialBtn('Twitter', socialLinks.twitter);
            if(socialLinks.instagram) addSocialBtn('Instagram', socialLinks.instagram);
            if(socialLinks.facebook) addSocialBtn('Facebook', socialLinks.facebook);
            if(socialLinks.tiktok) addSocialBtn('TikTok', socialLinks.tiktok);
            if(socialLinks.linkedin) addSocialBtn('LinkedIn', socialLinks.linkedin);
            if(!Object.keys(socialLinks).length) container.innerHTML = '<div class="meta">No socials detected.</div>';

            // render quick social chips at topbar (small)
            renderQuickChips(socialLinks);

            // load latest videos
            await loadLatestVideos(c.channelId);
        }

        // Quick chips in topbar (non-destructive addition)
        function renderQuickChips(socials){
            // create topbar chip area if missing
            let tb = document.getElementById('topbarChips');
            if(!tb){
                tb = document.createElement('div'); tb.id='topbarChips'; tb.style.marginLeft='12px';
                document.querySelector('.topbar .bar-controls').appendChild(tb);
            }
            tb.innerHTML = '';
            const keys = ['website','twitter','instagram','facebook','tiktok','linkedin'];
            let added=false;
            keys.forEach(k=>{
                if(socials[k]){
                    const chip = document.createElement('span'); chip.className='chip'; chip.textContent = k[0].toUpperCase()+k.slice(1);
                    chip.title = socials[k];
                    chip.onclick = ()=> window.open(socials[k], '_blank', 'noopener');
                    tb.appendChild(chip); added=true;
                }
            });
            if(!added){ const hint = document.createElement('span'); hint.className='chip'; hint.style.opacity='.6'; hint.textContent='No socials'; tb.appendChild(hint); }
        }

        /* ========================= loadLatestVideos (rewritten safe build) ========================= */
        async function loadLatestVideos(channelId){
            const apiKey = $('apiKey').value.trim();
            const box = $('latestVideos');
            try{
                const u = new URL('https://www.googleapis.com/youtube/v3/search');
                u.searchParams.set('part','snippet');
                u.searchParams.set('channelId', channelId);
                u.searchParams.set('order','date');
                u.searchParams.set('maxResults','6');
                u.searchParams.set('type','video');
                u.searchParams.set('key', apiKey);
                const r = await fetch(u.toString());
                if(!r.ok){ box.innerHTML = '<div class="meta">Cannot load videos.</div>'; return; }
                const data = await r.json();
                if(!data.items?.length){ box.innerHTML = '<div class="meta">No recent videos.</div>'; return; }

                box.innerHTML = '';
                data.items.forEach(it => {
                    const vid = (it.id && it.id.videoId) ? it.id.videoId : '';
                    const thumb = (it.snippet && it.snippet.thumbnails && (it.snippet.thumbnails.medium || it.snippet.thumbnails.default)) ? (it.snippet.thumbnails.medium || it.snippet.thumbnails.default).url : '';
                    const title = it.snippet && it.snippet.title ? it.snippet.title : '';

                    const card = document.createElement('div');
                    card.className = 'video-card';

                    const img = document.createElement('img'); img.src = thumb || ''; img.alt = title;
                    const h4 = document.createElement('h4'); h4.textContent = title;
                    const row = document.createElement('div'); row.className = 'row'; row.style.marginTop = '6px';
                    const openBtn = document.createElement('button'); openBtn.className = 'btn btn-primary'; openBtn.textContent = 'Open';
                    openBtn.addEventListener('click', ()=> window.open('https://www.youtube.com/watch?v='+vid, '_blank', 'noopener'));
                    const prevBtn = document.createElement('button'); prevBtn.className = 'btn'; prevBtn.textContent = 'Preview';
                    prevBtn.addEventListener('click', ()=> embed(vid));

                    row.appendChild(openBtn); row.appendChild(prevBtn);
                    card.appendChild(img); card.appendChild(h4); card.appendChild(row);

                    box.appendChild(card);
                });
            }catch(e){ console.error(e); box.innerHTML = '<div class="meta">Error loading videos.</div>'; }
        }

        /* ========================= embed preview (FIXED + improved) ========================= */
        function embed(videoId){
            if(!videoId) { showMessage('Preview Error','No video id available'); return; }
            // remove existing preview
            const container = $('videoPreviewContainer');
            if(!container) return;
            container.innerHTML = '';
            container.style.display = 'block';

            const wrap = document.createElement('div');
            wrap.style.position = 'relative';

            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn';
            closeBtn.style.position = 'absolute';
            closeBtn.style.right = '6px';
            closeBtn.style.top = '-40px';
            closeBtn.textContent = 'Close Preview';
            closeBtn.addEventListener('click', ()=> {
                container.innerHTML=''; container.style.display='none';
            });

            const iframe = document.createElement('iframe');
            iframe.id = 'previewFrame';
            iframe.width = '100%';
            iframe.height = '280';
            iframe.style.border = '1px solid rgba(255,255,255,.08)';
            iframe.style.borderRadius = '12px';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.src = 'https://www.youtube.com/embed/' + encodeURIComponent(videoId) + '?rel=0&modestbranding=1&autoplay=1';

            wrap.appendChild(closeBtn);
            wrap.appendChild(iframe);
            container.appendChild(wrap);
            iframe.scrollIntoView({behavior:'smooth'});
        }

        /* ========================= UTIL: sanitize functions ========================= */
        function escapeHtml(str){
            if(!str && str!==0) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
        function escapeAttr(s){ return escapeHtml(s); } // safe for attributes set via innerHTML
        function escapeHtmlText(s){ return escapeHtml(s); }

        /* ========================= Exporting + library management ========================= */
        $('btnExportCSV').addEventListener('click', () => {
            if(!lastExport.length) { showMessage('Export Failed','No results to export'); return; }
            downloadText(toCSV(lastExport),'lead_studio_pro.csv','text/csv');
        });
        $('btnExportJSON').addEventListener('click', () => {
            if(!lastExport.length) { showMessage('Export Failed','No results to export'); return; }
            downloadText(JSON.stringify(lastExport.map(cToSafe), null, 2),'lead_studio_pro.json','application/json');
        });
        $('btnCopyIDs').addEventListener('click', async () => {
            if(!lastExport.length) { showMessage('Copy Failed','No results to copy'); return; }
            const ids = lastExport.map(r => r.channelId).join('\n');
            await copyText(ids);
            showMessage('Copy Success','Channel IDs copied to clipboard.');
        });

        $('btnSelectAll').addEventListener('click', ()=>document.querySelectorAll('.sel').forEach(cb=>cb.checked=true));
        $('btnDeselectAll').addEventListener('click', ()=>document.querySelectorAll('.sel').forEach(cb=>cb.checked=false));
        $('btnOpenSelected').addEventListener('click', ()=> {
            const s = getSelected();
            if(!s.length) return showMessage('Open Failed','Select some channels first');
            s.forEach(ch => window.open('https://www.youtube.com/channel/'+ch.channelId,'_blank','noopener'));
        });

        $('btnExportSelected').addEventListener('click', ()=> {
            const rows = getSelected(); if(!rows.length) return showMessage('Export Failed','Select some rows first');
            downloadText(toCSV(rows),'lead_studio_pro_selected.csv','text/csv');
        });
        $('btnCopySelected').addEventListener('click', async ()=> {
            const rows = getSelected(); if(!rows.length) return showMessage('Copy Failed','Select some rows first');
            const csv = toCSV(rows); await copyText(csv); showMessage('Copy Success','Selected CSV copied to clipboard.');
        });

        $('btnClearResults').addEventListener('click', ()=> { resetResults(); showMessage('Cleared','Results cleared'); });

        function getSelected(){ return Array.from(document.querySelectorAll('.sel:checked')).map(cb => VIEW[Number(cb.dataset.idx)]).filter(Boolean); }
        function toCSV(arr){
            const fields = ['channel','subs','videos','views','verified','channelId','country','createdAt'];
            let out = fields.join(',') + '\n';
            arr.forEach(r => {
                out += `"${esc(r.title)}","${r.hidden?'Hidden':r.subs}","${r.videos}","${r.views}","${r.verified}","${r.channelId}","${esc(r.country)}","${r.createdAt}"\n`;
            });
            return out;
        }
        function downloadText(text, filename, type){
            const blob = new Blob([text], {type:type});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
            setTimeout(()=>URL.revokeObjectURL(url),1500);
        }
        function cToSafe(c){ return { channelId:c.channelId, title:c.title, subs:c.subs, views:c.views, videos:c.videos, verified:c.verified, country:c.country, createdAt:c.createdAt }; }
        $('btnSaveLib').addEventListener('click', ()=> {
            if(!LIB.length) return showMessage('Save Failed','No channels to save.');
            try { localStorage.setItem(savedLibraryKey, JSON.stringify(LIB)); showMessage('Save Success',`Saved ${LIB.length} channels`); } catch(e){ showMessage('Save Failed','Local storage error'); }
        });
        $('btnLoadLib').addEventListener('click', ()=> {
            const raw = localStorage.getItem(savedLibraryKey); if(!raw) return showMessage('Load Failed','No saved library');
            try{ LIB = JSON.parse(raw); applyClientFiltersAndRender(); showMessage('Load Success',`Loaded ${LIB.length} channels`);}catch(e){ showMessage('Load Failed','Data corrupted'); }
        });

        /* ========================= Social scraping (best-effort; respects CORS) ========================= */
        async function getSocialLinksFromAboutPage(channelId){
            try{
                const proxy = $('corsProxy').value || '';
                // if a proxy is provided, ensure it ends with / or not? user likely provides one ending in /
                const aboutUrl = proxy + 'https://www.youtube.com/channel/' + channelId + '/about';
                const resp = await fetch(aboutUrl);
                if(!resp.ok) return {};
                const html = await resp.text();
                // parse the HTML and find external links in "about" area (best-effort)
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const anchors = doc.querySelectorAll('a[href]');
                const socials = {};
                anchors.forEach(a => {
                    const href = a.href || a.getAttribute('href') || '';
                    if(!href) return;
                    if(/twitter\.com/i.test(href)) socials.twitter = href;
                    else if(/instagram\.com/i.test(href)) socials.instagram = href;
                    else if(/facebook\.com/i.test(href)) socials.facebook = href;
                    else if(/tiktok\.com/i.test(href)) socials.tiktok = href;
                    else if(/linkedin\.com/i.test(href)) socials.linkedin = href;
                    else if(!socials.website) socials.website = href;
                });
                return socials;
            }catch(e){
                console.warn('social scraping failed', e);
                return {};
            }
        }

        /* ========================= Sanitizers + copy helper ========================= */
        function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        function copyText(text){ return navigator.clipboard?.writeText ? navigator.clipboard.writeText(text) : (function(){ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); })(); }
        function sanitize(s){ try { return String(s || ''); } catch(e){ return ''; } }

        /* ========================= reset + init ========================= */
        function resetResults(){
            LIB = []; VIEW = []; lastExport = [];
            $('resultsTbody').innerHTML=''; $('count').innerText='0 channels';
            $('detailTitle').innerText = 'Select a channel';
            $('detailContent').innerHTML = '<div class="meta">No channel selected.</div>';
            $('banner').style.display='none'; $('banner').style.backgroundImage='none';
            const preview = $('videoPreviewContainer'); if(preview){ preview.innerHTML=''; preview.style.display='none'; }
            setProgress(0); setStatus('Idle');
        }

        // small helpers used by templates
        function escapeHtmlForTemplate(s){ return escapeHtml(String(s || '')); }
        // ensure image src safe for innerHTML attributes
        function escapeAttr(s){ return String(s || ''); }

        // initialize UI state
        resetResults();
        setStatus('Ready');
        setProgress(0);
    </script>
</body>
</html>
