<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lead Studio Pro — YouTube Channel Finder</title>
<style>
  /* =========================
     DRIPPI UI - BLUE OVERHAUL
     ========================= */

  /* Global variables */
  :root {
    --bg-0: #0C111E;
    --bg-1: #181E2C;
    --bg-2: #212B3E;
    --bg-3: #2A364A;
    --border: rgba(255, 255, 255, 0.08);
    --text-primary: #F0F4FD;
    --text-secondary: #9FAAC0;
    --accent-1: #007BFF;
    --accent-2: #00A3FF;
    --glass-fill: rgba(255, 255, 255, 0.05);
    --glass-stroke: rgba(255, 255, 255, 0.15);
    --glass-shadow: rgba(0, 0, 0, 0.35);
    --radius: 12px;
    --shadow-strong: 0 10px 40px rgba(0, 0, 0, 0.4);
    --shadow-subtle: 0 4px 15px rgba(0, 0, 0, 0.2);
  }

  /* Base reset & fonts */
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    color: var(--text-primary);
    background: var(--bg-0);
    overflow: hidden;
    overscroll-behavior: none;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  a { color: var(--accent-1); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* Generic styles */
  .panel, .card {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow-subtle);
  }

  input, select, textarea, button {
    font-family: inherit;
    color: var(--text-primary);
    background: var(--glass-fill);
    border: 1px solid var(--glass-stroke);
    border-radius: var(--radius);
    padding: 10px 14px;
    transition: all 0.2s ease;
  }

  input:focus, select:focus, textarea:focus, button:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--accent-1), var(--shadow-strong);
    border-color: var(--accent-1);
  }
  
  button {
    cursor: pointer;
    background: var(--bg-2);
    box-shadow: 0 2px 5px var(--glass-shadow);
  }
  
  .btn-primary {
    background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
    border-color: transparent;
    font-weight: 600;
  }
  .btn-danger {
    background: #FF5A5A;
    border-color: transparent;
  }
  
  button:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
  }
  .btn-primary:hover {
    box-shadow: 0 5px 20px rgba(0, 123, 255, 0.6);
  }
  button:active {
    transform: translateY(0);
  }
  
  .input-group {
    display: flex;
    gap: 10px;
  }
  .input-group input { flex-grow: 1; }

  /* App Shell */
  .app {
    max-width: 1400px;
    margin: 20px;
    height: calc(100vh - 40px);
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 16px;
  }
  
  .left-sidebar {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .logo {
    display: flex;
    flex-direction: column;
    margin-bottom: 20px;
  }
  .logo h1 {
    font-size: 24px;
    font-weight: 700;
    margin: 0;
    line-height: 1;
  }
  .logo p {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 5px 0 0;
  }
  
  .main-content {
    display: grid;
    grid-template-rows: auto 1fr;
    gap: 16px;
    min-height: 0;
  }
  
  .controls-panel {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .controls-group {
    display: flex;
    gap: 10px;
  }
  
  .full-width {
    width: 100%;
  }
  
  .search-inputs {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .search-bar {
    display: flex;
    gap: 10px;
  }
  
  .search-bar input {
    flex-grow: 1;
  }
  
  .button-group {
    display: flex;
    gap: 8px;
  }
  .button-group .btn {
      flex: 1;
      text-align: center;
  }

  /* Results Table */
  .results-container {
    padding: 0;
    min-height: 0;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .table-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .table-wrap {
    overflow: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  thead th {
    background: var(--bg-2);
    padding: 14px;
    text-align: left;
    font-weight: 600;
    color: var(--text-secondary);
    position: sticky;
    top: 0;
  }
  
  tbody td {
    padding: 12px 14px;
    border-top: 1px solid var(--border);
    vertical-align: middle;
  }
  
  tbody tr:hover {
    background: var(--glass-fill);
  }
  
  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
  }
  
  .channel-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .channel-info .title {
    font-weight: 600;
  }
  .channel-info .id {
    font-size: 12px;
    color: var(--text-secondary);
  }

  /* Progress bar */
  .progress-bar {
    height: 6px;
    border-radius: 999px;
    background: var(--border);
    overflow: hidden;
  }
  .progress-bar i {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
    width: 0%;
    transition: width 0.3s ease;
  }

  /* Details Panel */
  .details-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .detail-title h3 {
    margin: 0;
  }
  .detail-title .meta {
    font-size: 13px;
    color: var(--text-secondary);
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }
  .stat-card {
    padding: 14px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    text-align: center;
  }
  .stat-card b {
    display: block;
    font-size: 18px;
    font-weight: 600;
  }
  .stat-card .meta {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }
  .video-card {
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-2);
    border: 1px solid var(--border);
  }
  .video-card img {
    width: 100%;
    height: 100px;
    object-fit: cover;
  }
  .video-card-body {
    padding: 10px;
  }
  .video-card-body h4 {
    margin: 0 0 8px;
    font-size: 14px;
    line-height: 1.3;
    font-weight: 500;
  }
  
  /* Custom Message Box Styling */
  .message-box-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
  }
  .message-box {
      background: var(--bg-1);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-strong);
      max-width: 400px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border: 1px solid var(--border);
  }

  /* Login screen styles */
  .auth-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    width: 100%;
  }

  .auth-card {
    width: 100%;
    max-width: 380px;
    padding: 40px;
    background: var(--bg-2);
    border-radius: var(--radius);
    box-shadow: var(--shadow-strong);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 20px;
    text-align: center;
  }
  
  .auth-card h2 {
    font-size: 28px;
    font-weight: 700;
    margin: 0;
    line-height: 1.2;
  }
  
  .auth-card p {
    color: var(--text-secondary);
    margin-top: -10px;
  }

  .auth-card .input-group {
    flex-direction: column;
    gap: 12px;
  }

  .auth-card button {
    width: 100%;
  }

  .auth-card .meta {
    color: var(--text-secondary);
    font-size: 14px;
    margin-top: -10px;
  }

  @media (max-width: 1200px) {
    .app {
      grid-template-columns: 1fr;
      height: auto;
      min-height: 100vh;
    }
  }

</style>
</head>
<body>
    <div id="auth-view" class="auth-container">
        <div class="auth-card">
            <h2>Welcome Back</h2>
            <p>Sign in to your account to continue.</p>
            <div class="input-group">
                <input id="email" type="email" placeholder="Email"/>
                <input id="password" type="password" placeholder="Password"/>
            </div>
            <button id="btnSignIn" class="btn btn-primary">Sign In</button>
            <p class="meta">or</p>
            <div class="input-group">
              <button id="btnSignUp" class="btn">Sign Up</button>
              <button id="btnGuest" class="btn">Continue as Guest</button>
            </div>
        </div>
    </div>
    
    <div id="app-view" class="app" style="display: none;">
        <div class="left-sidebar">
            <div class="logo">
                <h1>Lead Studio Pro</h1>
                <p>YouTube Channel Finder</p>
            </div>
            
            <div class="controls-panel">
                <div class="meta">Advanced Filters</div>
                <div class="controls-group">
                    <select id="order" class="full-width"><option value="relevance">Order: Relevance</option><option value="date">Order: Date</option><option value="viewCount">Order: Views</option><option value="rating">Order: Rating</option></select>
                </div>
                <div class="controls-group">
                    <select id="duration" class="full-width"><option value="">Duration: Any</option><option value="short">Short (<4m)</option><option value="medium">Medium (4–20m)</option><option value="long">Long (>20m)</option></select>
                </div>
                <div class="controls-group">
                    <select id="upload" class="full-width"><option value="">Upload Time: Any</option><option value="hour">Last hour</option><option value="today">Today</option><option value="week">This week</option><option value="month">This month</option></select>
                </div>
                <div class="controls-group">
                    <select id="region" class="full-width"><option value="">Region: Any</option><option>US</option><option>IN</option><option>GB</option><option>CA</option><option>AU</option><option>DE</option></select>
                </div>
                <div class="controls-group">
                    <select id="definition" class="full-width"><option value="">Definition: Any</option><option value="high">HD</option><option value="standard">SD</option></select>
                </div>
                <div class="controls-group">
                    <select id="safe" class="full-width"><option value="">Safe: Any</option><option value="none">None</option><option value="moderate">Moderate</option><option value="strict">Strict</option></select>
                </div>
                
                <input id="perPage" class="full-width" type="number" min="1" max="50" value="25" placeholder="Results per page (1–50)"/>
                <input id="pages" class="full-width" type="number" min="1" max="10" value="2" placeholder="Pages per query (1–10)"/>

                <div class="controls-group">
                    <input id="minSubs" type="number" placeholder="Min subs"/>
                    <input id="maxSubs" type="number" placeholder="Max subs"/>
                </div>

                <input id="searchInResults" class="full-width" type="text" placeholder="Search within results (title / ID)"/>
                
                <div class="controls-group" style="justify-content: space-between;">
                    <div class="meta" id="status">Idle</div>
                    <div class="meta" id="count">0 channels</div>
                </div>
                <div class="progress-bar"><i id="progressBar"></i></div>
            </div>
        </div>

        <div class="main-content">
            <div class="search-inputs">
                <div class="search-bar">
                    <input id="query" type="text" placeholder="Enter one or more queries (comma or newline separated)"/>
                    <button class="btn btn-primary" id="btnSearch">Search</button>
                    <button class="btn" id="btnClear">Clear</button>
                </div>
                <input id="apiKey" type="text" placeholder="Enter your YouTube API Key" value="" style="flex-grow: 1"/>
            </div>

            <div class="panel results-container">
                <div class="table-toolbar">
                    <div class="button-group">
                        <button class="btn" id="btnSelectAll">Select All</button>
                        <button class="btn" id="btnDeselectAll">Deselect</button>
                        <select id="clientSort" class="full-width">
                            <option value="subs-desc">Sort: Subs ↓</option>
                            <option value="subs-asc">Sort: Subs ↑</option>
                            <option value="views-desc">Sort: Views ↓</option>
                            <option value="views-asc">Sort: Views ↑</option>
                            <option value="title-asc">Sort: Title A→Z</option>
                            <option value="title-desc">Sort: Title Z→A</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn" id="btnSaveLib">Save</button>
                        <button class="btn" id="btnLoadLib">Load</button>
                        <button class="btn btn-primary" id="btnExportCSV">Export</button>
                        <button class="btn btn-danger" id="btnClearResults">Clear All</button>
                    </div>
                </div>

                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Channel</th>
                                <th>Subs</th>
                                <th>Videos</th>
                                <th>Views</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="detailView" class="panel details-panel" style="display: none;">
                <div class="details-header">
                    <div class="detail-title">
                        <h3 id="detailTitle"></h3>
                        <div class="meta" id="detailId"></div>
                    </div>
                    <div class="button-group">
                        <button class="btn" id="btnExportSelected">Export Selected</button>
                        <button class="btn" id="btnCopySelected">Copy Selected CSV</button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card"><b><span id="statSubs"></span></b><div class="meta">Subscribers</div></div>
                    <div class="stat-card"><b><span id="statViews"></span></b><div class="meta">Total Views</div></div>
                    <div class="stat-card"><b><b><span id="statVideos"></span></b></b><div class="meta">Total Videos</div></div>
                </div>

                <div class="video-grid" id="latestVideos"></div>
                
                <div style="border-top: 1px solid var(--border); padding-top: 16px;">
                    <div class="meta">
                        Logged in as: <span id="userEmail"></span>
                    </div>
                    <div class="button-group" style="margin-top: 10px;">
                        <button class="btn" id="btnSignOut">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Message Box -->
    <div id="messageBoxOverlay" class="message-box-overlay">
        <div id="messageBox" class="message-box">
            <h4 id="messageTitle"></h4>
            <p id="messageText"></p>
            <button class="btn btn-primary" id="messageBoxOk">OK</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";
        
        // --- MANDATORY: Firebase Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END MANDATORY: Firebase Global Variables ---

        /* =========================
           STATE + HELPERS
           ========================= */
        const $ = id => document.getElementById(id);
        const sleep = ms => new Promise(r => setTimeout(r, r));
        const esc = s => String(s ?? '').replace(/"/g,'""');

        const savedLibraryKey = 'lead_studio_pro_lib_v1';
        let currentUser = null;
        
        function setStatus(t){ $('status').innerText = t; }
        function setProgress(p){ $('progressBar').style.width = Math.min(100, Math.round(p*100)) + '%'; }

        let LIB = []; // enriched channels
        let VIEW = []; // filtered/sorted view
        let lastExport = [];
        let lastSearch = {};
        
        // Custom message box to replace alert()
        function showMessage(title, message) {
            $('messageTitle').innerText = title;
            $('messageText').innerText = message;
            $('messageBoxOverlay').style.display = 'flex';
        }
        $('messageBoxOk').addEventListener('click', () => {
            $('messageBoxOverlay').style.display = 'none';
        });
        
        // UI Toggling
        const authView = $('auth-view');
        const appView = $('app-view');

        function showAppView() {
            authView.style.display = 'none';
            appView.style.display = 'grid';
        }

        function showAuthView() {
            authView.style.display = 'flex';
            appView.style.display = 'none';
        }

        // === FIREBASE CONFIGURATION ===
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        // Functions will not be available in this environment, but we can keep the code.
        const logSearchCallable = (data) => Promise.resolve(console.log('Log search called:', data));

        /* ========================= AUTHENTICATION ========================= */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('userEmail').innerText = `${user.email || 'Anonymous'}`;
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, {
                    lastLogin: new Date().toISOString()
                }, { merge: true });
                showAppView();
            } else {
                currentUser = null;
                showAuthView();
            }
        });

        // Use the initial auth token provided by the environment to sign in automatically
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(error => {
                console.error("Custom token sign-in failed:", error);
                // Fallback to anonymous sign-in
                signInAnonymously(auth).catch(anonError => {
                    console.error("Anonymous sign-in failed:", anonError);
                    showMessage('Authentication Error', 'Failed to sign in. Please try again.');
                });
            });
        } else {
             // Fallback to anonymous sign-in if no token is provided
            signInAnonymously(auth).catch(error => {
                console.error("Anonymous sign-in failed:", error);
                 showMessage('Authentication Error', 'Failed to sign in anonymously. Please try again.');
            });
        }

        // Event listeners for login page
        $('btnSignIn').addEventListener('click', async () => {
          const email = $('email').value;
          const password = $('password').value;
          try {
            await signInWithEmailAndPassword(auth, email, password);
          } catch(e) {
            console.error(e);
            showMessage('Sign-In Error', e.message);
          }
        });

        $('btnSignUp').addEventListener('click', async () => {
          const email = $('email').value;
          const password = $('password').value;
          try {
            await createUserWithEmailAndPassword(auth, email, password);
            showMessage('Success', 'Account created! Please sign in.');
          } catch(e) {
            console.error(e);
            showMessage('Sign-Up Error', e.message);
          }
        });

        $('btnGuest').addEventListener('click', async () => {
          try {
            await signInAnonymously(auth);
          } catch(e) {
            console.error(e);
            showMessage('Guest Sign-In Error', e.message);
          }
        });

        $('btnSignOut').addEventListener('click', async () => {
            await signOut(auth);
            resetResults();
        });

        /* ========================= SEARCH / FETCH ========================= */
        $('btnSearch').addEventListener('click', searchAll);
        $('btnClear').addEventListener('click', () => { $('query').value=''; resetResults(); });
        $('query').addEventListener('keydown', e => { if(e.key==='Enter') searchAll(); });

        async function searchAll(){
            const queryRaw = $('query').value.trim();
            const queries = queryRaw.split(/[,\\n]/).map(q=>q.trim()).filter(Boolean);
            const perPage = clamp(Number($('perPage').value||25), 1, 50);
            const pages = clamp(Number($('pages').value||2), 1, 10);
            const apiKey = $('apiKey').value.trim();

            if(!queries.length){ showMessage('Search Error', 'Please enter at least one query'); return; }
            if(!apiKey){ showMessage('Search Error', 'Please enter a YouTube API Key.'); return; }
            if(!currentUser){ showMessage('Authentication Required', 'Please sign in first.'); return; }

            try {
              // Using a placeholder since functions are not supported
              await logSearchCallable({ query: queryRaw });
            } catch (error) {
              console.error('Failed to log search:', error);
            }

            resetResults();
            lastSearch = { queryRaw, queries, perPage, pages };
            
            setStatus('Searching for channels...');
            const order = $('order').value;
            const duration = $('duration').value;
            const upload = $('upload').value;
            const region = $('region').value;
            const definition = $('definition').value;
            const safe = $('safe').value;
            let totalSteps = queries.length * pages;
            let done = 0;
            let chanIds = new Set();
            
            for(const q of queries){
                let pageToken = '';
                for(let i=0;i<pages;i++){
                    if(!pageToken && i>0) break;
                    
                    const url = new URL('https://www.googleapis.com/youtube/v3/search');
                    url.searchParams.set('part','snippet');
                    url.searchParams.set('type','video');
                    url.searchParams.set('q', q);
                    url.searchParams.set('maxResults', String(perPage));
                    url.searchParams.set('order', order);
                    if(region) url.searchParams.set('regionCode', region);
                    if(duration) url.searchParams.set('videoDuration', duration);
                    if(definition) url.searchParams.set('videoDefinition', definition);
                    if(upload) url.searchParams.set('publishedAfter', getPublishedAfterISO(upload));
                    if(pageToken) url.searchParams.set('pageToken', pageToken);
                    url.searchParams.set('key', apiKey);
                    
                    let resp;
                    try { resp = await fetch(url.toString()); }
                    catch(e){ console.error(e); showMessage('Network Error', 'A network error occurred during the search. Please check your connection.'); return; }
                    
                    if(!resp.ok){
                        const t = await resp.text();
                        showMessage('Search API Error', `YouTube API returned an error: ${resp.status}\n${t}`);
                        return;
                    }
                    
                    const data = await resp.json();
                    
                    (data.items || []).forEach(item => {
                        const t = (item.snippet.title||'').toLowerCase();
                        const d = (item.snippet.description||'').toLowerCase();
                        if(t.includes('#shorts') || t.includes('shorts ') || t.endsWith('shorts') || d.includes('#shorts') || d.includes('shorts ')) return;
                        const cid = item.snippet.channelId;
                        if(cid) chanIds.add(cid);
                    });
                    
                    pageToken = data.nextPageToken || '';
                    done++;
                    setProgress(done/totalSteps * 0.65);
                    await sleep(180);
                }
            }
            
            if(chanIds.size===0){ setStatus('No channels found'); setProgress(1); return; }
            
            setStatus(`Found ${chanIds.size} channels — fetching details…`);
            
            const ids = Array.from(chanIds);
            for(let i=0;i<ids.length;i+=50){
                const batch = ids.slice(i,i+50);
                const chURL = new URL('https://www.googleapis.com/youtube/v3/channels');
                chURL.searchParams.set('part','snippet,statistics,brandingSettings');
                chURL.searchParams.set('id', batch.join(','));
                chURL.searchParams.set('key', apiKey);
                
                let resp;
                try { resp = await fetch(chURL.toString()); }
                catch(e){ console.error(e); showMessage('Network Error', 'A network error occurred while fetching channel details.'); return; }
                
                if(!resp.ok){
                    const t = await resp.text();
                    showMessage('Channels API Error', `YouTube API returned an error: ${resp.status}\n${t}`);
                    return;
                }
                
                const data = await resp.json();
                
                (data.items||[]).forEach(ch => {
                    if(!ch.snippet || !ch.snippet.title) return;
                    const stats = ch.statistics || {};
                    const title = ch.snippet.title;
                    
                    let country = ch.snippet.country || '';
                    if(!country && ch.brandingSettings?.channel?.country){
                        country = ch.brandingSettings.channel.country;
                    }
                    
                    LIB.push({
                        title: title,
                        description: ch.snippet.description,
                        channelId: ch.id,
                        subs: Number(stats.subscriberCount||0),
                        views: Number(stats.viewCount||0),
                        videos: Number(stats.videoCount||0),
                        verified: (ch.snippet.customUrl||'').includes('channel') ? 'No' : 'Yes',
                        avatar: ch.snippet.thumbnails?.high?.url || ch.snippet.thumbnails?.default?.url || '',
                        banner: ch.brandingSettings?.image?.bannerExternalUrl || '',
                        country: country,
                        createdAt: ch.snippet.publishedAt.split('T')[0]
                    });
                    
                    done++;
                    setProgress(0.65 + (done/totalSteps * 0.35));
                });
                await sleep(180);
            }

            if(LIB.length===0){
                setStatus('No channels found');
            } else {
                applyClientFiltersAndRender();
                setStatus(`Found ${LIB.length} channels.`);
            }
            setProgress(1);
        }

        function getPublishedAfterISO(timeframe){
            const d = new Date();
            if(timeframe==='hour') d.setHours(d.getHours() - 1);
            if(timeframe==='today') d.setDate(d.getDate() - 1);
            if(timeframe==='week') d.setDate(d.getDate() - 7);
            if(timeframe==='month') d.setMonth(d.getMonth() - 1);
            return d.toISOString();
        }

        function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

        function applyClientFiltersAndRender(){
            const min = Number($('minSubs').value||0);
            const maxRaw = Number($('maxSubs').value||0);
            const max = maxRaw>0? maxRaw : Infinity;
            const needle = $('searchInResults').value.trim().toLowerCase();

            VIEW = LIB.filter(c => {
                if(c.subs < min) return false;
                if(c.subs > max) return false;
                if(needle){
                    const hit = (c.title?.toLowerCase().includes(needle)) || (c.channelId?.toLowerCase().includes(needle));
                    if(!hit) return false;
                }
                return true;
            });

            const sort = $('clientSort').value;
            VIEW.sort((a,b) => {
                if(sort==='subs-desc') return (b.subs||0) - (a.subs||0);
                if(sort==='subs-asc') return (a.subs||0) - (b.subs||0);
                if(sort==='views-desc')return (b.views||0) - (a.views||0);
                if(sort==='views-asc') return (a.views||0) - (b.views||0);
                if(sort==='title-asc') return (a.title||'').localeCompare(b.title||'');
                if(sort==='title-desc')return (b.title||'').localeCompare(a.title||'');
                return 0;
            });

            renderResults(VIEW);
            lastExport = VIEW.slice();
            $('count').innerText = VIEW.length + ' channels';
        }

        /* ========================= RENDER RESULTS + DETAILS ========================= */
        $('clientSort').addEventListener('change', applyClientFiltersAndRender);
        $('minSubs').addEventListener('input', applyClientFiltersAndRender);
        $('maxSubs').addEventListener('input', applyClientFiltersAndRender);
        $('searchInResults').addEventListener('input', applyClientFiltersAndRender);

        function renderResults(list){
            const tbody = $('resultsTbody');
            tbody.innerHTML = '';
            if(!list.length){
                tbody.innerHTML = `<tr><td colspan="6" class="meta">No channels match your filters.</td></tr>`;
                return;
            }
            list.forEach((c, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="sel" data-idx="${idx}"/></td>
                    <td>
                        <div class="channel-info">
                            <img class="avatar" src="${sanitize(c.avatar)}" alt="${sanitize(c.title)} avatar">
                            <div>
                                <div class="title">${sanitize(c.title)}</div>
                                <div class="id">${sanitize(c.channelId)}</div>
                            </div>
                        </div>
                    </td>
                    <td>${c.hidden ? 'Hidden' : (c.subs||0).toLocaleString()}</td>
                    <td>${(c.videos||0).toLocaleString()}</td>
                    <td>${(c.views||0).toLocaleString()}</td>
                    <td>${c.verified}</td>
                `;
                tr.addEventListener('click', e => {
                    if(e.target.type !== 'checkbox'){
                        renderDetails(c);
                    }
                });
                tbody.appendChild(tr);
            });
        }
        
        function renderDetails(c){
            $('detailView').style.display = 'flex';
            $('detailTitle').innerText = c.title;
            $('detailId').innerText = c.channelId;
            
            $('statSubs').innerText = c.subs.toLocaleString();
            $('statViews').innerText = c.views.toLocaleString();
            $('statVideos').innerText = c.videos.toLocaleString();

            loadLatestVideos(c.channelId);
        }

        /* ========================= UTIL ========================= */
        function resetResults(){
            LIB = []; VIEW = []; lastExport = [];
            $('resultsTbody').innerHTML=''; $('count').innerText='0 channels';
            $('detailView').style.display = 'none';
            setProgress(0); setStatus('Idle');
        }

        function sanitize(s){ try{ return s.replace(/</g,'<'); } catch(e){return '';} }

        async function loadLatestVideos(channelId){
            const apiKey = $('apiKey').value.trim();
            const box = $('latestVideos');
            box.innerHTML = '<div class="meta" style="text-align:center">Loading...</div>';
            try{
                const u = new URL('https://www.googleapis.com/youtube/v3/search');
                u.searchParams.set('part','snippet');
                u.searchParams.set('channelId', channelId);
                u.searchParams.set('order','date');
                u.searchParams.set('maxResults','6');
                u.searchParams.set('type','video');
                u.searchParams.set('key', apiKey);
                const r = await fetch(u.toString());
                if(!r.ok){
                    box.innerHTML = '<div class="meta" style="text-align:center">Cannot load videos.</div>';
                    return;
                }
                const data = await r.json();
                if(!data.items?.length){
                    box.innerHTML = '<div class="meta" style="text-align:center">No recent videos.</div>';
                    return;
                }
                box.innerHTML='';
                data.items.forEach(it => {
                    const vid = it.id.videoId;
                    const thumb = it.snippet.thumbnails?.medium?.url || it.snippet.thumbnails?.default?.url || '';
                    const title = it.snippet.title || '';
                    const card = document.createElement('div');
                    card.className = 'video-card';
                    card.innerHTML = `
                        <img src="${sanitize(thumb)}" alt="">
                        <div class="video-card-body">
                            <h4>${sanitize(title)}</h4>
                            <div class="button-group">
                                <button class="btn" onclick="window.open('https://www.youtube.com/watch?v=${vid}', '_blank')">Open</button>
                                <button class="btn" onclick="embed('${vid}')">Preview</button>
                            </div>
                        </div>
                    `;
                    box.appendChild(card);
                });
            }catch(e){
                console.error(e);
                box.innerHTML = '<div class="meta" style="text-align:center">Error loading videos.</div>';
            }
        }
        
        function embed(videoId){
            let frame = document.getElementById('previewFrame');
            if(frame){ frame.remove(); }
            frame = document.createElement('iframe');
            frame.id='previewFrame';
            frame.width='100%';
            frame.height='220px';
            frame.style.marginTop='10px';
            frame.src=`https://www.youtube.com/embed/${videoId}?autoplay=1`;
            frame.setAttribute('allow','accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture');
            $('detailView').appendChild(frame);
        }
        
        async function copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }

        /* ========================= EXPORTING ========================= */
        $('btnExportCSV').addEventListener('click', () => {
            const rows = lastExport;
            if(!rows.length) return showMessage('Export Failed', 'No results to export');
            downloadText(toCSV(rows), 'lead_studio_pro.csv', 'text/csv');
        });
        $('btnExportJSON').addEventListener('click', () => {
            const rows = lastExport.map(cToSafe);
            if(!rows.length) return showMessage('Export Failed', 'No results to export');
            downloadText(JSON.stringify(rows,null,2), 'lead_studio_pro.json', 'application/json');
        });
        $('btnCopyIDs').addEventListener('click', async () => {
            const rows = lastExport;
            if(!rows.length) return showMessage('Copy Failed', 'No results to copy');
            const ids = rows.map(r=>r.channelId).join('\n');
            await copyText(ids);
            showMessage('Copy Success', 'Channel IDs copied to clipboard.');
        });
        $('btnSelectAll').addEventListener('click', () => {
            document.querySelectorAll('.sel').forEach(cb => cb.checked=true);
        });
        $('btnDeselectAll').addEventListener('click', () => {
            document.querySelectorAll('.sel').forEach(cb => cb.checked=false);
        });
        $('btnExportSelected').addEventListener('click', () => {
            const rows = getSelected();
            if(!rows.length) return showMessage('Export Failed', 'Select some rows first');
            downloadText(toCSV(rows), 'lead_studio_pro_selected.csv', 'text/csv');
        });
        $('btnCopySelected').addEventListener('click', async () => {
            const rows = getSelected();
            if(!rows.length) return showMessage('Copy Failed', 'Select some rows first');
            const csv = toCSV(rows);
            await copyText(csv);
            showMessage('Copy Success', 'Selected CSV copied to clipboard.');
        });
        $('btnClearResults').addEventListener('click', () => {
          resetResults();
          showMessage('Results Cleared', 'All search results have been cleared.');
        });

        function getSelected(){
            return Array.from(document.querySelectorAll('.sel:checked')).map(cb => VIEW[Number(cb.dataset.idx)]).filter(Boolean);
        }

        function toCSV(arr){
            const fields = ['channel','subs','videos','views','verified','channelId','country','createdAt'];
            let out = fields.map(f=>`"${f}"`).join(',')+'\n';
            arr.forEach(r => {
                out += `"${esc(r.title)}","${r.hidden?'Hidden':r.subs}","${r.videos}","${r.views}","${r.verified}","${r.channelId}","${esc(r.country)}","${r.createdAt}"\n`;
            });
            return out;
        }

        function downloadText(text, filename, type){
            const blob = new Blob([text], {type: type});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function cToSafe(c){
            return {
                channelId:c.channelId,
                title:c.title,
                subs:c.subs,
                views:c.views,
                videos:c.videos,
                verified:c.verified,
                country:c.country,
                createdAt:c.createdAt
            };
        }

        // Handle local storage for library
        $('btnSaveLib').addEventListener('click', () => {
            if(!LIB.length) return showMessage('Save Failed', 'No channels to save.');
            try {
                localStorage.setItem(savedLibraryKey, JSON.stringify(LIB));
                showMessage('Save Success', `Saved ${LIB.length} channels to local storage.`);
            } catch(e){
                showMessage('Save Failed', 'Failed to save library. Local storage might be full.');
            }
        });

        $('btnLoadLib').addEventListener('click', () => {
            const data = localStorage.getItem(savedLibraryKey);
            if(!data) return showMessage('Load Failed', 'No saved library found.');
            try{
                const loaded = JSON.parse(data);
                LIB = loaded;
                applyClientFiltersAndRender();
                showMessage('Load Success', `Loaded ${LIB.length} channels from local storage.`);
            } catch(e){
                showMessage('Load Failed', 'Failed to load library. Data may be corrupted.');
            }
        });
    </script>
</body>
</html>
