<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YouLead Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-0:#07080c;
            --bg-1:#0b0d14;
            --bg-2:#0f1320;
            --glass: rgba(255,255,255,.06);
            --glass-2: rgba(255,255,255,.08);
            --muted:#a6b0c3;
            --text:#f5f7ff;
            --accent:#7c3aed;
            --accent-2:#a78bfa;
            --ok:#22c55e;
            --warn:#f59e0b;
            --danger:#ef4444;
            --radius:14px;
            --radius-sm:10px;
            --shadow: 0 30px 70px rgba(0,0,0,.45);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-0);
            color: var(--text);
            transition: background-color 0.3s ease;
        }
        .glass-panel {
            background-color: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-2);
            box-shadow: var(--shadow);
            border-radius: var(--radius);
        }
        .btn-primary {
            background-color: var(--accent);
            color: var(--text);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        .btn-primary:hover {
            background-color: var(--accent-2);
            box-shadow: 0 6px 20px rgba(167, 139, 250, 0.6);
        }
        .btn-outline {
            border: 1px solid var(--accent);
            color: var(--accent);
            transition: all 0.3s ease;
        }
        .btn-outline:hover {
            background-color: var(--accent);
            color: var(--text);
        }
        .table-row-hover:hover {
            background-color: var(--glass-2);
        }
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 2rem;
            height: 2rem;
            cursor: pointer;
            z-index: 20;
        }
        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: var(--text);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .hamburger-icon.open span:nth-child(1) {
            transform: translateY(10px) rotate(45deg);
        }
        .hamburger-icon.open span:nth-child(2) {
            opacity: 0;
        }
        .hamburger-icon.open span:nth-child(3) {
            transform: translateY(-10px) rotate(-45deg);
        }
        .slide-in {
            transform: translateX(0);
        }
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
          animation: fade-in 0.5s ease-in-out forwards;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- Main Container -->
    <div id="main-container" class="w-full max-w-7xl flex flex-col md:flex-row gap-4 fade-in">
        
        <!-- Sidebar and Mobile Nav -->
        <nav id="sidebar" class="md:w-64 glass-panel p-6 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out fixed inset-y-0 left-0 z-10 w-3/4 max-w-xs overflow-y-auto">
            <div class="flex flex-col h-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-accent">YouLead</h2>
                    <div id="hamburger-close" class="md:hidden">
                        <div class="hamburger-icon open">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
                <div id="user-info" class="mb-6 flex flex-col items-center text-center">
                    <div class="w-16 h-16 rounded-full bg-gray-600 mb-2 flex items-center justify-center text-2xl font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <span id="user-email" class="font-semibold text-lg text-text">user@example.com</span>
                    <span id="user-id" class="text-xs text-muted">Loading UID...</span>
                    <span id="user-credits" class="text-sm font-semibold text-accent mt-2">Credits: 0</span>
                </div>
                <div class="flex-grow">
                    <ul class="space-y-2">
                        <li><a href="#" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition-colors" onclick="showDashboard('main')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            <span>Dashboard</span>
                        </a></li>
                        <li><a href="#" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition-colors" onclick="showDashboard('admin')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7c0 1.66-1.34 3-3 3a3 3 0 1 1 0-6c1.23 0 2.22-.97 2.3-2.22l.4-1.2A3 3 0 0 0 12 2zm0 0a3 3 0 0 0 3 3v7c0 1.66 1.34 3 3 3a3 3 0 1 1 0-6c-1.23 0-2.22-.97-2.3-2.22l-.4-1.2A3 3 0 0 0 12 2z"></path></svg>
                            <span>Admin Panel</span>
                        </a></li>
                    </ul>
                </div>
                <div>
                    <button id="logout-btn" class="w-full flex items-center justify-center space-x-3 p-3 rounded-lg btn-outline">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 md:ml-64 p-4 md:p-0">
            <!-- Mobile Hamburger Button -->
            <div id="hamburger-btn" class="md:hidden fixed top-4 right-4 z-20">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- Login and Signup Forms -->
            <div id="auth-container" class="w-full flex items-center justify-center min-h-screen">
                <div class="glass-panel p-8 w-full max-w-sm flex flex-col items-center">
                    <h1 id="auth-title" class="text-3xl font-bold mb-6 text-center text-text">Welcome</h1>
                    <form id="auth-form" class="w-full space-y-4">
                        <input id="email-field" type="email" placeholder="Email" class="w-full px-4 py-3 rounded-lg bg-gray-700/50 text-text placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-accent transition-colors" />
                        <input id="password-field" type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg bg-gray-700/50 text-text placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-accent transition-colors" />
                        <button id="auth-submit-btn" type="submit" class="w-full px-4 py-3 rounded-lg font-semibold btn-primary">Sign In</button>
                    </form>
                    <p id="auth-status" class="mt-4 text-sm text-center text-muted"></p>
                    <div class="mt-4 text-center text-sm text-muted">
                        <a href="#" id="auth-toggle-link" class="text-accent hover:underline">Need an account? Sign Up</a>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="w-full hidden">
                <!-- Main Dashboard Panel -->
                <div id="main-panel" class="glass-panel p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-panel p-6">
                            <h3 class="text-lg font-semibold text-muted">Credits Remaining</h3>
                            <p id="dashboard-credits" class="text-4xl font-bold text-accent mt-2">0</p>
                        </div>
                        <div class="glass-panel p-6">
                            <h3 class="text-lg font-semibold text-muted">Searches Today</h3>
                            <p id="searches-today" class="text-4xl font-bold text-ok mt-2">0</p>
                        </div>
                        <div class="glass-panel p-6">
                            <h3 class="text-lg font-semibold text-muted">Total Channels Found</h3>
                            <p id="total-channels-found" class="text-4xl font-bold text-warn mt-2">0</p>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4">Search YouTube Channels</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <input id="search-input" type="text" placeholder="Enter a niche or keyword..." class="flex-1 px-4 py-3 rounded-lg bg-gray-700/50 text-text placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-accent transition-colors" />
                            <button id="search-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold">Search (10 Credits)</button>
                        </div>
                        <div id="status-message" class="mt-4 text-sm text-center text-muted">Ready to search.</div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4">Search Results</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="text-left text-muted text-sm">
                                        <th class="py-2 px-4 font-normal">Channel</th>
                                        <th class="py-2 px-4 font-normal">Subscribers</th>
                                        <th class="py-2 px-4 font-normal">Country</th>
                                        <th class="py-2 px-4 font-normal">Socials</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body">
                                    <!-- Results will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="admin-panel" class="glass-panel p-6 hidden">
                    <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel p-6">
                            <h3 class="text-lg font-semibold text-muted">Reset All User Credits</h3>
                            <p class="text-sm text-muted mt-2">This will set all user credits back to 100.</p>
                            <button id="reset-credits-btn" class="w-full btn-primary px-4 py-3 rounded-lg font-semibold mt-4">
                                Reset Credits
                            </button>
                        </div>
                        <div class="glass-panel p-6">
                            <h3 class="text-lg font-semibold text-muted">View All Users</h3>
                            <p class="text-sm text-muted mt-2">A list of all users and their credits.</p>
                            <button id="view-users-btn" class="w-full btn-primary px-4 py-3 rounded-lg font-semibold mt-4">
                                Coming Soon
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Alerts -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="glass-panel p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-sm text-muted mb-6"></p>
            <button id="modal-close-btn" class="w-full btn-primary px-4 py-3 rounded-lg font-semibold">OK</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        import { initializeAppCheck, ReCaptchaV3Provider, getAppCheck } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, functions, isAuthReady = false, isAdmin = false;

        const ADMIN_UID = 'DhD6XzfVq2fEJSvrHvws2KTKZlu1'; // Your admin UID

        // UI Elements
        const authContainer = document.getElementById('auth-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authStatus = document.getElementById('auth-status');
        const userEmailSpan = document.getElementById('user-email');
        const userIdSpan = document.getElementById('user-id');
        const userCreditsSpan = document.getElementById('user-credits');
        const logoutBtn = document.getElementById('logout-btn');
        const dashboardCreditsP = document.getElementById('dashboard-credits');
        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-input');
        const statusMessage = document.getElementById('status-message');
        const resultsTableBody = document.getElementById('results-table-body');
        const mainPanel = document.getElementById('main-panel');
        const adminPanel = document.getElementById('admin-panel');
        const resetCreditsBtn = document.getElementById('reset-credits-btn');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const hamburgerCloseBtn = document.getElementById('hamburger-close');
        const sidebar = document.getElementById('sidebar');

        let isLogin = true;

        // Modal Elements
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        function showModal(title, message) {
            modalTitle.innerText = title;
            modalMessage.innerText = message;
            modal.classList.remove('hidden');
        }

        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Function to show the correct dashboard panel
        function showDashboard(panel) {
            if (panel === 'main') {
                mainPanel.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            } else if (panel === 'admin' && isAdmin) {
                adminPanel.classList.remove('hidden');
                mainPanel.classList.add('hidden');
            }
            if (window.innerWidth < 768) { // Close sidebar on mobile
                sidebar.classList.remove('slide-in');
                hamburgerBtn.querySelector('.hamburger-icon').classList.remove('open');
            }
        }

        // Hamburger menu functionality
        hamburgerBtn.addEventListener('click', () => {
            sidebar.classList.add('slide-in');
            hamburgerBtn.querySelector('.hamburger-icon').classList.add('open');
        });
        hamburgerCloseBtn.addEventListener('click', () => {
            sidebar.classList.remove('slide-in');
            hamburgerBtn.querySelector('.hamburger-icon').classList.remove('open');
        });

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            functions = getFunctions(app, 'europe-west1'); // Or your region
        
            // Initialize App Check with your reCAPTCHA v3 site key
            initializeAppCheck({
                app,
                provider: new ReCaptchaV3Provider('6Lel-r0rAAAAAMduulP0BxuuqXu4O_-IG4uoJDdR'),
                is
            });
        
            getAppCheck(app).onTokenChanged(async (tokenResult) => {
              if (tokenResult.token !== undefined) {
                appCheckToken = tokenResult.token;
              }
            });
            
        } catch (error) {
            console.error("Firebase initialization error: ", error);
            showModal("Initialization Error", "Failed to initialize Firebase. Check console for details.");
        }

        // Handle authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                isAuthReady = true;
                authContainer.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                
                userEmailSpan.innerText = user.email;
                userIdSpan.innerText = `UID: ${user.uid}`;
                
                // Check if user is admin
                isAdmin = user.uid === ADMIN_UID;
                if (isAdmin) {
                    document.querySelector('a[onclick="showDashboard(\'admin\')"]').classList.remove('hidden');
                } else {
                    document.querySelector('a[onclick="showDashboard(\'admin\')"]').classList.add('hidden');
                }
                
                // Set up real-time listener for user credits
                onSnapshot(doc(db, 'users', user.uid), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        const credits = data.credits || 0;
                        userCreditsSpan.innerText = `Credits: ${credits}`;
                        dashboardCreditsP.innerText = credits;
                    } else {
                        // Create a new user document if it doesn't exist
                        setDoc(doc(db, 'users', user.uid), { credits: 100 });
                        userCreditsSpan.innerText = `Credits: 100`;
                        dashboardCreditsP.innerText = '100';
                    }
                });

            } else {
                isAuthReady = true;
                authContainer.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
            }
        });

        // Auto-sign in with custom token
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(err => {
                console.error("Custom token sign-in failed:", err);
                showModal("Sign-in Failed", "Automatic sign-in failed. Please use the form below.");
            });
        }

        // Login/Signup form submission
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-field').value;
            const password = document.getElementById('password-field').value;
            
            authSubmitBtn.disabled = true;
            authStatus.innerText = 'Processing...';

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                authStatus.innerText = '';
            } catch (error) {
                console.error("Auth Error:", error);
                if (isLogin) {
                    authStatus.innerText = 'Sign in failed. Invalid email or password.';
                } else {
                    authStatus.innerText = 'Sign up failed. Please try a different email or a stronger password.';
                }
            } finally {
                authSubmitBtn.disabled = false;
            }
        });

        // Toggle between login and signup
        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            authTitle.innerText = isLogin ? 'Sign In' : 'Sign Up';
            authSubmitBtn.innerText = isLogin ? 'Sign In' : 'Sign Up';
            authToggleLink.innerText = isLogin ? 'Need an account? Sign Up' : 'Already have an account? Sign In';
            authStatus.innerText = '';
        });

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showModal("Logged Out", "You have been successfully logged out.");
        });

        // Search button functionality
        searchBtn.addEventListener('click', async () => {
            if (!auth.currentUser) {
                showModal("Access Denied", "Please sign in to perform a search.");
                return;
            }

            const query = searchInput.value;
            if (query.trim() === '') {
                showModal("Invalid Input", "Please enter a search query.");
                return;
            }

            statusMessage.innerText = 'Searching...';
            searchBtn.disabled = true;

            const deductCredits = httpsCallable(functions, 'deductCredits');
            const getChannels = httpsCallable(functions, 'getYouTubeChannels'); // You will need to create this function yourself

            try {
                // First, deduct credits
                const deductResponse = await deductCredits({ deduction: 10, appCheckToken });
                console.log('Credits deducted:', deductResponse.data.credits);

                // Then, perform the search (this part is not implemented yet)
                // const searchResponse = await getChannels({ query, appCheckToken });
                // console.log('Search results:', searchResponse.data);

                statusMessage.innerText = 'Search successful. Credits deducted.';
                showModal("Search Successful", "Credits have been deducted. The search function is a placeholder and needs to be implemented in your backend.");

            } catch (error) {
                console.error("Search Error:", error);
                const errorMessage = error.message || 'An unknown error occurred.';
                statusMessage.innerText = `Search failed: ${errorMessage}`;
                showModal("Search Failed", errorMessage);
            } finally {
                searchBtn.disabled = false;
            }
        });

        // Admin Reset Credits functionality
        resetCreditsBtn.addEventListener('click', async () => {
            if (!isAdmin) {
                showModal("Permission Denied", "You do not have permission to perform this action.");
                return;
            }

            const resetCredits = httpsCallable(functions, 'adminResetCredits');
            resetCreditsBtn.disabled = true;

            try {
                const response = await resetCredits({ appCheckToken });
                showModal("Success", response.data.message);
            } catch (error) {
                console.error("Admin Error:", error);
                const errorMessage = error.message || 'An unknown error occurred.';
                showModal("Admin Action Failed", errorMessage);
            } finally {
                resetCreditsBtn.disabled = false;
            }
        });

    </script>
</body>
</html>
