<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Lead Studio Pro — YouTube Channel Finder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* =========================
           GLOBAL STYLES
           ========================= */
        :root {
            --bg-primary: #0A0A0E;
            --bg-secondary: #1C1C21;
            --panel-bg: rgba(255, 255, 255, 0.05);
            --panel-border: rgba(255, 255, 255, 0.1);
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --accent-purple: #8B5CF6; /* New vibrant purple */
            --accent-purple-light: #A78BFA;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --panel-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --transition-duration: 0.2s;
        }

        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        a { color: var(--accent-purple-light); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .app-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            gap: 24px;
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
        }

        /* =========================
           HEADER
           ========================= */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            padding: 20px 30px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            box-shadow: var(--panel-shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .app-logo h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }

        .app-logo p {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
        }

        /* =========================
           FORM INPUTS & BUTTONS
           ========================= */
        input[type="text"], input[type="number"], input[type="email"], input[type="password"], textarea, select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--panel-border);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: var(--border-radius-sm);
            font-size: 15px;
            outline: none;
            transition: border-color var(--transition-duration), box-shadow var(--transition-duration);
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25);
        }
        
        textarea {
            min-height: 50px;
            flex-grow: 1;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform var(--transition-duration), box-shadow var(--transition-duration);
        }

        .btn-primary {
            background-color: var(--accent-purple);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .btn-primary:hover {
            background-color: #9f7aea;
        }

        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--panel-border);
        }
        .btn-secondary:hover {
            border-color: var(--accent-purple);
        }

        .btn-danger {
            background-color: var(--accent-red);
            color: white;
        }

        .btn:active {
            transform: scale(0.98);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }

        /* =========================
           MAIN LAYOUT
           ========================= */
        .main-content {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 1fr;
            gap: 24px;
            min-height: 0;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            box-shadow: var(--panel-shadow);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 0;
            overflow: hidden;
        }
        
        /* =========================
           LEFT FILTERS PANEL
           ========================= */
        .filters-panel {
            grid-column: 1;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .filters-grid select {
            width: 100%;
        }
        
        .filters-grid .full-span {
            grid-column: 1 / -1;
        }

        .range-inputs {
            display: flex;
            gap: 10px;
        }

        .range-inputs input {
            flex-grow: 1;
        }

        .progress-bar-container {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .progress-bar {
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 99px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--accent-purple);
            transition: width 0.3s ease;
        }
        
        .status-text {
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* =========================
           RIGHT RESULTS PANEL
           ========================= */
        .results-panel {
            grid-column: 2;
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 20px;
            min-height: 0;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .results-actions {
            display: flex;
            gap: 10px;
        }
        
        .results-table-container {
            overflow: auto;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th, .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--panel-border);
        }
        
        .results-table th {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: -24px;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        
        .results-table tbody tr:hover {
            background-color: rgba(139, 92, 246, 0.1);
            cursor: pointer;
        }
        
        .channel-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .channel-info img {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
        }
        
        .channel-info-text strong {
            display: block;
            font-weight: 600;
        }
        
        .channel-info-text span {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* =========================
           DETAILS PANEL
           ========================= */
        .details-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 0;
            overflow: hidden;
        }
        
        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .details-header h3 {
            margin: 0;
        }
        
        .banner-image {
            width: 100%;
            height: 180px;
            border-radius: var(--border-radius-sm);
            background-size: cover;
            background-position: center;
            display: none;
        }

        .channel-meta {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .channel-description {
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            text-align: center;
            border: 1px solid var(--panel-border);
        }
        
        .stat-card strong {
            font-size: 20px;
            display: block;
            margin-bottom: 5px;
        }
        
        .stat-card span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .social-links {
            display: flex;
            gap: 10px;
        }
        
        .social-link-btn {
            background-color: var(--bg-secondary);
            border: 1px solid var(--panel-border);
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .social-link-btn:hover {
            background-color: rgba(139, 92, 246, 0.1);
            color: white;
            border-color: var(--accent-purple);
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .video-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
            padding: 10px;
            border: 1px solid var(--panel-border);
        }
        
        .video-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .video-card h4 {
            margin: 10px 0 5px;
            font-size: 15px;
            font-weight: 600;
        }
        
        /* =========================
           AUTHENTICATION & MESSAGES
           ========================= */
        .auth-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--panel-shadow);
            display: none;
            flex-direction: column;
            gap: 20px;
            text-align: center;
            z-index: 50;
        }

        .auth-container h2 {
            margin: 0 0 10px;
        }
        
        .auth-container input {
            width: 100%;
        }

        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .message-box {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--panel-shadow);
            max-width: 450px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message-box h4 {
            margin: 0;
            font-size: 20px;
        }
        
        .message-box p {
            margin: 0;
            color: var(--text-secondary);
        }
        
        /* CUSTOM SWITCH */
        .switch {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 20px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3C3C43;
            transition: .4s;
            border-radius: 20px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--accent-purple);
        }
        
        input:checked + .slider:before {
            transform: translateX(18px);
        }

    </style>
</head>
<body>
    <div id="auth-view" class="auth-container">
        <h2>Welcome to Lead Studio Pro</h2>
        <input id="authEmail" type="email" placeholder="Email" autocomplete="username">
        <input id="authPass" type="password" placeholder="Password" autocomplete="current-password">
        <div class="button-group">
          <button class="btn btn-primary" id="btnSignIn">Sign In</button>
          <button class="btn btn-secondary" id="btnSignUp">Sign Up</button>
        </div>
        <div id="authStatus" class="meta" style="text-align: center;"></div>
    </div>

    <div id="app-view" class="app-container" style="display:none">
        <header class="app-header">
            <div class="header-left">
                <div class="app-logo">
                    <h1>Lead Studio Pro</h1>
                    <p>Advanced YouTube Channel Finder</p>
                </div>
                <div id="status" class="channel-meta" style="margin-left: 20px;">Idle</div>
            </div>
            
            <div class="header-controls">
                <input id="apiKey" type="text" placeholder="YouTube API Key" value="AIzaSyBo5wWMC5T5lemycWNqtfs2_SAjApsLuFA"/>
                <button class="btn btn-secondary" id="btnSignOut">Sign Out</button>
            </div>
        </header>

        <main class="main-content">
            <aside class="panel filters-panel">
                <h3>Search Filters</h3>
                <textarea id="query" placeholder="Enter one or more queries (comma or newline separated)"></textarea>
                <div class="button-group full-span">
                    <button class="btn btn-primary" id="btnSearch">Search</button>
                    <button class="btn btn-primary" id="btnDeepSearch">Deep Search</button>
                    <button class="btn btn-secondary" id="btnClear">Clear</button>
                </div>
                
                <div class="filters-grid">
                    <select id="order">
                        <option value="relevance">Order: Relevance</option>
                        <option value="date">Order: Date</option>
                        <option value="viewCount">Order: Views</option>
                        <option value="rating">Order: Rating</option>
                    </select>
                    <select id="duration">
                        <option value="">Duration: Any</option>
                        <option value="short">Short (&lt;4m)</option>
                        <option value="medium">Medium (4–20m)</option>
                        <option value="long">Long (&gt;20m)</option>
                    </select>
                    <select id="upload">
                        <option value="">Upload Time: Any</option>
                        <option value="hour">Last hour</option>
                        <option value="today">Today</option>
                        <option value="week">This week</option>
                        <option value="month">This month</option>
                    </select>
                    <select id="region">
                        <option value="">Region: Any</option>
                        <option>US</option>
                        <option>IN</option>
                        <option>GB</option>
                        <option>CA</option>
                        <option>AU</option>
                        <option>DE</option>
                    </select>
                    <select id="definition">
                        <option value="">Definition: Any</option>
                        <option value="high">HD</option>
                        <option value="standard">SD</option>
                    </select>
                    <select id="safe">
                        <option value="">Safe: Any</option>
                        <option value="none">None</option>
                        <option value="moderate">Moderate</option>
                        <option value="strict">Strict</option>
                    </select>
                    <input class="full-span" id="perPage" type="number" min="1" max="50" value="25" placeholder="Results per page (1–50)"/>
                    <input class="full-span" id="pages" type="number" min="1" max="10" value="2" placeholder="Pages per query (1–10)"/>
                    <div class="full-span range-inputs">
                        <input id="minSubs" type="number" placeholder="Min subs"/>
                        <input id="maxSubs" type="number" placeholder="Max subs"/>
                    </div>
                    <input class="full-span" id="searchInResults" type="text" placeholder="Search within results (title / ID)"/>
                    <div class="full-span">
                        <input id="corsProxy" type="url" placeholder="Optional CORS proxy for verification"/>
                    </div>
                    <div class="full-span" style="display:flex; justify-content: space-between; align-items: center;">
                        <span class="channel-meta">Attempt verify check</span>
                        <label class="switch">
                            <input id="doVerify" type="checkbox"/>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressBar"></div>
                    </div>
                    <div class="status-text">
                        <span>Progress</span>
                        <span id="count">0 channels</span>
                    </div>
                </div>
            </aside>

            <section class="results-panel">
                <div class="results-header">
                    <h2>Search Results</h2>
                    <div class="results-actions">
                        <select id="clientSort">
                            <option value="subs-desc">Sort: Subs ↓</option>
                            <option value="subs-asc">Sort: Subs ↑</option>
                            <option value="views-desc">Sort: Views ↓</option>
                            <option value="views-asc">Sort: Views ↑</option>
                            <option value="title-asc">Sort: Title A→Z</option>
                            <option value="title-desc">Sort: Title Z→A</option>
                        </select>
                        <button class="btn btn-secondary" id="btnSelectAll">Select All</button>
                        <button class="btn btn-secondary" id="btnDeselectAll">Deselect</button>
                        <button class="btn btn-secondary" id="btnSaveLib">Save Library</button>
                        <button class="btn btn-secondary" id="btnLoadLib">Load Library</button>
                        <button class="btn btn-primary" id="btnExportCSV">Export CSV</button>
                        <button class="btn btn-secondary" id="btnExportJSON">Export JSON</button>
                        <button class="btn btn-secondary" id="btnCopyIDs">Copy IDs</button>
                        <button class="btn btn-danger" id="btnClearResults">Clear Results</button>
                    </div>
                </div>
                <div class="results-table-container" id="resultsScroller">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Channel</th>
                                <th>Subs</th>
                                <th>Videos</th>
                                <th>Views</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTbody"></tbody>
                    </table>
                </div>
            </section>
        </main>
        
        <aside class="panel details-panel">
            <div class="details-header">
                <h3 id="detailTitle">Select a channel</h3>
                <div class="button-group">
                    <button class="btn btn-primary" id="btnExportSelected">Export Selected</button>
                    <button class="btn btn-secondary" id="btnCopySelected">Copy Selected CSV</button>
                </div>
            </div>
            
            <div id="banner" class="banner-image"></div>
            
            <div id="detailContent" style="overflow-y: auto;">
                <p class="channel-meta">No channel selected. Click a channel from the search results to see details here.</p>
            </div>
        </aside>

        <div id="user-footer" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; padding: 10px; text-align: right; background: rgba(0,0,0,0.5);">
            <span id="userEmail" class="channel-meta"></span>
        </div>
    </div>
    
    <div id="messageBoxOverlay" class="message-box-overlay">
        <div id="messageBox" class="message-box">
            <h4 id="messageTitle"></h4>
            <p id="messageText"></p>
            <button class="btn btn-primary" id="messageBoxOk">OK</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";
        
        /* =========================
           STATE + HELPERS
           ========================= */
        const $ = id => document.getElementById(id);
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const esc = s => String(s ?? '').replace(/"/g,'""');

        const savedLibraryKey = 'lead_studio_pro_lib_v1';
        let currentUser = null;
        
        function setStatus(t){ $('status').innerText = t; }
        function setProgress(p){ $('progressBar').style.width = Math.min(100, Math.round(p*100)) + '%'; }

        let LIB = []; // enriched channels
        let VIEW = []; // filtered/sorted view
        let lastExport = [];
        let lastSearch = {};
        
        // Custom message box to replace alert()
        function showMessage(title, message) {
            $('messageTitle').innerText = title;
            $('messageText').innerText = message;
            
            const messageBox = $('messageBox');
            // Remove any existing dynamic buttons
            const dynamicButtons = messageBox.querySelectorAll('.btn:not(#messageBoxOk)');
            dynamicButtons.forEach(btn => btn.remove());
            $('messageBoxOk').style.display = 'block';

            $('messageBoxOverlay').style.display = 'flex';
        }
        $('messageBoxOk').addEventListener('click', () => {
            $('messageBoxOverlay').style.display = 'none';
        });

        // === FIREBASE CONFIGURATION ===
        const firebaseConfig = {
          apiKey: "AIzaSyBvU3_Njbi1JQr_wD1a16h5coTW2ifaRDU",
          authDomain: "youleadmax.firebaseapp.com",
          projectId: "youleadmax",
          storageBucket: "youleadmax.firebasestorage.app",
          messagingSenderId: "710806971072",
          appId: "1:710806971072:web:ced903befe8693f886c325",
          measurementId: "G-JW9W20C1LQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const logSearchCallable = httpsCallable(functions, 'logSearch');

        /* ========================= AUTHENTICATION ========================= */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('app-view').style.display = 'flex';
                $('auth-view').style.display = 'none';
                $('userEmail').innerText = `Logged in as: ${user.email}`;

                // Log user usage for tracking purposes
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, {
                    lastLogin: new Date().toISOString()
                }, { merge: true });

            } else {
                currentUser = null;
                $('app-view').style.display = 'none';
                $('auth-view').style.display = 'flex';
            }
        });

        $('btnSignIn').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                $('authStatus').innerText = 'Sign-in failed: ' + error.message;
            }
        });

        $('btnSignUp').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                $('authStatus').innerText = 'Sign-up failed: ' + error.message;
            }
        });

        $('btnSignOut').addEventListener('click', async () => {
            await signOut(auth);
            resetResults();
        });

        /* ========================= SEARCH / FETCH ========================= */
        $('btnSearch').addEventListener('click', () => searchAll(false));
        $('btnDeepSearch').addEventListener('click', () => {
          const queryRaw = $('query').value.trim();
          if (!queryRaw.length) {
            showMessage('Search Error', 'Please enter at least one query');
            return;
          }
          
          if (!currentUser) {
            showMessage('Authentication Required', 'Please sign in first.');
            return;
          }
          
          // Display a confirmation message box
          $('messageTitle').innerText = 'Deep Search Confirmation';
          $('messageText').innerText = 'Deep Search will consume more API credits by searching more pages. Do you want to continue?';
          
          const messageBox = $('messageBox');
          const oldOkBtn = $('messageBoxOk');
          
          const confirmButton = document.createElement('button');
          confirmButton.className = 'btn btn-primary';
          confirmButton.innerText = 'Yes, Continue';
          confirmButton.addEventListener('click', () => {
            $('messageBoxOverlay').style.display = 'none';
            searchAll(true);
          });
          
          const cancelButton = document.createElement('button');
          cancelButton.className = 'btn btn-secondary';
          cancelButton.innerText = 'Cancel';
          cancelButton.addEventListener('click', () => {
            $('messageBoxOverlay').style.display = 'none';
          });
          
          oldOkBtn.style.display = 'none';
          messageBox.appendChild(confirmButton);
          messageBox.appendChild(cancelButton);
          $('messageBoxOverlay').style.display = 'flex';
        });
        
        $('btnClear').addEventListener('click', () => { $('query').value=''; resetResults(); });
        $('query').addEventListener('keydown', e => { if(e.key==='Enter') searchAll(); });

        async function searchAll(isDeepSearch = false){
            const queryRaw = $('query').value.trim();
            const queries = queryRaw.split(/[,\\n]/).map(q=>q.trim()).filter(Boolean);
            const perPage = clamp(Number($('perPage').value||25), 1, 50);
            const pages = isDeepSearch ? 20 : clamp(Number($('pages').value||2), 1, 10);

            if(!queries.length){ showMessage('Search Error', 'Please enter at least one query'); return; }
            if(!currentUser){ showMessage('Authentication Required', 'Please sign in first.'); return; }

            // Call the logSearch Cloud Function to record the search action
            try {
              // The CORS issue means we need to handle the error, but the app should still work.
              // We will continue the search process even if logging fails.
              await logSearchCallable({ query: queryRaw });
            } catch (error) {
              console.error('Failed to log search:', error);
            }

            resetResults();
            lastSearch = { queryRaw, queries, perPage, pages };
            
            setStatus('Searching for channels...');
            const apiKey = $('apiKey').value.trim();
            const order = $('order').value;
            const duration = $('duration').value;
            const upload = $('upload').value;
            const region = $('region').value;
            const definition = $('definition').value;
            const safe = $('safe').value;
            let totalSteps = queries.length * pages;
            let done = 0;
            let chanIds = new Set();
            
            for(const q of queries){
                let pageToken = '';
                for(let i=0;i<pages;i++){
                    if(!pageToken && i>0) break;
                    
                    const url = new URL('https://www.googleapis.com/youtube/v3/search');
                    url.searchParams.set('part','snippet');
                    url.searchParams.set('type','video');
                    url.searchParams.set('q', q);
                    url.searchParams.set('maxResults', String(perPage));
                    url.searchParams.set('order', order);
                    if(region) url.searchParams.set('regionCode', region);
                    if(duration) url.searchParams.set('videoDuration', duration);
                    if(definition) url.searchParams.set('videoDefinition', definition);
                    if(upload) url.searchParams.set('publishedAfter', getPublishedAfterISO(upload));
                    if(pageToken) url.searchParams.set('pageToken', pageToken);
                    url.searchParams.set('key', apiKey);
                    
                    let resp;
                    try { resp = await fetch(url.toString()); }
                    catch(e){ console.error(e); showMessage('Network Error', 'A network error occurred during the search. Please check your connection.'); return; }
                    
                    if(!resp.ok){
                        const t = await resp.text();
                        showMessage('Search API Error', `YouTube API returned an error: ${resp.status}\n${t}`);
                        return;
                    }
                    
                    const data = await resp.json();
                    
                    (data.items || []).forEach(item => {
                        // Shorts filtering (multi-heuristic)
                        const t = (item.snippet.title||'').toLowerCase();
                        const d = (item.snippet.description||'').toLowerCase();
                        if(t.includes('#shorts') || t.includes('shorts ') || t.endsWith('shorts') || d.includes('#shorts') || d.includes('shorts ')) return;
                        const cid = item.snippet.channelId;
                        if(cid) chanIds.add(cid);
                    });
                    
                    pageToken = data.nextPageToken || '';
                    done++;
                    setProgress(done/totalSteps * 0.65);
                    await sleep(180);
                }
            }
            
            if(chanIds.size===0){ setStatus('No channels found'); setProgress(1); return; }
            
            setStatus(`Found ${chanIds.size} channels — fetching details…`);
            
            // fetch channels in batches of 50
            const ids = Array.from(chanIds);
            for(let i=0;i<ids.length;i+=50){
                const batch = ids.slice(i,i+50);
                const chURL = new URL('https://www.googleapis.com/youtube/v3/channels');
                chURL.searchParams.set('part','snippet,statistics,brandingSettings');
                chURL.searchParams.set('id', batch.join(','));
                chURL.searchParams.set('key', apiKey);
                
                let resp;
                try { resp = await fetch(chURL.toString()); }
                catch(e){ console.error(e); showMessage('Network Error', 'A network error occurred while fetching channel details.'); return; }
                
                if(!resp.ok){
                    const t = await resp.text();
                    showMessage('Channels API Error', `YouTube API returned an error: ${resp.status}\n${t}`);
                    return;
                }
                
                const data = await resp.json();
                
                (data.items||[]).forEach(ch => {
                    if(!ch.snippet || !ch.snippet.title) return; // junk
                    const stats = ch.statistics || {};
                    const title = ch.snippet.title;
                    
                    let country = ch.snippet.country || '';
                    if(!country && ch.brandingSettings?.channel?.country){
                        country = ch.brandingSettings.channel.country;
                    }
                    
                    LIB.push({
                        title: title,
                        description: ch.snippet.description,
                        channelId: ch.id,
                        subs: Number(stats.subscriberCount||0),
                        views: Number(stats.viewCount||0),
                        videos: Number(stats.videoCount||0),
                        verified: (ch.snippet.customUrl||'').includes('channel') ? 'No' : 'Yes',
                        avatar: ch.snippet.thumbnails?.high?.url || ch.snippet.thumbnails?.default?.url || '',
                        banner: ch.brandingSettings?.image?.bannerExternalUrl || '',
                        country: country,
                        createdAt: ch.snippet.publishedAt.split('T')[0]
                    });
                    
                    done++;
                    setProgress(0.65 + (done/totalSteps * 0.35));
                });
                await sleep(180);
            }

            if(LIB.length===0){
                setStatus('No channels found');
            } else {
                applyClientFiltersAndRender();
                setStatus(`Found ${LIB.length} channels.`);
            }
            setProgress(1);
        }

        function getPublishedAfterISO(timeframe){
            const d = new Date();
            if(timeframe==='hour') d.setHours(d.getHours() - 1);
            if(timeframe==='today') d.setDate(d.getDate() - 1);
            if(timeframe==='week') d.setDate(d.getDate() - 7);
            if(timeframe==='month') d.setMonth(d.getMonth() - 1);
            return d.toISOString();
        }

        function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

        function applyClientFiltersAndRender(){
            const min = Number($('minSubs').value||0);
            const maxRaw = Number($('maxSubs').value||0);
            const max = maxRaw>0? maxRaw : Infinity;
            const needle = $('searchInResults').value.trim().toLowerCase();

            VIEW = LIB.filter(c => {
                if(c.subs < min) return false;
                if(c.subs > max) return false;
                if(needle){
                    const hit = (c.title?.toLowerCase().includes(needle)) || (c.channelId?.toLowerCase().includes(needle));
                    if(!hit) return false;
                }
                return true;
            });

            // client sort
            const sort = $('clientSort').value;
            VIEW.sort((a,b) => {
                if(sort==='subs-desc') return (b.subs||0) - (a.subs||0);
                if(sort==='subs-asc') return (a.subs||0) - (b.subs||0);
                if(sort==='views-desc')return (b.views||0) - (a.views||0);
                if(sort==='views-asc') return (a.views||0) - (b.views||0);
                if(sort==='title-asc') return (a.title||'').localeCompare(b.title||'');
                if(sort==='title-desc')return (b.title||'').localeCompare(a.title||'');
                return 0;
            });

            renderResults(VIEW);
            lastExport = VIEW.slice();
            $('count').innerText = VIEW.length + ' channels';
        }

        /* ========================= RENDER RESULTS + DETAILS ========================= */
        $('clientSort').addEventListener('change', applyClientFiltersAndRender);
        $('minSubs').addEventListener('input', applyClientFiltersAndRender);
        $('maxSubs').addEventListener('input', applyClientFiltersAndRender);
        $('searchInResults').addEventListener('input', applyClientFiltersAndRender);

        function renderResults(list){
            const tbody = $('resultsTbody');
            tbody.innerHTML = '';
            if(!list.length){
                tbody.innerHTML = `<tr><td colspan="6" class="channel-meta" style="text-align: center;">No channels match your filters.</td></tr>`;
                return;
            }
            list.forEach((c, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="sel" data-idx="${idx}"/></td>
                    <td>
                        <div class="channel-info">
                            <img src="${sanitize(c.avatar)}" alt="">
                            <div class="channel-info-text">
                                <strong>${sanitize(c.title)}</strong>
                                <span>${sanitize(c.channelId)}</span>
                            </div>
                        </div>
                    </td>
                    <td>${c.hidden ? 'Hidden' : (c.subs||0).toLocaleString()}</td>
                    <td>${(c.videos||0).toLocaleString()}</td>
                    <td>${(c.views||0).toLocaleString()}</td>
                    <td>${c.verified}</td>
                `;
                tr.addEventListener('click', e => {
                    if(e.target.type !== 'checkbox'){
                        renderDetails(c);
                    }
                });
                tbody.appendChild(tr);
            });
        }
        
        async function renderDetails(c){
            $('detailTitle').innerText = c.title;
            const socialLinks = await getSocialLinksFromAboutPage(c.channelId);

            $('detailContent').innerHTML = `
                <p class="channel-meta">Channel ID: ${c.channelId} • ${c.country} • Created: ${c.createdAt}</p>
                <p class="channel-description">${sanitize(c.description)}</p>
                <div class="stats-grid">
                    <div class="stat-card"><strong>${c.subs.toLocaleString()}</strong><span>Subscribers</span></div>
                    <div class="stat-card"><strong>${c.views.toLocaleString()}</strong><span>Total Views</span></div>
                    <div class="stat-card"><strong>${c.videos.toLocaleString()}</strong><span>Total Videos</span></div>
                </div>
                
                <h4 style="margin:20px 0 8px">Social Links</h4>
                <div class="social-links">
                    ${socialLinks.website?`<a href="${sanitize(socialLinks.website)}" target="_blank" class="social-link-btn">Website</a>`:''}
                    ${socialLinks.twitter?`<a href="${sanitize(socialLinks.twitter)}" target="_blank" class="social-link-btn">Twitter</a>`:''}
                    ${socialLinks.instagram?`<a href="${sanitize(socialLinks.instagram)}" target="_blank" class="social-link-btn">Instagram</a>`:''}
                    ${socialLinks.facebook?`<a href="${sanitize(socialLinks.facebook)}" target="_blank" class="social-link-btn">Facebook</a>`:''}
                    ${socialLinks.tiktok?`<a href="${sanitize(socialLinks.tiktok)}" target="_blank" class="social-link-btn">TikTok</a>`:''}
                    ${socialLinks.linkedin?`<a href="${sanitize(socialLinks.linkedin)}" target="_blank" class="social-link-btn">LinkedIn</a>`:''}
                </div>
                
                <h4 style="margin:20px 0 8px">Latest Videos <span class="channel-meta">(up to 6)</span></h4>
                <div class="video-grid" id="latestVideos">
                    <p class="channel-meta">Loading...</p>
                </div>
            `;
            if(c.banner){
                $('banner').style.display = 'block';
                $('banner').style.backgroundImage = `url(${sanitize(c.banner)})`;
            } else {
                $('banner').style.display = 'none';
            }
            
            loadLatestVideos(c.channelId);
        }

        /* ========================= UTIL ========================= */
        function resetResults(){
            LIB = []; VIEW = []; lastExport = [];
            $('resultsTbody').innerHTML='<tr><td colspan="6" class="channel-meta" style="text-align: center;">No channels match your filters.</td></tr>'; 
            $('count').innerText='0 channels';
            $('detailTitle').innerText = 'Select a channel';
            $('detailContent').innerHTML = '<p class="channel-meta">No channel selected. Click a channel from the search results to see details here.</p>';
            $('banner').style.display='none'; $('banner').style.backgroundImage='none';
            setProgress(0); setStatus('Idle');
        }

        function sanitize(s){ try{ return s.replace(/</g,'<'); } catch(e){return '';} }

        async function loadLatestVideos(channelId){
            const apiKey = $('apiKey').value.trim();
            const box = $('latestVideos');
            try{
                const u = new URL('https://www.googleapis.com/youtube/v3/search');
                u.searchParams.set('part','snippet');
                u.searchParams.set('channelId', channelId);
                u.searchParams.set('order','date');
                u.searchParams.set('maxResults','6');
                u.searchParams.set('type','video');
                u.searchParams.set('key', apiKey);
                const r = await fetch(u.toString());
                if(!r.ok){
                    box.innerHTML = '<p class="channel-meta">Cannot load videos.</p>';
                    return;
                }
                const data = await r.json();
                if(!data.items?.length){
                    box.innerHTML = '<p class="channel-meta">No recent videos.</p>';
                    return;
                }
                box.innerHTML='';
                data.items.forEach(it => {
                    const vid = it.id.videoId;
                    const thumb = it.snippet.thumbnails?.medium?.url || it.snippet.thumbnails?.default?.url || '';
                    const title = it.snippet.title || '';
                    const card = document.createElement('div');
                    card.className = 'video-card';
                    card.innerHTML = `
                        <img src="${sanitize(thumb)}" alt="">
                        <h4>${sanitize(title)}</h4>
                        <div class="button-group" style="margin-top:6px">
                            <button class="btn btn-primary" onclick="window.open('https://www.youtube.com/watch?v=${vid}')">Open</button>
                            <button class="btn btn-secondary" onclick="embed('${vid}')">Preview</button>
                        </div>
                    `;
                    box.appendChild(card);
                });
            }catch(e){
                console.error(e);
                box.innerHTML = '<p class="channel-meta">Error loading videos.</p>';
            }
        }
        
        function embed(videoId){
            // add/replace a small embed at bottom-right of results panel
            let frame = document.getElementById('previewFrame');
            if(frame){ frame.remove(); }
            frame = document.createElement('iframe');
            frame.id='previewFrame';
            frame.width='100%';
            frame.height='220px';
            frame.style.marginTop='10px';
            frame.src=`https://www.youtube.com/embed/${videoId}?autoplay=1`;
            frame.setAttribute('allow','accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture');
            $('detailContent').appendChild(frame);
        }
        
        // Helper for copying text to clipboard
        async function copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch (err) {
                // Fallback for older browsers or restricted environments
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }

        /* ========================= EXPORTING ========================= */
        $('btnExportCSV').addEventListener('click', () => {
            const rows = lastExport;
            if(!rows.length) return showMessage('Export Failed', 'No results to export');
            downloadText(toCSV(rows), 'lead_studio_pro.csv', 'text/csv');
        });
        $('btnExportJSON').addEventListener('click', () => {
            const rows = lastExport.map(cToSafe);
            if(!rows.length) return showMessage('Export Failed', 'No results to export');
            downloadText(JSON.stringify(rows,null,2), 'lead_studio_pro.json', 'application/json');
        });
        $('btnCopyIDs').addEventListener('click', async () => {
            const rows = lastExport;
            if(!rows.length) return showMessage('Copy Failed', 'No results to copy');
            const ids = rows.map(r=>r.channelId).join('\n');
            await copyText(ids);
            showMessage('Copy Success', 'Channel IDs copied to clipboard.');
        });
        $('btnSelectAll').addEventListener('click', () => {
            document.querySelectorAll('.sel').forEach(cb => cb.checked=true);
        });
        $('btnDeselectAll').addEventListener('click', () => {
            document.querySelectorAll('.sel').forEach(cb => cb.checked=false);
        });
        $('btnExportSelected').addEventListener('click', () => {
            const rows = getSelected();
            if(!rows.length) return showMessage('Export Failed', 'Select some rows first');
            downloadText(toCSV(rows), 'lead_studio_pro_selected.csv', 'text/csv');
        });
        $('btnCopySelected').addEventListener('click', async () => {
            const rows = getSelected();
            if(!rows.length) return showMessage('Copy Failed', 'Select some rows first');
            const csv = toCSV(rows);
            await copyText(csv);
            showMessage('Copy Success', 'Selected CSV copied to clipboard.');
        });
        $('btnClearResults').addEventListener('click', () => {
          resetResults();
          showMessage('Results Cleared', 'All search results have been cleared.');
        });

        function getSelected(){
            return Array.from(document.querySelectorAll('.sel:checked')).map(cb => VIEW[Number(cb.dataset.idx)]).filter(Boolean);
        }

        function toCSV(arr){
            const fields = ['channel','subs','videos','views','verified','channelId','country','createdAt'];
            let out = fields.map(f=>`"${f}"`).join(',')+'\n';
            arr.forEach(r => {
                out += `"${esc(r.title)}","${r.hidden?'Hidden':r.subs}","${r.videos}","${r.views}","${r.verified}","${r.channelId}","${esc(r.country)}","${r.createdAt}"\n`;
            });
            return out;
        }

        function downloadText(text, filename, type){
            const blob = new Blob([text], {type: type});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function cToSafe(c){
            // strip big strings that might break inline JSON calls
            return {
                channelId:c.channelId,
                title:c.title,
                subs:c.subs,
                views:c.views,
                videos:c.videos,
                verified:c.verified,
                country:c.country,
                createdAt:c.createdAt
            };
        }

        // Handle local storage for library
        $('btnSaveLib').addEventListener('click', () => {
            if(!LIB.length) return showMessage('Save Failed', 'No channels to save.');
            try {
                localStorage.setItem(savedLibraryKey, JSON.stringify(LIB));
                showMessage('Save Success', `Saved ${LIB.length} channels to local storage.`);
            } catch(e){
                showMessage('Save Failed', 'Failed to save library. Local storage might be full.');
            }
        });

        $('btnLoadLib').addEventListener('click', () => {
            const data = localStorage.getItem(savedLibraryKey);
            if(!data) return showMessage('Load Failed', 'No saved library found.');
            try{
                const loaded = JSON.parse(data);
                LIB = loaded;
                applyClientFiltersAndRender();
                showMessage('Load Success', `Loaded ${LIB.length} channels from local storage.`);
            } catch(e){
                showMessage('Load Failed', 'Failed to load library. Data may be corrupted.');
            }
        });

        // Function to reliably retrieve social links from the channel's About page
        async function getSocialLinksFromAboutPage(channelId) {
            const proxyUrl = $('corsProxy').value || '';
            const aboutUrl = `${proxyUrl}https://www.youtube.com/channel/${channelId}/about`;
            
            try {
                const response = await fetch(aboutUrl);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const socialLinks = {};
                const linkElements = doc.querySelectorAll('.yt-formatted-string a');
                
                linkElements.forEach(link => {
                    const url = link.href;
                    if (url.includes('twitter.com')) socialLinks.twitter = url;
                    else if (url.includes('instagram.com')) socialLinks.instagram = url;
                    else if (url.includes('facebook.com')) socialLinks.facebook = url;
                    else if (url.includes('tiktok.com')) socialLinks.tiktok = url;
                    else if (url.includes('linkedin.com')) socialLinks.linkedin = url;
                    else if (!socialLinks.website) socialLinks.website = url;
                });
                
                return socialLinks;
            } catch (error) {
                console.error('Failed to retrieve social links:', error);
                return {};
            }
        }
    </script>
</body>
</html>
