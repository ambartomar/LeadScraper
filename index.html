<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Lead Studio Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-dark: #07090D;
            --panel-bg: rgba(255, 255, 255, 0.04);
            --border-color: rgba(255, 255, 255, 0.1);
            --purple-accent: #8b5cf6; /* Tailwind's purple-500 */
            --purple-hover: #7c3aed; /* Tailwind's purple-600 */
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 40%), radial-gradient(circle at 85% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 40%), var(--bg-dark);
        }
        .glass-panel {
            background-color: var(--panel-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
        }
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--purple-accent);
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--purple-hover);
        }
        .btn {
            position: relative;
            overflow: hidden;
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(1px);
        }
        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            animation: ripple 0.6s linear;
            transform: scale(0);
        }
        @keyframes ripple {
            to { transform: scale(2.5); opacity: 0; }
        }
        .skeleton {
            animation: skeleton-loading 1.5s infinite linear;
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
        }
        @keyframes skeleton-loading {
            from { background-position: -200px 0; }
            to { background-position: 200px 0; }
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stat-card-animation {
            animation: popIn 0.5s ease-out forwards;
            opacity: 0;
            transform: scale(0.9);
        }
        @keyframes popIn {
            to { opacity: 1; transform: scale(1); }
        }
        
        .recent-search-item {
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            transform: scale(1);
        }
        .recent-search-item:hover {
            background-color: rgba(255, 255, 255, 0.06);
            transform: scale(1.02);
        }
    </style>
</head>
<body class="flex">
    <!-- Main App Dashboard View -->
    <div id="app-view" class="h-full w-full flex" style="display: none;">
        <!-- Left Sidebar -->
        <aside class="glass-panel w-20 flex flex-col items-center py-6 mx-4 my-4 fade-in" style="animation-delay: 0.1s;">
            <div class="mb-8 p-3 bg-purple-600 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1-1 .45-1 1zm8-18c0-.55-.45-1-1-1s-1 .45-1 1 .45 1 1 1 1-.45 1-1zm-6 2c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1zm6 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1zm-4-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-3 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM9 2v4h4V2H9zm2 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                </svg>
            </div>
            <nav class="flex-1 flex flex-col gap-4">
                <div class="group relative cursor-pointer flex items-center justify-center p-3 rounded-xl hover:bg-white/10 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-400" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-1.6.53-3.08 1.4-4.28L19.43 18.6c-1.2.87-2.68 1.4-4.28 1.4-1.62 0-3.13-.53-4.32-1.47zM4.07 12c.49 3.95 3.85 7 7.93 7 1.6 0 3.08-.53 4.28-1.4L4.57 5.4c-.87 1.2-1.4 2.68-1.4 4.28 0 1.62.53 3.13 1.47 4.32z"/>
                    </svg>
                    <span class="absolute left-full ml-4 whitespace-nowrap px-3 py-1 bg-gray-700 text-sm text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200">Dashboard</span>
                </div>
                <div class="group relative cursor-pointer flex items-center justify-center p-3 rounded-xl hover:bg-white/10 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15c0 .55.45 1 1 1s1-.45 1-1V9c0-.55-.45-1-1-1s-1 .45-1 1v8zm-1-9c0-.55.45-1 1-1h1c.55 0 1 .45 1 1v1c0 .55-.45 1-1 1h-1c-.55 0-1-.45-1-1V8z"/>
                    </svg>
                    <span class="absolute left-full ml-4 whitespace-nowrap px-3 py-1 bg-gray-700 text-sm text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200">Analytics</span>
                </div>
            </nav>
            <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center text-sm font-semibold">
                <span id="initials"></span>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-auto p-4 flex flex-col">
            <!-- Top Bar -->
            <header class="h-16 flex items-center justify-between px-6 mb-4">
                <div class="flex items-center gap-4">
                    <h1 class="text-3xl font-bold text-white">Dashboard</h1>
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span id="status">Online</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="userEmail" class="text-sm text-gray-400"></span>
                    <button class="btn bg-gray-700 text-gray-200 px-4 py-2 rounded-xl text-sm font-medium hover:bg-gray-600" id="btnSignOut">Sign Out</button>
                </div>
            </header>

            <!-- Main Content Grid -->
            <div class="flex-1 grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- Left Sidebar of Main Content (Search, filters, history) -->
                <div class="col-span-1 md:col-span-2 flex flex-col gap-4">
                    <!-- Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="card-total" class="glass-panel p-4 flex flex-col items-center justify-center text-center stat-card-animation" style="animation-delay: 0.4s;">
                            <span class="text-xs text-gray-400 font-medium">Channels Found</span>
                            <span id="metric-channels" class="text-2xl font-bold text-white mt-1 skeleton-text">0</span>
                        </div>
                        <div id="card-subs" class="glass-panel p-4 flex flex-col items-center justify-center text-center stat-card-animation" style="animation-delay: 0.5s;">
                            <span class="text-xs text-gray-400 font-medium">Total Subscribers</span>
                            <span id="metric-subs" class="text-2xl font-bold text-white mt-1 skeleton-text">0</span>
                        </div>
                        <div id="card-videos" class="glass-panel p-4 flex flex-col items-center justify-center text-center stat-card-animation" style="animation-delay: 0.6s;">
                            <span class="text-xs text-gray-400 font-medium">Total Videos</span>
                            <span id="metric-videos" class="text-2xl font-bold text-white mt-1 skeleton-text">0</span>
                        </div>
                    </div>
                    
                    <!-- Search & Filters Panel -->
                    <div class="glass-panel p-6 flex flex-col gap-4 fade-in" style="animation-delay: 0.2s;">
                        <h2 class="text-xl font-bold">Search Filters</h2>
                        <textarea id="query" placeholder="Enter one or more queries (comma or newline separated)" class="w-full bg-white/5 rounded-xl border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200 resize-none min-h-[120px]"></textarea>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button class="btn col-span-1 bg-purple-600 text-white font-medium py-3 rounded-xl hover:bg-purple-700" id="btnSearch">Search</button>
                            <button class="btn col-span-1 bg-purple-600 text-white font-medium py-3 rounded-xl hover:bg-purple-700" id="btnDeepSearch">Deep Search</button>
                            <button class="btn col-span-2 bg-gray-700 text-gray-200 font-medium py-3 rounded-xl hover:bg-gray-600" id="btnClear">Clear Search</button>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                            <input class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" id="apiKey" type="text" placeholder="YouTube API Key" value="AIzaSyBo5wWMC5T5lemycWNqtfs2_SAjApsLuFA"/>
                            <input class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" id="perPage" type="number" min="1" max="50" value="25" placeholder="Results per page"/>
                            <select id="order" class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="relevance">Order: Relevance</option>
                                <option value="date">Order: Date</option>
                                <option value="viewCount">Order: Views</option>
                            </select>
                            <select id="duration" class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Duration: Any</option>
                                <option value="short">Short</option>
                                <option value="medium">Medium</option>
                                <option value="long">Long</option>
                            </select>
                            <input id="minSubs" type="number" placeholder="Min Subs" class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                            <input id="maxSubs" type="number" placeholder="Max Subs" class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                            <div class="col-span-2 text-center text-sm mt-2 text-gray-500">
                                <span id="count">0 channels</span>
                            </div>
                        </div>
                        
                        <div class="relative pt-1 mt-4">
                            <div class="flex mb-2 items-center justify-between text-xs">
                                <div class="text-gray-400">Progress</div>
                            </div>
                            <div class="flex h-2 mb-4 overflow-hidden text-xs bg-gray-700 rounded-lg">
                                <div id="progressBar" class="flex flex-col justify-center shadow-none whitespace-nowrap bg-purple-600 transition-all duration-300 ease-in-out" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button class="btn flex-1 bg-gray-700 text-gray-200 font-medium py-3 rounded-xl hover:bg-gray-600" id="btnSaveLib">Save Library</button>
                            <button class="btn flex-1 bg-gray-700 text-gray-200 font-medium py-3 rounded-xl hover:bg-gray-600" id="btnLoadLib">Load Library</button>
                        </div>
                    </div>
                    
                    <!-- Search History Panel -->
                    <div class="glass-panel p-6 flex flex-col gap-4 fade-in" style="animation-delay: 0.7s;">
                        <h2 class="text-xl font-bold">Recent Searches</h2>
                        <div id="searchHistoryContainer" class="flex flex-col gap-2 max-h-48 overflow-y-auto custom-scroll">
                            <div class="h-6 skeleton rounded-full w-4/5"></div>
                            <div class="h-6 skeleton rounded-full w-full"></div>
                            <div class="h-6 skeleton rounded-full w-3/4"></div>
                        </div>
                    </div>
                </div>

                <!-- Results Table Panel -->
                <div class="col-span-1 md:col-span-3 glass-panel p-6 flex flex-col fade-in" style="animation-delay: 0.3s;">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">Search Results</h2>
                        <div class="flex gap-2">
                            <button class="btn bg-gray-700 text-gray-200 px-4 py-2 rounded-xl text-sm font-medium hover:bg-gray-600" id="btnExportCSV">Export CSV</button>
                            <button class="btn bg-gray-700 text-gray-200 px-4 py-2 rounded-xl text-sm font-medium hover:bg-gray-600" id="btnExportJSON">Export JSON</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scroll">
                        <table class="w-full text-sm text-left">
                            <thead class="sticky top-0 bg-gray-800/80 backdrop-blur-sm z-10">
                                <tr class="text-gray-400 font-semibold border-b border-gray-700">
                                    <th class="p-4 rounded-tl-xl">
                                        <input type="checkbox" id="selectAllCheckbox" class="rounded-sm bg-gray-700 border-gray-500 text-purple-600 focus:ring-purple-500">
                                    </th>
                                    <th class="p-4">Channel</th>
                                    <th class="p-4">Subs</th>
                                    <th class="p-4 rounded-tr-xl">Videos</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTbody">
                                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-full"></div></td></tr>
                                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-4/5"></div></td></tr>
                                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-3/4"></div></td></tr>
                                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-full"></div></td></tr>
                                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-1/2"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Authentication View -->
    <div id="auth-view" class="h-screen w-screen flex items-center justify-center fade-in" style="display: none;">
        <div class="glass-panel p-10 flex flex-col gap-6 text-center max-w-lg w-full">
            <h2 class="text-3xl font-bold text-white">Lead Studio Pro</h2>
            <p class="text-gray-400">Sign in to find and manage your YouTube channel leads.</p>
            <input id="authEmail" type="email" placeholder="Email" autocomplete="username" class="bg-white/5 rounded-xl border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200">
            <input id="authPass" type="password" placeholder="Password" autocomplete="current-password" class="bg-white/5 rounded-xl border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200">
            <div class="flex gap-4">
                <button class="btn flex-1 bg-purple-600 text-white font-semibold py-3 rounded-xl" id="btnSignIn">Sign In</button>
                <button class="btn flex-1 bg-gray-700 text-gray-200 font-semibold py-3 rounded-xl hover:bg-gray-600" id="btnSignUp">Sign Up</button>
            </div>
            <div id="authStatus" class="text-sm text-red-400"></div>
        </div>
    </div>
    
    <!-- Message Box Overlay -->
    <div id="messageBoxOverlay" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div id="messageBox" class="glass-panel p-8 max-w-lg text-center flex flex-col gap-6 transform scale-95 transition-transform duration-300">
            <h4 id="messageTitle" class="text-xl font-semibold text-white"></h4>
            <p id="messageText" class="text-gray-400"></p>
            <button class="btn bg-purple-600 text-white font-semibold py-3 rounded-xl" id="messageBoxOk">OK</button>
        </div>
    </div>
    
    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, getDocs, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================
        // STATE + HELPERS
        // =========================
        const $ = id => document.getElementById(id);
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const esc = s => String(s ?? '').replace(/"/g,'""');
        const clamp = (n,min,max) => Math.max(min, Math.min(max, n));
        
        // Provided by the hosting environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let currentUser = null;
        let LIB = [];
        
        // Add ripple effect listener to all buttons
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function(e) {
                const rect = button.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const ripple = document.createElement('span');
                ripple.className = 'ripple-effect';
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                
                this.appendChild(ripple);
                
                ripple.addEventListener('animationend', () => {
                    ripple.remove();
                });
            });
        });

        // =========================
        // FIREBASE CONFIGURATION
        // =========================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const PUBLIC_LIBRARIES_COLLECTION = `artifacts/${appId}/public/data/libraries`;
        const SEARCH_LOGS_COLLECTION = `artifacts/${appId}/users`;
        
        // Initial authentication check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('app-view').style.display = 'flex';
                $('auth-view').style.display = 'none';
                $('userEmail').innerText = user.email || user.uid;
                
                // Set initials for the avatar
                const initials = user.email ? user.email.charAt(0).toUpperCase() : user.uid.charAt(0).toUpperCase();
                $('initials').innerText = initials;
                
                // Update Firestore with last login timestamp
                const userRef = doc(db, `users`, user.uid);
                await setDoc(userRef, { lastLogin: new Date().toISOString() }, { merge: true });
                
                // Start listening to search history for this user
                listenToSearchHistory();

            } else {
                currentUser = null;
                $('app-view').style.display = 'none';
                $('auth-view').style.display = 'flex';
            }
        });
        
        if (initialAuthToken) {
             signInWithCustomToken(auth, initialAuthToken).catch(e => {
                console.error("Custom token sign-in failed. Attempting anonymous.", e);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }

        $('btnSignIn').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                $('authStatus').innerText = '';
            } catch (error) {
                $('authStatus').innerText = 'Sign-in failed: ' + error.message;
            }
        });

        $('btnSignUp').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                $('authStatus').innerText = '';
            } catch (error) {
                $('authStatus').innerText = 'Sign-up failed: ' + error.message;
            }
        });

        $('btnSignOut').addEventListener('click', async () => {
            await signOut(auth);
            resetResults();
        });

        // =========================
        // UI & MESSAGE BOX
        // =========================
        function setStatus(t){ $('status').innerText = t; }
        function setProgress(p){ $('progressBar').style.width = Math.min(100, Math.round(p*100)) + '%'; }

        function showMessage(title, message, isHtml=false) {
            $('messageTitle').innerText = title;
            if (isHtml) {
                $('messageText').innerHTML = message;
            } else {
                $('messageText').innerText = message;
            }
            $('messageBoxOverlay').classList.remove('opacity-0', 'pointer-events-none');
            $('messageBox').classList.remove('scale-95');
            $('messageBox').classList.add('scale-100');
        }

        $('messageBoxOk').addEventListener('click', () => {
            $('messageBoxOverlay').classList.add('opacity-0', 'pointer-events-none');
            $('messageBox').classList.remove('scale-100');
            $('messageBox').classList.add('scale-95');
        });
        
        $('selectAllCheckbox').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.sel').forEach(cb => cb.checked = isChecked);
        });

        // =========================
        // SEARCH & FETCH LOGIC
        // =========================
        $('btnSearch').addEventListener('click', () => searchAll(false));
        $('btnDeepSearch').addEventListener('click', () => {
          const queryRaw = $('query').value.trim();
          if (!queryRaw.length) {
            showMessage('Search Error', 'Please enter at least one query');
            return;
          }
          if (!currentUser) {
            showMessage('Authentication Required', 'Please sign in first.');
            return;
          }
          
          showMessage('Deep Search Confirmation', 'Deep Search will consume more API credits by searching more pages. Do you want to continue?');
          $('messageBoxOk').onclick = () => {
            searchAll(true);
            $('messageBoxOverlay').classList.add('opacity-0', 'pointer-events-none');
            $('messageBox').classList.remove('scale-100');
            $('messageBox').classList.add('scale-95');
          };
        });

        $('btnClear').addEventListener('click', () => { $('query').value=''; resetResults(); });

        async function searchAll(isDeepSearch = false){
            const queryRaw = $('query').value.trim();
            const queries = queryRaw.split(/[,\\n]/).map(q=>q.trim()).filter(Boolean);
            const perPage = clamp(Number($('perPage').value||25), 1, 50);
            const pages = isDeepSearch ? 20 : clamp(Number($('pages').value||2), 1, 10);

            if(!queries.length){ showMessage('Search Error', 'Please enter at least one query'); return; }
            if(!currentUser){ showMessage('Authentication Required', 'Please sign in first.'); return; }
            
            logSearch(queries.join(', '));
            resetResults();
            setStatus('Searching...');
            const apiKey = $('apiKey').value.trim();
            const order = $('order').value;
            const duration = $('duration').value;
            let totalSteps = queries.length * pages;
            let done = 0;
            let chanIds = new Set();
            
            for(const q of queries){
                let pageToken = '';
                for(let i=0;i<pages;i++){
                    if(!pageToken && i>0) break;
                    
                    const url = new URL('https://www.googleapis.com/youtube/v3/search');
                    url.searchParams.set('part','snippet');
                    url.searchParams.set('type','video');
                    url.searchParams.set('q', q);
                    url.searchParams.set('maxResults', String(perPage));
                    url.searchParams.set('order', order);
                    if(duration) url.searchParams.set('videoDuration', duration);
                    if(pageToken) url.searchParams.set('pageToken', pageToken);
                    url.searchParams.set('key', apiKey);
                    
                    let resp;
                    try { resp = await fetch(url.toString()); }
                    catch(e){ console.error(e); showMessage('Network Error', 'A network error occurred during the search. Please check your connection.'); return; }
                    
                    if(!resp.ok){
                        const t = await resp.text();
                        showMessage('Search API Error', `YouTube API returned an error: ${resp.status}\n${t}`);
                        return;
                    }
                    
                    const data = await resp.json();
                    
                    (data.items || []).forEach(item => {
                        const t = (item.snippet.title||'').toLowerCase();
                        const d = (item.snippet.description||'').toLowerCase();
                        if(t.includes('#shorts') || t.includes('shorts ') || t.endsWith('shorts') || d.includes('#shorts') || d.includes('shorts ')) return;
                        const cid = item.snippet.channelId;
                        if(cid) chanIds.add(cid);
                    });
                    
                    pageToken = data.nextPageToken || '';
                    done++;
                    setProgress(done/totalSteps * 0.65);
                    await sleep(180);
                }
            }
            
            if(chanIds.size===0){ setStatus('No channels found'); setProgress(1); return; }
            
            setStatus(`Found ${chanIds.size} channels – fetching details...`);
            
            const ids = Array.from(chanIds);
            const minSubs = Number($('minSubs').value||0);
            const maxSubsRaw = Number($('maxSubs').value||0);
            const maxSubs = maxSubsRaw > 0 ? maxSubsRaw : Infinity;

            for(let i=0;i<ids.length;i+=50){
                const batch = ids.slice(i,i+50);
                const chURL = new URL('https://www.googleapis.com/youtube/v3/channels');
                chURL.searchParams.set('part','snippet,statistics');
                chURL.searchParams.set('id', batch.join(','));
                chURL.searchParams.set('key', apiKey);
                
                let resp;
                try { resp = await fetch(chURL.toString()); }
                catch(e){ console.error(e); showMessage('Network Error', 'A network error occurred while fetching channel details.'); return; }
                
                if(!resp.ok){
                    const t = await resp.text();
                    showMessage('Channels API Error', `YouTube API returned an error: ${resp.status}\n${t}`);
                    return;
                }
                
                const data = await resp.json();
                
                (data.items||[]).forEach(ch => {
                    const stats = ch.statistics || {};
                    const subs = Number(stats.subscriberCount||0);
                    
                    if(subs >= minSubs && subs <= maxSubs) {
                        LIB.push({
                            title: ch.snippet.title,
                            channelId: ch.id,
                            subs: subs,
                            views: Number(stats.viewCount||0),
                            videos: Number(stats.videoCount||0),
                            avatar: ch.snippet.thumbnails?.high?.url || ''
                        });
                    }
                    
                    done++;
                    setProgress(0.65 + (done/totalSteps * 0.35));
                });
                await sleep(180);
            }

            if(LIB.length===0){
                setStatus('No channels found matching filters.');
            } else {
                renderResults(LIB);
                setStatus(`Found ${LIB.length} channels.`);
            }
            setProgress(1);
            updateMetrics();
        }

        function resetResults(){
            LIB = [];
            $('resultsTbody').innerHTML=`
                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-full"></div></td></tr>
                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-4/5"></div></td></tr>
                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-3/4"></div></td></tr>
                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-full"></div></td></tr>
                <tr><td colspan="4" class="p-4"><div class="h-4 skeleton rounded-full w-1/2"></div></td></tr>
            `; 
            $('count').innerText='0 channels';
            setProgress(0);
            setStatus('Online');
            updateMetrics();
        }

        // =========================
        // RENDER RESULTS
        // =========================
        function renderResults(list){
            const tbody = $('resultsTbody');
            tbody.innerHTML = '';
            if(!list.length){
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">No channels match your filters.</td></tr>`;
                return;
            }
            list.forEach((c, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition-colors duration-200 cursor-pointer border-b border-gray-700 last:border-b-0";
                tr.innerHTML = `
                    <td class="p-4 rounded-l-xl"><input type="checkbox" class="sel rounded-sm bg-gray-700 border-gray-500 text-purple-600 focus:ring-purple-500" data-idx="${idx}"></td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${c.avatar}" class="w-12 h-12 rounded-lg object-cover" alt="">
                            <div>
                                <strong class="text-white">${c.title}</strong>
                                <span class="block text-xs text-gray-400">${c.channelId}</span>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">${c.subs.toLocaleString()}</td>
                    <td class="p-4 rounded-r-xl">${c.videos.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
            $('count').innerText = `${list.length} channels`;
        }
        
        // =========================
        // NEW FEATURE: METRICS
        // =========================
        function updateMetrics() {
            const totalChannels = LIB.length;
            const totalSubs = LIB.reduce((sum, c) => sum + c.subs, 0);
            const totalVideos = LIB.reduce((sum, c) => sum + c.videos, 0);

            $('metric-channels').innerText = totalChannels.toLocaleString();
            $('metric-subs').innerText = totalSubs.toLocaleString();
            $('metric-videos').innerText = totalVideos.toLocaleString();
        }
        
        // =========================
        // NEW FEATURE: SEARCH HISTORY
        // =========================
        async function logSearch(query) {
            if (!currentUser) return;
            try {
                const userLogsRef = doc(db, SEARCH_LOGS_COLLECTION, currentUser.uid);
                const logsCollection = collection(userLogsRef, "searchLogs");
                await setDoc(doc(logsCollection), {
                    query: query,
                    timestamp: new Date().toISOString()
                });
            } catch (e) {
                console.error("Failed to log search:", e);
            }
        }
        
        function listenToSearchHistory() {
             if (!currentUser) return;
             const userLogsRef = doc(db, SEARCH_LOGS_COLLECTION, currentUser.uid);
             const logsCollection = collection(userLogsRef, "searchLogs");
             const q = query(logsCollection, orderBy("timestamp", "desc"), limit(5));
             
             onSnapshot(q, (snapshot) => {
                 const historyContainer = $('searchHistoryContainer');
                 historyContainer.innerHTML = '';
                 
                 if (snapshot.empty) {
                     historyContainer.innerHTML = `<span class="text-gray-500 text-sm">No recent searches.</span>`;
                     return;
                 }
                 
                 snapshot.forEach(doc => {
                     const data = doc.data();
                     const item = document.createElement('div');
                     item.className = "p-3 rounded-xl bg-white/5 recent-search-item";
                     item.innerHTML = `
                         <p class="text-sm font-medium text-white">${data.query}</p>
                         <p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleString()}</p>
                     `;
                     historyContainer.appendChild(item);
                     
                     item.addEventListener('click', () => {
                         $('query').value = data.query;
                         searchAll(false);
                     });
                 });
             }, (error) => {
                 console.error("Error listening to search history:", error);
                 $('searchHistoryContainer').innerHTML = `<span class="text-red-400 text-sm">Error loading history.</span>`;
             });
        }


        // =========================
        // DATA PERSISTENCE & EXPORT
        // =========================
        function toCSV(arr){
            const fields = ['title', 'subs', 'videos', 'views', 'channelId'];
            let out = fields.map(f=>`"${f}"`).join(',')+'\n';
            arr.forEach(r => {
                out += `"${esc(r.title)}",${r.subs},${r.videos},${r.views},"${r.channelId}"\n`;
            });
            return out;
        }

        function downloadText(text, filename, type){
            const blob = new Blob([text], {type: type});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        $('btnExportCSV').addEventListener('click', () => {
            if(!LIB.length) return showMessage('Export Failed', 'No results to export');
            downloadText(toCSV(LIB), 'channels.csv', 'text/csv');
        });

        $('btnExportJSON').addEventListener('click', () => {
            if(!LIB.length) return showMessage('Export Failed', 'No results to export');
            downloadText(JSON.stringify(LIB, null, 2), 'channels.json', 'application/json');
        });

        $('btnSaveLib').addEventListener('click', async () => {
            if(!LIB.length) return showMessage('Save Failed', 'No channels to save.');
            try {
                const userDocRef = doc(db, PUBLIC_LIBRARIES_COLLECTION, currentUser.uid);
                await setDoc(userDocRef, {
                    library: LIB,
                    timestamp: new Date().toISOString()
                }, { merge: true });
                showMessage('Save Success', `Saved ${LIB.length} channels to your library.`);
            } catch(e){
                console.error(e);
                showMessage('Save Failed', 'Failed to save library to Firestore. Check console for details.');
            }
        });

        $('btnLoadLib').addEventListener('click', async () => {
            if (!currentUser) {
                return showMessage('Load Failed', 'Please sign in to load your library.');
            }
            try{
                const userDocRef = doc(db, PUBLIC_LIBRARIES_COLLECTION, currentUser.uid);
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists() && docSnap.data().library) {
                    LIB = docSnap.data().library;
                    renderResults(LIB);
                    updateMetrics();
                    showMessage('Load Success', `Loaded ${LIB.length} channels from your library.`);
                } else {
                    showMessage('Load Failed', 'No saved library found.');
                }
            } catch(e){
                console.error(e);
                showMessage('Load Failed', 'Failed to load library from Firestore. Data may be corrupted or permission denied.');
            }
        });
    </script>
</body>
</html>
