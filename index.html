<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Lead Studio Pro — YouTube Channel Finder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =========================
           THEME — Apple-ish + Purple
           ========================= */
        :root {
            --bg-dark: #07090D;
            --panel-bg: rgba(255, 255, 255, 0.04);
            --border-color: rgba(255, 255, 255, 0.1);
            --purple-accent: #8b5cf6; /* Tailwind's purple-500 */
            --purple-hover: #7c3aed; /* Tailwind's purple-600 */
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
        }

        /* Base reset */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 40%), radial-gradient(circle at 85% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 40%), var(--bg-dark);
        }

        .glass-panel {
            background-color: var(--panel-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--purple-accent);
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--purple-hover);
        }

        .btn {
            position: relative;
            overflow: hidden;
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            animation: ripple 0.6s linear;
            transform: scale(0);
        }

        @keyframes ripple {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        .skeleton {
            animation: skeleton-loading 1.5s infinite linear;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
            background-size: 200% 100%;
        }

        @keyframes skeleton-loading {
            from {
                background-position: -200px 0;
            }
            to {
                background-position: 200px 0;
            }
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card-animation {
            animation: popIn 0.5s ease-out forwards;
            opacity: 0;
            transform: scale(0.9);
        }

        @keyframes popIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .recent-search-item {
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            transform: scale(1);
        }

        .recent-search-item:hover {
            background-color: rgba(255, 255, 255, 0.06);
            transform: scale(1.02);
        }
    </style>
</head>
<body class="flex">
    <div id="app-view" class="h-full w-full flex" style="display: none;">
        <aside class="glass-panel w-20 flex flex-col items-center py-6 mx-4 my-4 fade-in" style="animation-delay: 0.1s;">
            <div class="mb-8 p-3 bg-purple-600 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1-1 .45-1 1zm8-18c0-.55-.45-1-1-1s-1 .45-1 1 .45 1 1 1 1-.45 1-1zm-6 2c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1zm6 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1zm-4-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-3 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM9 2v4h4V2H9zm2 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                </svg>
            </div>
            <nav class="flex-1 flex flex-col gap-4">
                <div class="group relative cursor-pointer flex items-center justify-center p-3 rounded-xl hover:bg-white/10 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-400" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-1.6.53-3.08 1.4-4.28L19.43 18.6c-1.2.87-2.68 1.4-4.28 1.4-1.62 0-3.13-.53-4.32-1.47zM4.07 12c.49 3.95 3.85 7 7.93 7 1.6 0 3.08-.53 4.28-1.4L4.57 5.4c-.87 1.2-1.4 2.68-1.4 4.28 0 1.62.53 3.13 1.47 4.32z"/>
                    </svg>
                    <span class="absolute left-full ml-4 whitespace-nowrap px-3 py-1 bg-gray-700 text-sm text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200">Dashboard</span>
                </div>
                <div class="group relative cursor-pointer flex items-center justify-center p-3 rounded-xl hover:bg-white/10 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15c0 .55.45 1 1 1s1-.45 1-1V9c0-.55-.45-1-1-1s-1 .45-1 1v8zm-1-9c0-.55.45-1 1-1h1c.55 0 1 .45 1 1v1c0 .55-.45 1-1 1h-1c-.55 0-1-.45-1-1V8z"/>
                    </svg>
                    <span class="absolute left-full ml-4 whitespace-nowrap px-3 py-1 bg-gray-700 text-sm text-white rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200">Analytics</span>
                </div>
            </nav>
            <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center text-sm font-semibold">
                <span id="initials"></span>
            </div>
        </aside>

        <main class="flex-1 overflow-auto p-4 flex flex-col">
            <header class="h-16 flex items-center justify-between px-6 mb-4">
                <div class="flex items-center gap-4">
                    <h1 class="text-3xl font-bold text-white">Dashboard</h1>
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span id="status">Online</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="userEmail" class="text-sm text-gray-400"></span>
                    <button class="btn bg-gray-700 text-gray-200 px-4 py-2 rounded-xl text-sm font-medium hover:bg-gray-600" id="btnSignOut">Sign Out</button>
                </div>
            </header>

            <div class="flex-1 grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="col-span-1 md:col-span-2 flex flex-col gap-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="card-total" class="glass-panel p-4 flex flex-col items-center justify-center text-center stat-card-animation" style="animation-delay: 0.4s;">
                            <span class="text-xs text-gray-400 font-medium">Channels Found</span>
                            <span id="metric-channels" class="text-2xl font-bold text-white mt-1 skeleton-text">0</span>
                        </div>
                        <div id="card-subs" class="glass-panel p-4 flex flex-col items-center justify-center text-center stat-card-animation" style="animation-delay: 0.5s;">
                            <span class="text-xs text-gray-400 font-medium">Total Subscribers</span>
                            <span id="metric-subs" class="text-2xl font-bold text-white mt-1 skeleton-text">0</span>
                        </div>
                        <div id="card-videos" class="glass-panel p-4 flex flex-col items-center justify-center text-center stat-card-animation" style="animation-delay: 0.6s;">
                            <span class="text-xs text-gray-400 font-medium">Total Videos</span>
                            <span id="metric-videos" class="text-2xl font-bold text-white mt-1 skeleton-text">0</span>
                        </div>
                    </div>

                    <div class="glass-panel p-6 flex flex-col gap-4 fade-in" style="animation-delay: 0.2s;">
                        <h2 class="text-xl font-bold">Search Filters</h2>
                        <textarea id="query" placeholder="Enter one or more queries (comma or newline separated)" class="w-full bg-white/5 rounded-xl border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200 resize-none min-h-[120px]"></textarea>

                        <div class="grid grid-cols-2 gap-3">
                            <button class="btn col-span-1 bg-purple-600 text-white font-medium py-3 rounded-xl hover:bg-purple-700" id="btnSearch">Search</button>
                            <button class="btn col-span-1 bg-purple-600 text-white font-medium py-3 rounded-xl hover:bg-purple-700" id="btnDeepSearch">Deep Search</button>
                            <button class="btn col-span-2 bg-gray-700 text-gray-200 font-medium py-3 rounded-xl hover:bg-gray-600" id="btnClear">Clear Search</button>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                            <input class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" id="apiKey" type="text" placeholder="YouTube API Key" value=""/>
                            <input class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" id="perPage" type="number" min="1" max="50" value="25" placeholder="Results per page"/>
                            <select id="order" class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="relevance">Order: Relevance</option>
                                <option value="date">Order: Date</option>
                                <option value="viewCount">Order: Views</option>
                            </select>
                            <select id="duration" class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Duration: Any</option>
                                <option value="short">Short</option>
                                <option value="medium">Medium</option>
                                <option value="long">Long</option>
                            </select>
                            <input id="minSubs" type="number" placeholder="Min Subs" class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                            <input id="maxSubs" type="number" placeholder="Max Subs" class="bg-white/5 rounded-xl border border-white/10 px-4 py-2 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                            <div class="col-span-2 text-center text-sm mt-2 text-gray-500">
                                <span id="count">0 channels</span>
                            </div>
                        </div>

                        <div class="relative pt-1 mt-4">
                            <div class="flex mb-2 items-center justify-between text-xs">
                                <div class="text-gray-400">Progress</div>
                            </div>
                            <div class="flex h-2 mb-4 overflow-hidden text-xs bg-gray-700 rounded-lg">
                                <div id="progressBar" class="flex flex-col justify-center shadow-none whitespace-nowrap bg-purple-600 transition-all duration-300 ease-in-out" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button class="btn flex-1 bg-gray-700 text-gray-200 font-medium py-3 rounded-xl hover:bg-gray-600" id="btnSaveLib">Save Library</button>
                            <button class="btn flex-1 bg-gray-700 text-gray-200 font-medium py-3 rounded-xl hover:bg-gray-600" id="btnLoadLib">Load Library</button>
                        </div>
                    </div>

                    <div class="glass-panel p-6 flex flex-col gap-4 fade-in" style="animation-delay: 0.7s;">
                        <h2 class="text-xl font-bold">Recent Searches</h2>
                        <div id="searchHistoryContainer" class="flex flex-col gap-2 max-h-48 overflow-y-auto custom-scroll">
                            <div class="h-6 skeleton rounded-full w-4/5"></div>
                            <div class="h-6 skeleton rounded-full w-full"></div>
                            <div class="h-6 skeleton rounded-full w-3/4"></div>
                        </div>
                    </div>
                </div>

                <div class="col-span-1 md:col-span-3 glass-panel p-6 flex flex-col fade-in" style="animation-delay: 0.3s;">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">Search Results</h2>
                        <div class="flex gap-2">
                            <button class="btn bg-gray-700 text-gray-200 px-4 py-2 rounded-xl text-sm font-medium hover:bg-gray-600" id="btnExportCSV">Export CSV</button>
                            <button class="btn bg-gray-700 text-gray-200 px-4 py-2 rounded-xl text-sm font-medium hover:bg-gray-600" id="btnExportJSON">Export JSON</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll">
                        <table class="w-full text-sm text-left">
                            <thead class="sticky top-0 bg-gray-800/80 backdrop-blur-sm z-10">
                                <tr class="text-gray-400 font-semibold border-b border-gray-700">
                                    <th class="p-4 rounded-tl-xl">
                                        <input type="checkbox" id="selectAllCheckbox" class="rounded-sm bg-gray-700 border-gray-500 text-purple-600 focus:ring-purple-500">
                                    </th>
                                    <th class="p-4">Channel</th>
                                    <th class="p-4">Subs</th>
                                    <th class="p-4">Videos</th>
                                    <th class="p-4 rounded-tr-xl">Socials</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTbody">
                                <tr>
                                    <td colspan="5" class="p-4 text-center text-gray-500">
                                        Enter your search queries and API key to begin.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="auth-view" class="h-screen w-screen flex items-center justify-center fade-in" style="display: none;">
        <div class="glass-panel p-10 flex flex-col gap-6 text-center max-w-lg w-full">
            <h2 class="text-3xl font-bold text-white">Lead Studio Pro</h2>
            <p class="text-gray-400">Sign in to find and manage your YouTube channel leads.</p>
            <input id="authEmail" type="email" placeholder="Email" autocomplete="username" class="bg-white/5 rounded-xl border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200">
            <input id="authPass" type="password" placeholder="Password" autocomplete="current-password" class="bg-white/5 rounded-xl border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200">
            <div class="flex gap-4">
                <button class="btn flex-1 bg-purple-600 text-white font-semibold py-3 rounded-xl" id="btnSignIn">Sign In</button>
                <button class="btn flex-1 bg-gray-700 text-gray-200 font-semibold py-3 rounded-xl hover:bg-gray-600" id="btnSignUp">Sign Up</button>
            </div>
            <div id="authStatus" class="text-sm text-red-400"></div>
        </div>
    </div>

    <div id="messageBoxOverlay" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div id="messageBox" class="glass-panel p-8 max-w-lg text-center flex flex-col gap-6 transform scale-95 transition-transform duration-300">
            <h4 id="messageTitle" class="text-xl font-semibold text-white"></h4>
            <p id="messageText" class="text-gray-400"></p>
            <button class="btn bg-purple-600 text-white font-semibold py-3 rounded-xl" id="messageBoxOk">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, getDocs, onSnapshot, addDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================
        // STATE + HELPERS
        // =========================
        const $ = id => document.getElementById(id);
        const esc = s => String(s || '').replace(/"/g, '""');

        let LIB = [];
        let auth, db, currentUser;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvU3_Njbi1JQr_wD1a16h5coTW2ifaRDU",
            authDomain: "youleadmax.firebaseapp.com",
            projectId: "youleadmax",
            storageBucket: "youleadmax.firebasestorage.app",
            messagingSenderId: "710806971072",
            appId: "1:710806971072:web:ced903befe8693f886c325",
            measurementId: "G-JW9W20C1LQ"
        };
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // =========================
        // UI & MESSAGE BOX FUNCTIONS
        // =========================
        function showMessage(title, message, isHtml = false) {
            $('messageTitle').innerText = title;
            if (isHtml) {
                $('messageText').innerHTML = message;
            } else {
                $('messageText').innerText = message;
            }
            $('messageBoxOverlay').classList.remove('opacity-0', 'pointer-events-none');
            $('messageBox').classList.remove('scale-95');
            $('messageBox').classList.add('scale-100');
        }

        $('messageBoxOk').addEventListener('click', () => {
            $('messageBoxOverlay').classList.add('opacity-0', 'pointer-events-none');
            $('messageBox').classList.remove('scale-100');
            $('messageBox').classList.add('scale-95');
        });

        function setStatus(t) { $('status').innerText = t; }

        function setProgress(p) { $('progressBar').style.width = Math.min(100, Math.round(p * 100)) + '%'; }

        function updateMetrics() {
            const totalSubs = LIB.reduce((sum, c) => sum + (c.subscribers || 0), 0);
            const totalVideos = LIB.reduce((sum, c) => sum + (c.videoCount || 0), 0);

            $('metric-channels').innerText = formatNumber(LIB.length);
            $('metric-subs').innerText = formatNumber(totalSubs);
            $('metric-videos').innerText = formatNumber(totalVideos);
        }

        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return num;
        }

        function downloadFile(filename, mimeType, content) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getSelectedData() {
            const selectedChannels = [];
            document.querySelectorAll('.sel:checked').forEach(checkbox => {
                const row = checkbox.closest('tr');
                const title = row.querySelector('a').innerText;
                const id = row.querySelector('a').href.split('/').pop();
                const subs = parseInt(row.children[2].innerText.replace(/[^0-9.]/g, '') * (row.children[2].innerText.includes('M') ? 1000000 : row.children[2].innerText.includes('K') ? 1000 : 1));
                const videos = parseInt(row.children[3].innerText.replace(/[^0-9.]/g, '') * (row.children[3].innerText.includes('M') ? 1000000 : row.children[3].innerText.includes('K') ? 1000 : 1));
                selectedChannels.push({ id, title, subscribers: subs, videoCount: videos });
            });
            return selectedChannels;
        }

        // Add ripple effect listener
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function(e) {
                const rect = button.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const ripple = document.createElement('span');
                ripple.className = 'ripple-effect';
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;

                this.appendChild(ripple);

                ripple.addEventListener('animationend', () => {
                    ripple.remove();
                });
            });
        });

        $('selectAllCheckbox').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.sel').forEach(cb => cb.checked = isChecked);
        });

        $('btnExportCSV').addEventListener('click', () => {
            const data = getSelectedData();
            if (data.length === 0) {
                return showMessage('Export Failed', 'Please select at least one channel to export.');
            }
            const csvRows = [];
            const headers = ['Channel ID', 'Title', 'Subscribers', 'Video Count'];
            csvRows.push(headers.map(esc).join(','));

            for (const row of data) {
                const values = [row.id, row.title, row.subscribers, row.videoCount];
                csvRows.push(values.map(esc).join(','));
            }
            const csvString = csvRows.join('\n');
            downloadFile('channels.csv', 'text/csv', csvString);
        });

        $('btnExportJSON').addEventListener('click', () => {
            const data = getSelectedData();
            if (data.length === 0) {
                return showMessage('Export Failed', 'Please select at least one channel to export.');
            }
            const jsonString = JSON.stringify(data, null, 2);
            downloadFile('channels.json', 'application/json', jsonString);
        });

        // =========================
        // AUTHENTICATION LOGIC
        // =========================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('app-view').style.display = 'flex';
                $('auth-view').style.display = 'none';
                $('userEmail').innerText = user.email || user.uid;
                const initials = user.email ? user.email.charAt(0).toUpperCase() : user.uid.charAt(0).toUpperCase();
                $('initials').innerText = initials;
                listenToSearchHistory();
            } else {
                currentUser = null;
                $('app-view').style.display = 'none';
                $('auth-view').style.display = 'flex';
            }
        });

        $('btnSignIn').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                $('authStatus').innerText = '';
            } catch (error) {
                $('authStatus').innerText = 'Sign-in failed: ' + error.message;
            }
        });

        $('btnSignUp').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                $('authStatus').innerText = '';
            } catch (error) {
                $('authStatus').innerText = 'Sign-up failed: ' + error.message;
            }
        });

        $('btnSignOut').addEventListener('click', async () => {
            await signOut(auth);
            resetResults();
        });


        // =========================
        // ORIGINAL FUNCTIONS FROM INDEX (4)
        // =========================
        async function getChannelDetails(channelId) {
            const apiKey = $('apiKey').value;
            const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelId}&key=${apiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.items.length === 0) {
                return null;
            }
            const item = data.items[0];
            const socialLinks = await getSocialLinksFromAboutPage(channelId);
            return {
                id: item.id,
                title: item.snippet.title,
                subscribers: parseInt(item.statistics.subscriberCount),
                videoCount: parseInt(item.statistics.videoCount),
                thumbnail: item.snippet.thumbnails.default.url,
                socialLinks: socialLinks,
            };
        }

        async function getSocialLinksFromAboutPage(channelId) {
            const proxyUrl = $('corsProxy').value || '';
            const aboutUrl = `${proxyUrl}https://www.youtube.com/channel/${channelId}/about`;

            try {
                const response = await fetch(aboutUrl);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const socialLinks = {};
                const linkElements = doc.querySelectorAll('.yt-formatted-string a');

                linkElements.forEach(link => {
                    const url = link.href;
                    if (url.includes('twitter.com')) socialLinks.twitter = url;
                    else if (url.includes('instagram.com')) socialLinks.instagram = url;
                    else if (url.includes('facebook.com')) socialLinks.facebook = url;
                    else if (url.includes('tiktok.com')) socialLinks.tiktok = url;
                    else if (url.includes('linkedin.com')) socialLinks.linkedin = url;
                    else if (!socialLinks.website) socialLinks.website = url;
                });
                return socialLinks;
            } catch (error) {
                console.error('Failed to retrieve social links:', error);
                return {};
            }
        }
        
        // =========================
        // NEW FUNCTIONS & LOGIC
        // =========================
        // FIXED: Replaced __app_id with firebaseConfig.projectId
        const PUBLIC_LIBRARIES_COLLECTION = `artifacts/${firebaseConfig.projectId}/public/data/libraries`;

        async function logSearch(queryText) {
            if (!currentUser) return;
            const logsRef = collection(db, `users`, currentUser.uid, 'searchLogs');
            addDoc(logsRef, {
                query: queryText,
                timestamp: new Date().toISOString()
            }).catch(e => console.error("Failed to log search:", e));
        }

        function listenToSearchHistory() {
            if (!currentUser) return;
            const historyRef = collection(db, `users`, currentUser.uid, 'searchLogs');
            const q = query(historyRef, orderBy('timestamp', 'desc'), limit(10));
            onSnapshot(q, (snapshot) => {
                $('searchHistoryContainer').innerHTML = '';
                if (snapshot.empty) {
                    $('searchHistoryContainer').innerHTML = '<p class="text-gray-500 text-sm">No recent searches.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const search = doc.data();
                        const item = document.createElement('div');
                        item.className = 'recent-search-item p-3 rounded-lg border border-white/10 text-gray-200 text-sm';
                        item.innerText = search.query;
                        item.onclick = () => {
                            $('query').value = search.query;
                            searchAll();
                        };
                        $('searchHistoryContainer').appendChild(item);
                    });
                }
            }, (error) => {
                console.error("Error listening to search history:", error);
            });
        }

        function renderResults(channels) {
            $('resultsTbody').innerHTML = '';
            const frag = document.createDocumentFragment();
            channels.forEach(channel => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition-colors duration-200";
                tr.innerHTML = `
                    <td class="p-4">
                        <input type="checkbox" class="sel rounded-sm bg-gray-700 border-gray-500 text-purple-600 focus:ring-purple-500">
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${channel.thumbnail || 'https://placehold.co/40x40/5c5c5c/E2E8F0?text=CH'}" alt="Channel Thumbnail" class="w-10 h-10 rounded-full object-cover">
                            <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" class="text-gray-200 hover:underline hover:text-purple-400 transition-colors">${channel.title}</a>
                        </div>
                    </td>
                    <td class="p-4">${formatNumber(channel.subscribers)}</td>
                    <td class="p-4">${formatNumber(channel.videoCount)}</td>
                    <td class="p-4">${Object.keys(channel.socialLinks).length > 0 ? Object.keys(channel.socialLinks).join(', ') : 'N/A'}</td>
                `;
                frag.appendChild(tr);
            });
            $('resultsTbody').appendChild(frag);
            $('count').innerText = `${channels.length} channels`;
        }

        function resetResults() {
            LIB = [];
            $('resultsTbody').innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Enter your search queries and API key to begin.</td></tr>';
            $('count').innerText = '0 channels';
            updateMetrics();
            setProgress(0);
        }

        async function searchAll() {
            const queryRaw = $('query').value.trim();
            const queries = queryRaw.split(/[,\\n]/).map(q => q.trim()).filter(Boolean);
            const apiKey = $('apiKey').value;
            const perPage = $('perPage').value;
            const order = $('order').value;
            const duration = $('duration').value;

            if (!queries.length) {
                showMessage('Search Error', 'Please enter at least one query');
                return;
            }
            if (!apiKey) {
                showMessage('API Key Missing', 'Please enter your YouTube API key.');
                return;
            }

            logSearch(queries.join(', '));
            resetResults();
            setStatus('Searching...');
            let allChannels = new Map();

            for (const query of queries) {
                try {
                    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=channel&maxResults=${perPage}&order=${order}&videoDuration=${duration}&key=${apiKey}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    for (const item of data.items) {
                        if (!allChannels.has(item.snippet.channelId)) {
                            const details = await getChannelDetails(item.snippet.channelId);
                            if (details) {
                                const minSubs = parseInt($('minSubs').value) || 0;
                                const maxSubs = parseInt($('maxSubs').value) || Infinity;
                                if (details.subscribers >= minSubs && details.subscribers <= maxSubs) {
                                    allChannels.set(item.snippet.channelId, details);
                                }
                            }
                        }
                    }
                } catch (error) {
                    showMessage('API Error', `Search for "${query}" failed: ${error.message}`);
                    console.error('Search error:', error);
                }
            }

            LIB = Array.from(allChannels.values());
            renderResults(LIB);
            updateMetrics();
            setStatus('Search complete!');
        }

        async function deepSearchAll() {
            const queryRaw = $('query').value.trim();
            const queries = queryRaw.split(/[,\\n]/).map(q => q.trim()).filter(Boolean);
            const perPage = parseInt($('perPage').value);
            const order = $('order').value;
            const duration = $('duration').value;
            const pages = 20;
            
            if (!queries.length) {
                showMessage('Search Error', 'Please enter at least one query');
                return;
            }
            const apiKey = $('apiKey').value;
            if (!apiKey) {
                showMessage('API Key Missing', 'Please enter your YouTube API key.');
                return;
            }

            logSearch(queries.join(', '));
            resetResults();
            setStatus('Deep Searching...');
            const allChannels = new Map();
            let totalProcessed = 0;
            let totalQueries = queries.length;

            try {
                for (let i = 0; i < totalQueries; i++) {
                    const q = queries[i];
                    setStatus(`Deep Searching for "${q}"...`);

                    let nextPageToken = null;
                    for (let p = 0; p < pages; p++) {
                        try {
                            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&type=channel&maxResults=${perPage}&order=${order}&videoDuration=${duration}&key=${apiKey}&pageToken=${nextPageToken || ''}`;
                            const res = await fetch(url);
                            const data = await res.json();

                            if (data.error) throw new Error(data.error.message);

                            if (data.items.length === 0) {
                                break;
                            }

                            for (const item of data.items) {
                                if (!allChannels.has(item.snippet.channelId)) {
                                    const details = await getChannelDetails(item.snippet.channelId);
                                    if (details) {
                                        const minSubs = parseInt($('minSubs').value) || 0;
                                        const maxSubs = parseInt($('maxSubs').value) || Infinity;
                                        if (details.subscribers >= minSubs && details.subscribers <= maxSubs) {
                                            allChannels.set(item.snippet.channelId, details);
                                        }
                                    }
                                }
                            }
                            nextPageToken = data.nextPageToken;
                            if (!nextPageToken) break;
                            await new Promise(r => setTimeout(r, 1000)); // Respect API rate limits
                        } catch (error) {
                            showMessage('API Error', `YouTube API error for query "${q}": ${error.message}`);
                            console.error('API Error:', error);
                            return;
                        }
                    }
                    totalProcessed++;
                    setProgress(totalProcessed / totalQueries);
                }

                LIB = Array.from(allChannels.values());
                renderResults(LIB);
                updateMetrics();
                setStatus('Search complete!');

            } catch (e) {
                console.error(e);
                showMessage('Search Failed', 'An unexpected error occurred. Please check the console for details.');
                setStatus('Error');
            }
        }

        $('btnSearch').addEventListener('click', searchAll);
        $('btnDeepSearch').addEventListener('click', () => {
            showMessage('Deep Search Confirmation', 'Deep Search will consume more API credits by searching more pages. Do you want to continue?');
            $('messageBoxOk').onclick = () => {
                deepSearchAll();
                $('messageBoxOverlay').classList.add('opacity-0', 'pointer-events-none');
                $('messageBox').classList.remove('scale-100');
                $('messageBox').classList.add('scale-95');
            };
        });
        $('btnClear').addEventListener('click', resetResults);

        $('btnSaveLib').addEventListener('click', async () => {
            if (!currentUser) {
                return showMessage('Save Failed', 'Please sign in to save your library.');
            }
            try {
                const userDocRef = doc(db, PUBLIC_LIBRARIES_COLLECTION, currentUser.uid);
                await setDoc(userDocRef, {
                    library: LIB,
                    timestamp: new Date().toISOString()
                }, { merge: true });
                showMessage('Save Success', `Saved ${LIB.length} channels to your library.`);
            } catch (e) {
                console.error(e);
                showMessage('Save Failed', 'Failed to save library to Firestore. Check console for details.');
            }
        });

        $('btnLoadLib').addEventListener('click', async () => {
            if (!currentUser) {
                return showMessage('Load Failed', 'Please sign in to load your library.');
            }
            try {
                const userDocRef = doc(db, PUBLIC_LIBRARIES_COLLECTION, currentUser.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists() && docSnap.data().library) {
                    LIB = docSnap.data().library;
                    renderResults(LIB);
                    updateMetrics();
                    showMessage('Load Success', `Loaded ${LIB.length} channels from your library.`);
                } else {
                    showMessage('Load Failed', 'No saved library found.');
                }
            } catch (e) {
                console.error(e);
                showMessage('Load Failed', 'Failed to load library from Firestore. Data may be corrupted or permission denied.');
            }
        });
    </script>
</body>
</html>
