<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Lead Studio Pro — YouTube Channel Finder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d121c;
            color: #d1d5db;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevents scrolling */
        }
        
        /* Glassmorphism Panels */
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.8s ease-out;
        }

        /* Custom scrollbar for glassmorphism */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.7);
        }

        /* Status LED */
        .status-led-container {
            position: relative;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 1rem;
            height: 1rem;
        }

        .status-led {
            width: 0.5rem;
            height: 0.5rem;
            background-color: #f59e0b; /* amber for idle */
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .status-led-pulse {
            position: absolute;
            background-color: #f59e0b;
            border-radius: 50%;
            animation: pulse-ring 2s cubic-bezier(0.24, 0, 0.38, 1) infinite;
        }

        .status-led-active {
            background-color: #22c55e; /* green for active */
        }

        .status-led-error {
            background-color: #ef4444; /* red for error */
        }

        /* Custom buttons */
        .btn {
            @apply transition-transform transform hover:scale-105 active:scale-95 duration-200;
        }
    </style>
</head>
<body class="p-8 flex items-center justify-center">

    <!-- Authentication View -->
    <div id="auth-view" class="glass-panel p-10 flex flex-col gap-6 text-center max-w-lg w-full" style="display: none;">
        <h2 class="text-3xl font-bold text-white">Welcome to Lead Studio Pro</h2>
        <input id="authEmail" type="email" placeholder="Email" autocomplete="username" class="bg-white/5 rounded-lg border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200">
        <input id="authPass" type="password" placeholder="Password" autocomplete="current-password" class="bg-white/5 rounded-lg border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200">
        <div class="flex gap-4">
            <button class="btn flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg" id="btnSignIn">Sign In</button>
            <button class="btn flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold py-3 rounded-lg border border-gray-600" id="btnSignUp">Sign Up</button>
        </div>
        <div id="authStatus" class="text-sm text-red-400"></div>
    </div>

    <!-- Main App Dashboard View -->
    <div id="app-view" class="h-full w-full flex flex-col gap-6" style="display: none;">
        <!-- Header -->
        <header class="glass-panel p-6 flex items-center justify-between animate-fadeIn">
            <div class="flex items-center gap-4">
                <div class="status-led-container">
                    <span class="status-led-pulse" id="statusPulse"></span>
                    <span class="status-led" id="statusLed"></span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Lead Studio Pro</h1>
                    <p class="text-sm text-gray-400">Advanced YouTube Channel Finder</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="status" class="text-sm font-medium text-gray-300">Idle</div>
                <input id="apiKey" type="text" placeholder="YouTube API Key" value="AIzaSyBo5wWMC5T5lemycWNqtfs2_SAjApsLuFA" class="w-72 bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button class="btn bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-2 rounded-lg" id="btnSignOut">Sign Out</button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="flex-1 grid grid-cols-3 gap-6">
            <!-- Left Panel: Search & Filters -->
            <div class="col-span-1 glass-panel p-6 flex flex-col gap-6 overflow-hidden animate-fadeIn" style="animation-delay: 0.1s;">
                <h3 class="text-xl font-bold text-white">Search Filters</h3>
                <textarea id="query" placeholder="Enter one or more queries (comma or newline separated)" class="flex-1 min-h-24 bg-white/5 rounded-lg border border-white/10 px-4 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200"></textarea>
                <div class="grid grid-cols-2 gap-3">
                    <button class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg col-span-1" id="btnSearch">Search</button>
                    <button class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg col-span-1" id="btnDeepSearch">Deep Search</button>
                    <button class="btn bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold py-3 rounded-lg border border-gray-600 col-span-2" id="btnClear">Clear Search</button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 items-center">
                    <select id="order" class="bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="relevance">Order: Relevance</option>
                        <option value="date">Order: Date</option>
                        <option value="viewCount">Order: Views</option>
                        <option value="rating">Order: Rating</option>
                    </select>
                    <select id="duration" class="bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Duration: Any</option>
                        <option value="short">Short (&lt;4m)</option>
                        <option value="medium">Medium (4–20m)</option>
                        <option value="long">Long (&gt;20m)</option>
                    </select>
                    <select id="upload" class="bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Upload Time: Any</option>
                        <option value="hour">Last hour</option>
                        <option value="today">Today</option>
                        <option value="week">This week</option>
                        <option value="month">This month</option>
                    </select>
                    <select id="region" class="bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Region: Any</option>
                        <option>US</option>
                        <option>IN</option>
                        <option>GB</option>
                        <option>CA</option>
                        <option>AU</option>
                        <option>DE</option>
                    </select>
                    <select id="definition" class="bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Definition: Any</option>
                        <option value="high">HD</option>
                        <option value="standard">SD</option>
                    </select>
                    <select id="safe" class="bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Safe: Any</option>
                        <option value="none">None</option>
                        <option value="moderate">Moderate</option>
                        <option value="strict">Strict</option>
                    </select>
                    <input class="col-span-2 bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" id="perPage" type="number" min="1" max="50" value="25" placeholder="Results per page (1–50)"/>
                    <input class="col-span-2 bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" id="pages" type="number" min="1" max="10" value="2" placeholder="Pages per query (1–10)"/>
                    <div class="col-span-2 flex gap-4">
                        <input id="minSubs" type="number" placeholder="Min subs" class="flex-1 bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                        <input id="maxSubs" type="number" placeholder="Max subs" class="flex-1 bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                    </div>
                    <input class="col-span-2 bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" id="searchInResults" type="text" placeholder="Search within results (title / ID)"/>
                    <div class="col-span-2">
                        <input id="corsProxy" type="url" placeholder="Optional CORS proxy for verification" class="w-full bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                    </div>
                    <div class="col-span-2 flex justify-between items-center text-sm">
                        <span>Attempt verify check</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input id="doVerify" type="checkbox" value="" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="pt-2">
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between text-xs">
                            <div class="text-gray-400">Progress</div>
                            <div id="count" class="text-gray-400">0 channels</div>
                        </div>
                        <div class="flex h-2 mb-4 overflow-hidden text-xs bg-gray-700 rounded-lg">
                            <div id="progressBar" class="flex flex-col justify-center text-center text-white shadow-none whitespace-nowrap bg-purple-600 transition-all duration-300 ease-in-out" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Panel: Results Table -->
            <div class="col-span-2 glass-panel p-6 flex flex-col gap-6 overflow-hidden animate-fadeIn" style="animation-delay: 0.2s;">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-white">Search Results</h2>
                    <div class="flex gap-4 items-center">
                        <select id="clientSort" class="bg-white/5 rounded-lg border border-white/10 px-4 py-2 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="subs-desc">Sort: Subs ↓</option>
                            <option value="subs-asc">Sort: Subs ↑</option>
                            <option value="views-desc">Sort: Views ↓</option>
                            <option value="views-asc">Sort: Views ↑</option>
                            <option value="title-asc">Sort: Title A→Z</option>
                            <option value="title-desc">Sort: Title Z→A</option>
                        </select>
                        <button class="btn bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold px-4 py-2 rounded-lg" id="btnExportCSV">Export CSV</button>
                        <button class="btn bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold px-4 py-2 rounded-lg" id="btnExportJSON">Export JSON</button>
                        <button class="btn bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold px-4 py-2 rounded-lg" id="btnCopyIDs">Copy IDs</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scroll">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-[#0d121c]/90 backdrop-blur-sm z-10">
                            <tr class="text-left text-gray-400 font-semibold border-b border-gray-700">
                                <th class="p-4 rounded-tl-xl">
                                    <input type="checkbox" id="selectAllCheckbox" class="rounded-sm bg-gray-700 border-gray-500 text-purple-600 focus:ring-purple-500">
                                </th>
                                <th class="p-4">Channel</th>
                                <th class="p-4">Subs</th>
                                <th class="p-4">Videos</th>
                                <th class="p-4">Views</th>
                                <th class="p-4 rounded-tr-xl">Verified</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTbody"></tbody>
                    </table>
                </div>
                <div class="flex gap-4">
                    <button class="btn flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold py-3 rounded-lg border border-gray-600" id="btnSaveLib">Save Library</button>
                    <button class="btn flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold py-3 rounded-lg border border-gray-600" id="btnLoadLib">Load Library</button>
                    <button class="btn flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg" id="btnClearResults">Clear All</button>
                </div>
            </div>
            
            <!-- Right Panel: Channel Details -->
            <div class="col-span-1 glass-panel p-6 flex flex-col gap-6 animate-fadeIn" style="animation-delay: 0.3s;">
                <div class="flex items-center justify-between">
                    <h3 id="detailTitle" class="text-xl font-bold text-white">Select a channel</h3>
                    <div class="flex gap-4">
                        <button class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded-lg" id="btnExportSelected">Export Selected</button>
                        <button class="btn bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold px-4 py-2 rounded-lg" id="btnCopySelected">Copy CSV</button>
                    </div>
                </div>
                
                <div id="banner" class="w-full h-32 bg-gray-800 rounded-xl bg-center bg-cover overflow-hidden" style="display:none;"></div>
                
                <div id="detailContent" class="flex-1 overflow-y-auto custom-scroll text-sm flex flex-col gap-4">
                    <p class="text-gray-400">No channel selected. Click a channel from the search results to see details here.</p>
                </div>
            </div>
        </main>
        
        <div id="user-footer" class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900/50 backdrop-blur-sm z-50 text-right">
            <span id="userEmail" class="text-gray-400 text-sm"></span>
        </div>
    </div>

    <!-- Message Box Overlay -->
    <div id="messageBoxOverlay" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div id="messageBox" class="bg-gray-800 rounded-2xl p-8 max-w-lg text-center flex flex-col gap-6 transform scale-95 transition-transform duration-300">
            <h4 id="messageTitle" class="text-xl font-semibold text-white"></h4>
            <p id="messageText" class="text-gray-400"></p>
            <button class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg" id="messageBoxOk">OK</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";
        
        /* =========================
           STATE + HELPERS
           ========================= */
        const $ = id => document.getElementById(id);
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const esc = s => String(s ?? '').replace(/"/g,'""');

        const savedLibraryKey = 'lead_studio_pro_lib_v1';
        let currentUser = null;
        
        function setStatus(t){ 
            $('status').innerText = t; 
            $('statusLed').classList.remove('status-led-active', 'status-led-error');
            $('statusPulse').classList.remove('status-led-pulse');

            if (t === 'Idle') {
                $('statusLed').style.backgroundColor = '#f59e0b';
            } else if (t.includes('Error')) {
                $('statusLed').style.backgroundColor = '#ef4444';
            } else {
                $('statusLed').style.backgroundColor = '#22c55e';
                $('statusPulse').classList.add('status-led-pulse');
            }
        }

        function setProgress(p){ $('progressBar').style.width = Math.min(100, Math.round(p*100)) + '%'; }

        let LIB = []; // enriched channels
        let VIEW = []; // filtered/sorted view
        let lastExport = [];
        let lastSearch = {};
        
        function showMessage(title, message) {
            $('messageTitle').innerText = title;
            $('messageText').innerText = message;
            $('messageBoxOverlay').classList.remove('opacity-0', 'pointer-events-none');
            $('messageBox').classList.remove('scale-95');
            $('messageBox').classList.add('scale-100');
        }
        $('messageBoxOk').addEventListener('click', () => {
            $('messageBoxOverlay').classList.add('opacity-0', 'pointer-events-none');
            $('messageBox').classList.remove('scale-100');
            $('messageBox').classList.add('scale-95');
        });

        // === FIREBASE CONFIGURATION ===
        const firebaseConfig = {
          apiKey: "AIzaSyBvU3_Njbi1JQr_wD1a16h5coTW2ifaRDU",
          authDomain: "youleadmax.firebaseapp.com",
          projectId: "youleadmax",
          storageBucket: "youleadmax.firebasestorage.app",
          messagingSenderId: "710806971072",
          appId: "1:710806971072:web:ced903befe8693f886c325",
          measurementId: "G-JW9W20C1LQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const logSearchCallable = httpsCallable(functions, 'logSearch');

        /* ========================= AUTHENTICATION ========================= */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('app-view').style.display = 'flex';
                $('auth-view').style.display = 'none';
                $('userEmail').innerText = `Logged in as: ${user.email}`;

                // Log user usage for tracking purposes
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, {
                    lastLogin: new Date().toISOString()
                }, { merge: true });

            } else {
                currentUser = null;
                $('app-view').style.display = 'none';
                $('auth-view').style.display = 'flex';
            }
        });

        $('btnSignIn').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                $('authStatus').innerText = '';
            } catch (error) {
                $('authStatus').innerText = 'Sign-in failed: ' + error.message;
            }
        });

        $('btnSignUp').addEventListener('click', async () => {
            const email = $('authEmail').value;
            const pass = $('authPass').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                $('authStatus').innerText = '';
            } catch (error) {
                $('authStatus').innerText = 'Sign-up failed: ' + error.message;
            }
        });

        $('btnSignOut').addEventListener('click', async () => {
            await signOut(auth);
            resetResults();
        });
        
        $('selectAllCheckbox').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.sel').forEach(cb => cb.checked = isChecked);
        });

        /* ========================= SEARCH / FETCH ========================= */
        $('btnSearch').addEventListener('click', () => searchAll(false));
        $('btnDeepSearch').addEventListener('click', () => {
          const queryRaw = $('query').value.trim();
          if (!queryRaw.length) {
            showMessage('Search Error', 'Please enter at least one query');
            return;
          }
          
          if (!currentUser) {
            showMessage('Authentication Required', 'Please sign in first.');
            return;
          }
          
          showMessage('Deep Search Confirmation', 'Deep Search will consume more API credits by searching more pages. Do you want to continue?');
        });
        
        $('btnClear').addEventListener('click', () => { $('query').value=''; resetResults(); });
        $('query').addEventListener('keydown', e => { if(e.key==='Enter') searchAll(); });

        async function searchAll(isDeepSearch = false){
            const queryRaw = $('query').value.trim();
            const queries = queryRaw.split(/[,\\n]/).map(q=>q.trim()).filter(Boolean);
            const perPage = clamp(Number($('perPage').value||25), 1, 50);
            const pages = isDeepSearch ? 20 : clamp(Number($('pages').value||2), 1, 10);

            if(!queries.length){ showMessage('Search Error', 'Please enter at least one query'); return; }
            if(!currentUser){ showMessage('Authentication Required', 'Please sign in first.'); return; }

            try {
              await logSearchCallable({ query: queryRaw });
            } catch (error) {
              console.error('Failed to log search:', error);
            }

            resetResults();
            lastSearch = { queryRaw, queries, perPage, pages };
            
            setStatus('Searching...');
            const apiKey = $('apiKey').value.trim();
            const order = $('order').value;
            const duration = $('duration').value;
            const upload = $('upload').value;
            const region = $('region').value;
            const definition = $('definition').value;
            const safe = $('safe').value;
            let totalSteps = queries.length * pages;
            let done = 0;
            let chanIds = new Set();
            
            for(const q of queries){
                let pageToken = '';
                for(let i=0;i<pages;i++){
                    if(!pageToken && i>0) break;
                    
                    const url = new URL('https://www.googleapis.com/youtube/v3/search');
                    url.searchParams.set('part','snippet');
                    url.searchParams.set('type','video');
                    url.searchParams.set('q', q);
                    url.searchParams.set('maxResults', String(perPage));
                    url.searchParams.set('order', order);
                    if(region) url.searchParams.set('regionCode', region);
                    if(duration) url.searchParams.set('videoDuration', duration);
                    if(definition) url.searchParams.set('videoDefinition', definition);
                    if(upload) url.searchParams.set('publishedAfter', getPublishedAfterISO(upload));
                    if(pageToken) url.searchParams.set('pageToken', pageToken);
                    url.searchParams.set('key', apiKey);
                    
                    let resp;
                    try { resp = await fetch(url.toString()); }
                    catch(e){ console.error(e); showMessage('Network Error', 'A network error occurred during the search. Please check your connection.'); return; }
                    
                    if(!resp.ok){
                        const t = await resp.text();
                        showMessage('Search API Error', `YouTube API returned an error: ${resp.status}\n${t}`);
                        return;
                    }
                    
                    const data = await resp.json();
                    
                    (data.items || []).forEach(item => {
                        const t = (item.snippet.title||'').toLowerCase();
                        const d = (item.snippet.description||'').toLowerCase();
                        if(t.includes('#shorts') || t.includes('shorts ') || t.endsWith('shorts') || d.includes('#shorts') || d.includes('shorts ')) return;
                        const cid = item.snippet.channelId;
                        if(cid) chanIds.add(cid);
                    });
                    
                    pageToken = data.nextPageToken || '';
                    done++;
                    setProgress(done/totalSteps * 0.65);
                    await sleep(180);
                }
            }
            
            if(chanIds.size===0){ setStatus('No channels found'); setProgress(1); return; }
            
            setStatus(`Found ${chanIds.size} channels – fetching details...`);
            
            const ids = Array.from(chanIds);
            for(let i=0;i<ids.length;i+=50){
                const batch = ids.slice(i,i+50);
                const chURL = new URL('https://www.googleapis.com/youtube/v3/channels');
                chURL.searchParams.set('part','snippet,statistics,brandingSettings');
                chURL.searchParams.set('id', batch.join(','));
                chURL.searchParams.set('key', apiKey);
                
                let resp;
                try { resp = await fetch(chURL.toString()); }
                catch(e){ console.error(e); showMessage('Network Error', 'A network error occurred while fetching channel details.'); return; }
                
                if(!resp.ok){
                    const t = await resp.text();
                    showMessage('Channels API Error', `YouTube API returned an error: ${resp.status}\n${t}`);
                    return;
                }
                
                const data = await resp.json();
                
                (data.items||[]).forEach(ch => {
                    if(!ch.snippet || !ch.snippet.title) return;
                    const stats = ch.statistics || {};
                    const title = ch.snippet.title;
                    
                    let country = ch.snippet.country || '';
                    if(!country && ch.brandingSettings?.channel?.country){
                        country = ch.brandingSettings.channel.country;
                    }
                    
                    LIB.push({
                        title: title,
                        description: ch.snippet.description,
                        channelId: ch.id,
                        subs: Number(stats.subscriberCount||0),
                        views: Number(stats.viewCount||0),
                        videos: Number(stats.videoCount||0),
                        verified: (ch.snippet.customUrl||'').includes('channel') ? 'No' : 'Yes',
                        avatar: ch.snippet.thumbnails?.high?.url || ch.snippet.thumbnails?.default?.url || '',
                        banner: ch.brandingSettings?.image?.bannerExternalUrl || '',
                        country: country,
                        createdAt: ch.snippet.publishedAt.split('T')[0]
                    });
                    
                    done++;
                    setProgress(0.65 + (done/totalSteps * 0.35));
                });
                await sleep(180);
            }

            if(LIB.length===0){
                setStatus('No channels found');
            } else {
                applyClientFiltersAndRender();
                setStatus(`Found ${LIB.length} channels.`);
            }
            setProgress(1);
        }

        function getPublishedAfterISO(timeframe){
            const d = new Date();
            if(timeframe==='hour') d.setHours(d.getHours() - 1);
            if(timeframe==='today') d.setDate(d.getDate() - 1);
            if(timeframe==='week') d.setDate(d.getDate() - 7);
            if(timeframe==='month') d.setMonth(d.getMonth() - 1);
            return d.toISOString();
        }

        function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

        function applyClientFiltersAndRender(){
            const min = Number($('minSubs').value||0);
            const maxRaw = Number($('maxSubs').value||0);
            const max = maxRaw>0? maxRaw : Infinity;
            const needle = $('searchInResults').value.trim().toLowerCase();

            VIEW = LIB.filter(c => {
                if(c.subs < min) return false;
                if(c.subs > max) return false;
                if(needle){
                    const hit = (c.title?.toLowerCase().includes(needle)) || (c.channelId?.toLowerCase().includes(needle));
                    if(!hit) return false;
                }
                return true;
            });

            const sort = $('clientSort').value;
            VIEW.sort((a,b) => {
                if(sort==='subs-desc') return (b.subs||0) - (a.subs||0);
                if(sort==='subs-asc') return (a.subs||0) - (b.subs||0);
                if(sort==='views-desc')return (b.views||0) - (a.views||0);
                if(sort==='views-asc') return (a.views||0) - (b.views||0);
                if(sort==='title-asc') return (a.title||'').localeCompare(b.title||'');
                if(sort==='title-desc')return (b.title||'').localeCompare(a.title||'');
                return 0;
            });

            renderResults(VIEW);
            lastExport = VIEW.slice();
            $('count').innerText = VIEW.length + ' channels';
        }

        /* ========================= RENDER RESULTS + DETAILS ========================= */
        $('clientSort').addEventListener('change', applyClientFiltersAndRender);
        $('minSubs').addEventListener('input', applyClientFiltersAndRender);
        $('maxSubs').addEventListener('input', applyClientFiltersAndRender);
        $('searchInResults').addEventListener('input', applyClientFiltersAndRender);

        function renderResults(list){
            const tbody = $('resultsTbody');
            tbody.innerHTML = '';
            if(!list.length){
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No channels match your filters.</td></tr>`;
                return;
            }
            list.forEach((c, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition-colors duration-200 cursor-pointer border-b border-gray-700 last:border-b-0";
                tr.innerHTML = `
                    <td class="p-4 rounded-l-xl"><input type="checkbox" class="sel rounded-sm bg-gray-700 border-gray-500 text-purple-600 focus:ring-purple-500" data-idx="${idx}"/></td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${sanitize(c.avatar)}" class="w-12 h-12 rounded-lg object-cover" alt="">
                            <div>
                                <strong class="text-white">${sanitize(c.title)}</strong>
                                <span class="block text-xs text-gray-400">${sanitize(c.channelId)}</span>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">${c.hidden ? 'Hidden' : (c.subs||0).toLocaleString()}</td>
                    <td class="p-4">${(c.videos||0).toLocaleString()}</td>
                    <td class="p-4">${(c.views||0).toLocaleString()}</td>
                    <td class="p-4 rounded-r-xl">${c.verified}</td>
                `;
                tr.addEventListener('click', e => {
                    if(e.target.type !== 'checkbox'){
                        renderDetails(c);
                    }
                });
                tbody.appendChild(tr);
            });
        }
        
        async function renderDetails(c){
            $('detailTitle').innerText = c.title;
            const socialLinks = await getSocialLinksFromAboutPage(c.channelId);

            $('detailContent').innerHTML = `
                <div class="flex flex-col gap-4">
                    <p class="text-gray-400 text-sm">Channel ID: ${c.channelId} • ${c.country} • Created: ${c.createdAt}</p>
                    <p class="text-gray-300 leading-relaxed">${sanitize(c.description)}</p>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                        <strong class="text-white text-lg block">${c.subs.toLocaleString()}</strong>
                        <span class="text-gray-400 text-sm">Subscribers</span>
                    </div>
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                        <strong class="text-white text-lg block">${c.views.toLocaleString()}</strong>
                        <span class="text-gray-400 text-sm">Total Views</span>
                    </div>
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                        <strong class="text-white text-lg block">${c.videos.toLocaleString()}</strong>
                        <span class="text-gray-400 text-sm">Total Videos</span>
                    </div>
                </div>
                
                <h4 class="text-lg font-semibold text-white mt-4">Social Links</h4>
                <div class="flex flex-wrap gap-2">
                    ${socialLinks.website?`<a href="${sanitize(socialLinks.website)}" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2 rounded-lg transition-colors">Website</a>`:''}
                    ${socialLinks.twitter?`<a href="${sanitize(socialLinks.twitter)}" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2 rounded-lg transition-colors">Twitter</a>`:''}
                    ${socialLinks.instagram?`<a href="${sanitize(socialLinks.instagram)}" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2 rounded-lg transition-colors">Instagram</a>`:''}
                    ${socialLinks.facebook?`<a href="${sanitize(socialLinks.facebook)}" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2 rounded-lg transition-colors">Facebook</a>`:''}
                    ${socialLinks.tiktok?`<a href="${sanitize(socialLinks.tiktok)}" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2 rounded-lg transition-colors">TikTok</a>`:''}
                    ${socialLinks.linkedin?`<a href="${sanitize(socialLinks.linkedin)}" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2 rounded-lg transition-colors">LinkedIn</a>`:''}
                </div>
                
                <h4 class="text-lg font-semibold text-white mt-4">Latest Videos <span class="text-gray-500 text-xs">(up to 6)</span></h4>
                <div class="grid grid-cols-2 gap-4" id="latestVideos">
                    <p class="text-gray-400">Loading...</p>
                </div>
            `;
            if(c.banner){
                $('banner').style.display = 'block';
                $('banner').style.backgroundImage = `url(${sanitize(c.banner)})`;
            } else {
                $('banner').style.display = 'none';
            }
            
            loadLatestVideos(c.channelId);
        }

        /* ========================= UTIL ========================= */
        function resetResults(){
            LIB = []; VIEW = []; lastExport = [];
            $('resultsTbody').innerHTML='<tr><td colspan="6" class="p-4 text-center text-gray-500">No channels match your filters.</td></tr>'; 
            $('count').innerText='0 channels';
            $('detailTitle').innerText = 'Select a channel';
            $('detailContent').innerHTML = '<p class="text-gray-400">No channel selected. Click a channel from the search results to see details here.</p>';
            $('banner').style.display='none'; $('banner').style.backgroundImage='none';
            setProgress(0); setStatus('Idle');
        }

        function sanitize(s){ try{ return s.replace(/</g,'<'); } catch(e){return '';} }

        async function loadLatestVideos(channelId){
            const apiKey = $('apiKey').value.trim();
            const box = $('latestVideos');
            try{
                const u = new URL('https://www.googleapis.com/youtube/v3/search');
                u.searchParams.set('part','snippet');
                u.searchParams.set('channelId', channelId);
                u.searchParams.set('order','date');
                u.searchParams.set('maxResults','6');
                u.searchParams.set('type','video');
                u.searchParams.set('key', apiKey);
                const r = await fetch(u.toString());
                if(!r.ok){
                    box.innerHTML = '<p class="text-gray-400">Cannot load videos.</p>';
                    return;
                }
                const data = await r.json();
                if(!data.items?.length){
                    box.innerHTML = '<p class="text-gray-400">No recent videos.</p>';
                    return;
                }
                box.innerHTML='';
                data.items.forEach(it => {
                    const vid = it.id.videoId;
                    const thumb = it.snippet.thumbnails?.medium?.url || it.snippet.thumbnails?.default?.url || '';
                    const title = it.snippet.title || '';
                    const card = document.createElement('div');
                    card.className = 'bg-white/5 border border-white/10 rounded-xl p-3';
                    card.innerHTML = `
                        <img src="${sanitize(thumb)}" class="w-full h-24 object-cover rounded-lg" alt="">
                        <h4 class="text-white font-semibold mt-2 text-sm">${sanitize(title)}</h4>
                        <div class="flex gap-2 mt-2">
                            <button class="btn flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 rounded-lg text-xs" onclick="window.open('https://www.youtube.com/watch?v=${vid}')">Open</button>
                            <button class="btn flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold py-2 rounded-lg text-xs" onclick="embed('${vid}')">Preview</button>
                        </div>
                    `;
                    box.appendChild(card);
                });
            }catch(e){
                console.error(e);
                box.innerHTML = '<p class="text-gray-400">Error loading videos.</p>';
            }
        }
        
        function embed(videoId){
            let frame = document.getElementById('previewFrame');
            if(frame){ frame.remove(); }
            frame = document.createElement('iframe');
            frame.id='previewFrame';
            frame.className = "w-full h-60 rounded-xl mt-4";
            frame.src=`https://www.youtube.com/embed/${videoId}?autoplay=1`;
            frame.setAttribute('allow','accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture');
            $('detailContent').appendChild(frame);
        }
        
        async function copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }

        /* ========================= EXPORTING ========================= */
        $('btnExportCSV').addEventListener('click', () => {
            const rows = lastExport;
            if(!rows.length) return showMessage('Export Failed', 'No results to export');
            downloadText(toCSV(rows), 'lead_studio_pro.csv', 'text/csv');
        });
        $('btnExportJSON').addEventListener('click', () => {
            const rows = lastExport.map(cToSafe);
            if(!rows.length) return showMessage('Export Failed', 'No results to export');
            downloadText(JSON.stringify(rows,null,2), 'lead_studio_pro.json', 'application/json');
        });
        $('btnCopyIDs').addEventListener('click', async () => {
            const rows = lastExport;
            if(!rows.length) return showMessage('Copy Failed', 'No results to copy');
            const ids = rows.map(r=>r.channelId).join('\n');
            await copyText(ids);
            showMessage('Copy Success', 'Channel IDs copied to clipboard.');
        });
        
        $('btnExportSelected').addEventListener('click', () => {
            const rows = getSelected();
            if(!rows.length) return showMessage('Export Failed', 'Select some rows first');
            downloadText(toCSV(rows), 'lead_studio_pro_selected.csv', 'text/csv');
        });
        $('btnCopySelected').addEventListener('click', async () => {
            const rows = getSelected();
            if(!rows.length) return showMessage('Copy Failed', 'Select some rows first');
            const csv = toCSV(rows);
            await copyText(csv);
            showMessage('Copy Success', 'Selected CSV copied to clipboard.');
        });
        $('btnClearResults').addEventListener('click', () => {
          resetResults();
          showMessage('Results Cleared', 'All search results have been cleared.');
        });

        function getSelected(){
            return Array.from(document.querySelectorAll('.sel:checked')).map(cb => VIEW[Number(cb.dataset.idx)]).filter(Boolean);
        }

        function toCSV(arr){
            const fields = ['channel','subs','videos','views','verified','channelId','country','createdAt'];
            let out = fields.map(f=>`"${f}"`).join(',')+'\n';
            arr.forEach(r => {
                out += `"${esc(r.title)}","${r.hidden?'Hidden':r.subs}","${r.videos}","${r.views}","${r.verified}","${r.channelId}","${esc(r.country)}","${r.createdAt}"\n`;
            });
            return out;
        }

        function downloadText(text, filename, type){
            const blob = new Blob([text], {type: type});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function cToSafe(c){
            return {
                channelId:c.channelId,
                title:c.title,
                subs:c.subs,
                views:c.views,
                videos:c.videos,
                verified:c.verified,
                country:c.country,
                createdAt:c.createdAt
            };
        }

        $('btnSaveLib').addEventListener('click', () => {
            if(!LIB.length) return showMessage('Save Failed', 'No channels to save.');
            try {
                localStorage.setItem(savedLibraryKey, JSON.stringify(LIB));
                showMessage('Save Success', `Saved ${LIB.length} channels to local storage.`);
            } catch(e){
                showMessage('Save Failed', 'Failed to save library. Local storage might be full.');
            }
        });

        $('btnLoadLib').addEventListener('click', () => {
            const data = localStorage.getItem(savedLibraryKey);
            if(!data) return showMessage('Load Failed', 'No saved library found.');
            try{
                const loaded = JSON.parse(data);
                LIB = loaded;
                applyClientFiltersAndRender();
                showMessage('Load Success', `Loaded ${LIB.length} channels from local storage.`);
            } catch(e){
                showMessage('Load Failed', 'Failed to load library. Data may be corrupted.');
            }
        });

        async function getSocialLinksFromAboutPage(channelId) {
            const proxyUrl = $('corsProxy').value || '';
            const aboutUrl = `${proxyUrl}https://www.youtube.com/channel/${channelId}/about`;
            
            try {
                const response = await fetch(aboutUrl);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const socialLinks = {};
                const linkElements = doc.querySelectorAll('.yt-formatted-string a');
                
                linkElements.forEach(link => {
                    const url = link.href;
                    if (url.includes('twitter.com')) socialLinks.twitter = url;
                    else if (url.includes('instagram.com')) socialLinks.instagram = url;
                    else if (url.includes('facebook.com')) socialLinks.facebook = url;
                    else if (url.includes('tiktok.com')) socialLinks.tiktok = url;
                    else if (url.includes('linkedin.com')) socialLinks.linkedin = url;
                    else if (!socialLinks.website) socialLinks.website = url;
                });
                
                return socialLinks;
            } catch (error) {
                console.error('Failed to retrieve social links:', error);
                return {};
            }
        }
    </script>
</body>
</html>
