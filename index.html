<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lead Studio Pro — YouTube Channel Finder</title>
<style>
  /* =========================
     NOTION-INSPIRED DESIGN SYSTEM
     ========================= */
  :root {
    /* Light Theme (Default) */
    --bg-primary: #ffffff;
    --bg-secondary: #f7f6f3;
    --bg-tertiary: #f1f1ef;
    --bg-hover: #f1f1ef;
    --bg-selected: #e9e9e7;
    --bg-sidebar: #f7f6f3;
    
    /* Dark Theme */
    --bg-primary-dark: #191919;
    --bg-secondary-dark: #2f3437;
    --bg-tertiary-dark: #373c41;
    --bg-hover-dark: #2f3437;
    --bg-selected-dark: #37352f;
    --bg-sidebar-dark: #2f3437;
    
    /* Text Colors */
    --text-primary: #37352f;
    --text-secondary: #787774;
    --text-tertiary: #9b9a97;
    --text-inverse: #ffffff;
    
    /* Dark Theme Text */
    --text-primary-dark: #ffffff;
    --text-secondary-dark: #9b9a97;
    --text-tertiary-dark: #6f6e69;
    --text-inverse-dark: #37352f;
    
    /* Accent Colors */
    --accent-blue: #2383e2;
    --accent-blue-light: #e1ecf7;
    --accent-red: #e03e3e;
    --accent-red-light: #fdf2f2;
    --accent-green: #0f7b0f;
    --accent-green-light: #edfded;
    --accent-purple: #8b46ff;
    --accent-purple-light: #f4f0ff;
    --accent-orange: #d9730d;
    --accent-orange-light: #fdf4e8;
    
    /* Border & Shadows */
    --border-color: #e9e9e7;
    --border-color-dark: #37352f;
    --shadow-small: 0px 1px 3px rgba(15, 15, 15, 0.1);
    --shadow-medium: 0px 2px 8px rgba(15, 15, 15, 0.1);
    --shadow-large: 0px 4px 16px rgba(15, 15, 15, 0.1);
    
    /* Spacing & Layout */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 12px;
    --space-lg: 16px;
    --space-xl: 24px;
    --space-xxl: 32px;
    --border-radius: 6px;
    --border-radius-lg: 12px;
    
    /* Typography */
    --font-title: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
    --font-body: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
    --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    
    /* Animation */
    --transition-fast: 0.15s ease;
    --transition-smooth: 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
  }

  /* Theme Classes */
  [data-theme="dark"] {
    --bg-primary: var(--bg-primary-dark);
    --bg-secondary: var(--bg-secondary-dark);
    --bg-tertiary: var(--bg-tertiary-dark);
    --bg-hover: var(--bg-hover-dark);
    --bg-selected: var(--bg-selected-dark);
    --bg-sidebar: var(--bg-sidebar-dark);
    --text-primary: var(--text-primary-dark);
    --text-secondary: var(--text-secondary-dark);
    --text-tertiary: var(--text-tertiary-dark);
    --text-inverse: var(--text-inverse-dark);
    --border-color: var(--border-color-dark);
  }

  /* Base Styles */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    font-family: var(--font-body);
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-primary);
    background-color: var(--bg-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Scrollbar Styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: transparent;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--text-tertiary);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
  }

  /* Typography */
  h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-title);
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
  }

  h1 { font-size: 28px; }
  h2 { font-size: 24px; }
  h3 { font-size: 20px; }
  h4 { font-size: 16px; }

  p {
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
  }

  a {
    color: var(--accent-blue);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  a:hover {
    color: var(--accent-blue);
    text-decoration: underline;
  }

  /* Layout */
  .app {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: var(--bg-primary);
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-lg) var(--space-xl);
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-primary);
    min-height: 64px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .brand h1 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .brand .subtitle {
    font-size: 12px;
    color: var(--text-tertiary);
    font-weight: 400;
  }

  .header-controls {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  /* Search Section */
  .search-section {
    padding: var(--space-xl);
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-primary);
  }

  .search-container {
    max-width: 800px;
    margin: 0 auto;
  }

  .search-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
  }

  .search-input-group {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .search-controls {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
    flex-wrap: wrap;
  }

  /* Main Content */
  .main-content {
    flex: 1;
    display: grid;
    grid-template-columns: 280px 1fr 360px;
    gap: 0;
    min-height: 0;
  }

  /* Sidebar */
  .sidebar {
    background-color: var(--bg-sidebar);
    border-right: 1px solid var(--border-color);
    padding: var(--space-lg);
    overflow-y: auto;
  }

  .sidebar-section {
    margin-bottom: var(--space-xl);
  }

  .sidebar-section h3 {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-md);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .filter-row {
    display: flex;
    gap: var(--space-sm);
  }

  /* Results Panel */
  .results-panel {
    display: flex;
    flex-direction: column;
    background-color: var(--bg-primary);
    min-height: 0;
  }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-primary);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .results-count {
    font-weight: 500;
    color: var(--text-primary);
  }

  .results-actions {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }

  .results-table-container {
    flex: 1;
    overflow: auto;
  }

  /* Details Panel */
  .details-panel {
    background-color: var(--bg-sidebar);
    border-left: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .details-header {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-sidebar);
  }

  .details-content {
    flex: 1;
    padding: var(--space-lg);
    overflow-y: auto;
  }

  /* Form Elements */
  .input, .select, .textarea {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 14px;
    transition: all var(--transition-fast);
  }

  .input:focus, .select:focus, .textarea:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(35, 131, 226, 0.1);
  }

  .input::placeholder, .textarea::placeholder {
    color: var(--text-tertiary);
  }

  .textarea {
    resize: vertical;
    min-height: 80px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
    white-space: nowrap;
  }

  .btn:hover {
    background-color: var(--bg-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-small);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-primary {
    background-color: var(--accent-blue);
    border-color: var(--accent-blue);
    color: white;
  }

  .btn-primary:hover {
    background-color: #1a75d1;
    border-color: #1a75d1;
    color: white;
  }

  .btn-danger {
    background-color: var(--accent-red);
    border-color: var(--accent-red);
    color: white;
  }

  .btn-danger:hover {
    background-color: #c73333;
    border-color: #c73333;
    color: white;
  }

  .btn-small {
    padding: var(--space-xs) var(--space-sm);
    font-size: 12px;
  }

  /* Tables */
  .table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--bg-primary);
  }

  .table th {
    text-align: left;
    padding: var(--space-md);
    background-color: var(--bg-secondary);
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 5;
  }

  .table td {
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
  }

  .table tr:hover {
    background-color: var(--bg-hover);
  }

  .table tr.selected {
    background-color: var(--bg-selected);
  }

  /* Channel Avatar */
  .channel-avatar {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius);
    object-fit: cover;
    border: 1px solid var(--border-color);
  }

  .channel-info {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .channel-name {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
  }

  .channel-id {
    font-size: 12px;
    color: var(--text-tertiary);
    font-family: var(--font-mono);
  }

  /* Progress Bar */
  .progress {
    width: 200px;
    height: 4px;
    background-color: var(--bg-tertiary);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background-color: var(--accent-blue);
    transition: width var(--transition-smooth);
    border-radius: 2px;
  }

  /* Status Indicator */
  .status {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background-color: var(--bg-tertiary);
    border-radius: var(--border-radius);
    font-size: 12px;
    font-weight: 500;
  }

  .status.idle { color: var(--text-secondary); }
  .status.loading { color: var(--accent-blue); }
  .status.success { color: var(--accent-green); }
  .status.error { color: var(--accent-red); }

  /* Switch/Toggle */
  .switch {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
  }

  .switch input {
    display: none;
  }

  .switch-track {
    width: 36px;
    height: 20px;
    background-color: var(--bg-tertiary);
    border-radius: 10px;
    position: relative;
    transition: background-color var(--transition-fast);
  }

  .switch-thumb {
    width: 16px;
    height: 16px;
    background-color: white;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: transform var(--transition-fast);
    box-shadow: var(--shadow-small);
  }

  .switch input:checked + .switch-track {
    background-color: var(--accent-blue);
  }

  .switch input:checked + .switch-track .switch-thumb {
    transform: translateX(16px);
  }

  /* Authentication Form */
  .auth-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background-color: var(--bg-secondary);
    padding: var(--space-xl);
  }

  .auth-card {
    width: 100%;
    max-width: 400px;
    background-color: var(--bg-primary);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-large);
    padding: var(--space-xxl);
  }

  .auth-header {
    text-align: center;
    margin-bottom: var(--space-xl);
  }

  .auth-header h2 {
    margin-bottom: var(--space-sm);
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .auth-status {
    color: var(--accent-red);
    font-size: 12px;
    text-align: center;
  }

  /* Modal/Message Box */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal {
    background-color: var(--bg-primary);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-large);
    padding: var(--space-xl);
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
  }

  .modal-title {
    font-size: 18px;
    font-weight: 600;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--border-radius);
  }

  .modal-close:hover {
    background-color: var(--bg-hover);
  }

  .modal-content {
    margin-bottom: var(--space-lg);
  }

  .modal-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
  }

  /* Theme Toggle */
  .theme-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background-color: var(--bg-primary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .theme-toggle:hover {
    background-color: var(--bg-hover);
  }

  /* Keyboard Shortcuts */
  .kbd {
    display: inline-block;
    padding: 2px 6px;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
  }

  /* Video Cards */
  .video-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-lg);
  }

  .video-card {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    overflow: hidden;
    transition: all var(--transition-fast);
  }

  .video-card:hover {
    box-shadow: var(--shadow-medium);
    transform: translateY(-1px);
  }

  .video-thumbnail {
    width: 100%;
    height: 120px;
    object-fit: cover;
  }

  .video-info {
    padding: var(--space-md);
  }

  .video-title {
    font-weight: 500;
    font-size: 13px;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    line-height: 1.3;
  }

  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-md);
    margin: var(--space-lg) 0;
  }

  .stat-card {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--space-lg);
    text-align: center;
  }

  .stat-value {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
  }

  .stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .main-content {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto 1fr;
    }
    
    .sidebar {
      border-right: none;
      border-bottom: 1px solid var(--border-color);
    }
    
    .details-panel {
      border-left: none;
      border-top: 1px solid var(--border-color);
    }
  }

  @media (max-width: 768px) {
    .search-section {
      padding: var(--space-lg);
    }
    
    .search-input-group {
      flex-direction: column;
    }
    
    .header {
      padding: var(--space-md);
    }
    
    .brand h1 {
      font-size: 16px;
    }
    
    .sidebar,
    .details-panel {
      padding: var(--space-md);
    }
  }

  /* Utility Classes */
  .hidden { display: none !important; }
  .flex { display: flex; }
  .items-center { align-items: center; }
  .justify-between { justify-content: space-between; }
  .gap-sm { gap: var(--space-sm); }
  .gap-md { gap: var(--space-md); }
  .mt-sm { margin-top: var(--space-sm); }
  .mt-md { margin-top: var(--space-md); }
  .mb-md { margin-bottom: var(--space-md); }
  .text-sm { font-size: 12px; }
  .text-muted { color: var(--text-secondary); }
  .font-mono { font-family: var(--font-mono); }
  .truncate { 
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Loading Animation */
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading {
    animation: spin 1s linear infinite;
  }

  /* Enhanced Search Highlight */
  .highlight {
    background-color: var(--accent-purple-light);
    padding: 1px 2px;
    border-radius: 2px;
  }

  /* Notification Toast */
  .toast {
    position: fixed;
    top: var(--space-lg);
    right: var(--space-lg);
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-large);
    padding: var(--space-md) var(--space-lg);
    max-width: 400px;
    z-index: 1001;
    transform: translateX(100%);
    transition: transform var(--transition-smooth);
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast.success {
    border-left: 4px solid var(--accent-green);
  }

  .toast.error {
    border-left: 4px solid var(--accent-red);
  }

  .toast.info {
    border-left: 4px solid var(--accent-blue);
  }
</style>
</head>
<body>
    <!-- Authentication View -->
    <div id="auth-view" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h2>Welcome to Lead Studio Pro</h2>
                <p class="text-muted">Advanced YouTube Channel Discovery Platform</p>
            </div>
            <form class="auth-form">
                <div>
                    <input id="authEmail" class="input" type="email" placeholder="Email address" autocomplete="username" required>
                </div>
                <div>
                    <input id="authPass" class="input" type="password" placeholder="Password" autocomplete="current-password" required>
                </div>
                <button type="button" class="btn btn-primary" id="btnSignIn">Sign In</button>
                <button type="button" class="btn" id="btnSignUp">Create Account</button>
                <div id="authStatus" class="auth-status"></div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-view" class="app hidden">
        <!-- Header -->
        <header class="header">
            <div class="brand">
                <div>
                    <h1>Lead Studio Pro</h1>
                    <div class="subtitle">Advanced YouTube Channel Discovery</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="theme-toggle" id="themeToggle">
                    <span id="themeIcon">🌙</span>
                </div>
                <div class="status" id="headerStatus">
                    <span>Ready</span>
                </div>
                <div id="userInfo" class="text-sm text-muted"></div>
                <button class="btn" id="btnSignOut">Sign Out</button>
            </div>
        </header>

        <!-- Search Section -->
        <section class="search-section">
            <div class="search-container">
                <div class="search-header">
                    <h3>Search YouTube Channels</h3>
                    <div class="text-sm text-muted">
                        Use <span class="kbd">Ctrl+K</span> to focus search
                    </div>
                </div>
                <div class="search-input-group">
                    <input id="apiKey" class="input" type="text" placeholder="YouTube API Key" 
                           value="AIzaSyBo5wWMC5T5lemycWNqtfs2_SAjApsLuFA" style="flex: 0 0 300px;">
                    <textarea id="query" class="textarea" placeholder="Enter search queries (comma or newline separated)&#10;Example: tech tutorials, cooking videos" style="flex: 1;"></textarea>
                </div>
                <div class="search-controls">
                    <button class="btn btn-primary" id="btnSearch">
                        <span>🔍</span>
                        Search
                    </button>
                    <button class="btn btn-primary" id="btnDeepSearch" style="background-color: var(--accent-purple);">
                        <span>⚡</span>
                        Deep Search
                    </button>
                    <button class="btn" id="btnClear">Clear</button>
                    <div class="progress" id="searchProgress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3>Search Filters</h3>
                    <div class="filter-group">
                        <select id="order" class="select">
                            <option value="relevance">Sort by Relevance</option>
                            <option value="date">Sort by Date</option>
                            <option value="viewCount">Sort by Views</option>
                            <option value="rating">Sort by Rating</option>
                        </select>
                        <select id="duration" class="select">
                            <option value="">Any Duration</option>
                            <option value="short">Short (&lt;4min)</option>
                            <option value="medium">Medium (4–20min)</option>
                            <option value="long">Long (&gt;20min)</option>
                        </select>
                        <select id="upload" class="select">
                            <option value="">Any Upload Time</option>
                            <option value="hour">Last Hour</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                        <select id="region" class="select">
                            <option value="">Any Region</option>
                            <option value="US">United States</option>
                            <option value="IN">India</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                        </select>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Channel Filters</h3>
                    <div class="filter-group">
                        <div class="filter-row">
                            <input id="minSubs" class="input" type="number" placeholder="Min subscribers" min="0">
                            <input id="maxSubs" class="input" type="number" placeholder="Max subscribers" min="0">
                        </div>
                        <input id="perPage" class="input" type="number" min="1" max="50" value="25" placeholder="Results per page (1-50)">
                        <input id="pages" class="input" type="number" min="1" max="10" value="2" placeholder="Pages per query (1-10)">
                        <input id="searchInResults" class="input" type="text" placeholder="Search in results...">
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Advanced Options</h3>
                    <div class="filter-group">
                        <input id="corsProxy" class="input" type="url" placeholder="CORS proxy URL (optional)">
                        <label class="switch">
                            <input id="doVerify" type="checkbox">
                            <div class="switch-track">
                                <div class="switch-thumb"></div>
                            </div>
                            <span class="text-sm">Verify channels</span>
                        </label>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Library</h3>
                    <div class="filter-group">
                        <button class="btn" id="btnSaveLib">💾 Save Library</button>
                        <button class="btn" id="btnLoadLib">📂 Load Library</button>
                    </div>
                </div>
            </aside>

            <!-- Results Panel -->
            <section class="results-panel">
                <div class="results-header">
                    <div class="results-count" id="resultsCount">0 channels found</div>
                    <div class="results-actions">
                        <select id="clientSort" class="select">
                            <option value="subs-desc">Sort by Subscribers ↓</option>
                            <option value="subs-asc">Sort by Subscribers ↑</option>
                            <option value="views-desc">Sort by Views ↓</option>
                            <option value="views-asc">Sort by Views ↑</option>
                            <option value="title-asc">Sort by Title A→Z</option>
                            <option value="title-desc">Sort by Title Z→A</option>
                        </select>
                        <button class="btn btn-small" id="btnSelectAll">Select All</button>
                        <button class="btn btn-small" id="btnDeselectAll">Deselect</button>
                        <button class="btn btn-primary btn-small" id="btnExportCSV">Export CSV</button>
                        <button class="btn btn-small" id="btnExportJSON">Export JSON</button>
                        <button class="btn btn-small" id="btnCopyIDs">Copy IDs</button>
                        <button class="btn btn-danger btn-small" id="btnClearResults">Clear All</button>
                    </div>
                </div>
                <div class="results-table-container">
                    <table class="table" id="resultsTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Channel</th>
                                <th style="width: 120px;">Subscribers</th>
                                <th style="width: 100px;">Videos</th>
                                <th style="width: 120px;">Views</th>
                                <th style="width: 80px;">Verified</th>
                                <th style="width: 100px;">Country</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTbody">
                            <tr>
                                <td colspan="7" class="text-muted" style="text-align: center; padding: 40px;">
                                    Enter search terms above to find YouTube channels
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Details Panel -->
            <aside class="details-panel">
                <div class="details-header">
                    <h3 id="detailTitle">Channel Details</h3>
                    <div class="flex gap-sm">
                        <button class="btn btn-small" id="btnExportSelected">Export Selected</button>
                        <button class="btn btn-small" id="btnCopySelected">Copy Selected</button>
                    </div>
                </div>
                <div class="details-content" id="detailContent">
                    <div class="text-muted" style="text-align: center; padding: 40px;">
                        Select a channel from the table to view details
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modal -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Confirmation</h3>
                <button class="modal-close" id="modalClose">×</button>
            </div>
            <div class="modal-content">
                <p id="modalMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-actions" id="modalActions">
                <button class="btn" id="modalCancel">Cancel</button>
                <button class="btn btn-primary" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div id="toastMessage"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";
        
        /* =========================
           ENHANCED STATE MANAGEMENT & UTILITIES
           ========================= */
        const $ = id => document.getElementById(id);
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const esc = s => String(s ?? '').replace(/"/g, '""');
        const sanitize = s => {
            try {
                return String(s ?? '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            } catch(e) {
                return '';
            }
        };

        // Enhanced library key with versioning
        const savedLibraryKey = 'lead_studio_pro_lib_v2';
        let currentUser = null;
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // Application State
        let LIB = []; // All discovered channels
        let VIEW = []; // Filtered/sorted view
        let lastExport = [];
        let searchCache = new Map(); // Cache for search results
        let abortController = null; // For canceling requests

        /* =========================
           ENHANCED UI HELPERS
           ========================= */
        function setStatus(text, type = 'info') {
            const statusEl = $('headerStatus');
            statusEl.innerHTML = `<span>${text}</span>`;
            statusEl.className = `status ${type}`;
        }

        function setProgress(percent) {
            const progressBar = $('progressBar');
            progressBar.style.width = `${Math.min(100, Math.max(0, percent * 100))}%`;
        }

        function showToast(message, type = 'info') {
            const toast = $('toast');
            const toastMessage = $('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        function showModal(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                $('modalTitle').textContent = title;
                $('modalMessage').textContent = message;
                $('modalConfirm').textContent = confirmText;
                $('modalCancel').textContent = cancelText;
                
                const overlay = $('modalOverlay');
                overlay.style.display = 'flex';
                
                const handleConfirm = () => {
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    overlay.style.display = 'none';
                    $('modalConfirm').removeEventListener('click', handleConfirm);
                    $('modalCancel').removeEventListener('click', handleCancel);
                    $('modalClose').removeEventListener('click', handleCancel);
                };
                
                $('modalConfirm').addEventListener('click', handleConfirm);
                $('modalCancel').addEventListener('click', handleCancel);
                $('modalClose').addEventListener('click', handleCancel);
            });
        }

        /* =========================
           THEME MANAGEMENT
           ========================= */
        function initTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeIcon();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            $('themeIcon').textContent = currentTheme === 'dark' ? '☀️' : '🌙';
        }

        $('themeToggle').addEventListener('click', toggleTheme);

        /* =========================
           KEYBOARD SHORTCUTS
           ========================= */
        document.addEventListener('keydown', (e) => {
            // Ctrl+K to focus search
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                $('query').focus();
                return;
            }
            
            // Ctrl+Enter to search
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if ($('query').value.trim()) {
                    searchAll(false);
                }
                return;
            }
            
            // Escape to clear search or close modal
            if (e.key === 'Escape') {
                if ($('modalOverlay').style.display === 'flex') {
                    $('modalOverlay').style.display = 'none';
                } else {
                    $('query').value = '';
                    resetResults();
                }
                return;
            }
            
            // Ctrl+A to select all (when focus is on table)
            if (e.ctrlKey && e.key === 'a' && document.activeElement.closest('.results-table-container')) {
                e.preventDefault();
                document.querySelectorAll('.channel-checkbox').forEach(cb => cb.checked = true);
                return;
            }
        });

        /* =========================
           FIREBASE CONFIGURATION
           ========================= */
        const firebaseConfig = {
            apiKey: "AIzaSyBvU3_Njbi1JQr_wD1a16h5coTW2ifaRDU",
            authDomain: "youleadmax.firebaseapp.com",
            projectId: "youleadmax",
            storageBucket: "youleadmax.firebasestorage.app",
            messagingSenderId: "710806971072",
            appId: "1:710806971072:web:ced903befe8693f886c325",
            measurementId: "G-JW9W20C1LQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const logSearchCallable = httpsCallable(functions, 'logSearch');

        /* =========================
           ENHANCED AUTHENTICATION
           ========================= */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('app-view').classList.remove('hidden');
                $('auth-view').style.display = 'none';
                $('userInfo').textContent = `${user.email}`;
                
                // Enhanced user tracking
                try {
                    const userRef = doc(db, 'users', user.uid);
                    await setDoc(userRef, {
                        email: user.email,
                        lastLogin: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        version: '2.0'
                    }, { merge: true });
                } catch (error) {
                    console.warn('Failed to log user activity:', error);
                }
                
                showToast(`Welcome back, ${user.email}!`, 'success');
                
            } else {
                currentUser = null;
                $('app-view').classList.add('hidden');
                $('auth-view').style.display = 'flex';
                resetResults();
            }
        });

        // Enhanced authentication handlers
        $('btnSignIn').addEventListener('click', async () => {
            const email = $('authEmail').value.trim();
            const password = $('authPass').value;
            
            if (!email || !password) {
                $('authStatus').textContent = 'Please fill in all fields';
                return;
            }
            
            try {
                $('btnSignIn').disabled = true;
                $('btnSignIn').textContent = 'Signing in...';
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                $('authStatus').textContent = `Sign-in failed: ${error.message}`;
                $('btnSignIn').disabled = false;
                $('btnSignIn').textContent = 'Sign In';
            }
        });

        $('btnSignUp').addEventListener('click', async () => {
            const email = $('authEmail').value.trim();
            const password = $('authPass').value;
            
            if (!email || !password) {
                $('authStatus').textContent = 'Please fill in all fields';
                return;
            }
            
            if (password.length < 6) {
                $('authStatus').textContent = 'Password must be at least 6 characters';
                return;
            }
            
            try {
                $('btnSignUp').disabled = true;
                $('btnSignUp').textContent = 'Creating account...';
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                $('authStatus').textContent = `Sign-up failed: ${error.message}`;
                $('btnSignUp').disabled = false;
                $('btnSignUp').textContent = 'Create Account';
            }
        });

        $('btnSignOut').addEventListener('click', async () => {
            if (await showModal('Sign Out', 'Are you sure you want to sign out?', 'Sign Out', 'Cancel')) {
                await signOut(auth);
                showToast('Signed out successfully', 'info');
            }
        });

        /* =========================
           ENHANCED SEARCH FUNCTIONALITY
           ========================= */
        $('btnSearch').addEventListener('click', () => searchAll(false));
        $('btnDeepSearch').addEventListener('click', async () => {
            const query = $('query').value.trim();
            if (!query) {
                showToast('Please enter search terms first', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('Please sign in to use Deep Search', 'error');
                return;
            }
            
            const confirmed = await showModal(
                'Deep Search Confirmation',
                'Deep Search will consume more API credits by searching more pages and may take longer. Continue?',
                'Yes, Continue',
                'Cancel'
            );
            
            if (confirmed) {
                searchAll(true);
            }
        });

        $('btnClear').addEventListener('click', () => {
            $('query').value = '';
            resetResults();
            showToast('Search cleared', 'info');
        });

        // Enhanced search with caching and abort capability
        async function searchAll(isDeepSearch = false) {
            const queryRaw = $('query').value.trim();
            const queries = queryRaw.split(/[,\n]/).map(q => q.trim()).filter(Boolean);
            const perPage = Math.max(1, Math.min(50, Number($('perPage').value) || 25));
            const pages = isDeepSearch ? 20 : Math.max(1, Math.min(10, Number($('pages').value) || 2));

            // Validation
            if (!queries.length) {
                showToast('Please enter at least one search query', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('Please sign in to search', 'error');
                return;
            }

            const apiKey = $('apiKey').value.trim();
            if (!apiKey) {
                showToast('Please enter your YouTube API key', 'error');
                return;
            }

            // Cancel previous search
            if (abortController) {
                abortController.abort();
            }
            abortController = new AbortController();

            // Cache key for this search
            const cacheKey = JSON.stringify({ queries, perPage, pages, 
                order: $('order').value, 
                duration: $('duration').value,
                region: $('region').value 
            });

            // Check cache first (for exact same searches)
            if (searchCache.has(cacheKey) && !isDeepSearch) {
                LIB = searchCache.get(cacheKey);
                applyClientFiltersAndRender();
                showToast('Results loaded from cache', 'info');
                return;
            }

            resetResults();
            setStatus('Searching for channels...', 'loading');
            setProgress(0);

            try {
                // Log search activity
                try {
                    await logSearchCallable({ query: queryRaw, isDeepSearch });
                } catch (logError) {
                    console.warn('Failed to log search:', logError);
                }

                const channelIds = new Set();
                const totalSteps = queries.length * pages;
                let completed = 0;

                // Search for videos to find channels
                for (const query of queries) {
                    await searchVideosForChannels(query, pages, perPage, channelIds, (progress) => {
                        completed = progress;
                        setProgress(completed / totalSteps * 0.6);
                    });
                    
                    if (abortController.signal.aborted) return;
                }

                if (channelIds.size === 0) {
                    setStatus('No channels found', 'info');
                    showToast('No channels found for your search terms', 'info');
                    return;
                }

                setStatus(`Found ${channelIds.size} unique channels — fetching details...`, 'loading');

                // Fetch channel details in batches
                const channels = await fetchChannelDetails(Array.from(channelIds), (progress) => {
                    setProgress(0.6 + progress * 0.4);
                });

                if (abortController.signal.aborted) return;

                LIB = channels;
                
                // Cache successful results
                if (LIB.length > 0) {
                    searchCache.set(cacheKey, LIB.slice());
                    // Limit cache size
                    if (searchCache.size > 10) {
                        const firstKey = searchCache.keys().next().value;
                        searchCache.delete(firstKey);
                    }
                }

                applyClientFiltersAndRender();
                setStatus(`Found ${LIB.length} channels`, 'success');
                showToast(`Successfully found ${LIB.length} channels!`, 'success');
                setProgress(1);

            } catch (error) {
                if (error.name === 'AbortError') {
                    setStatus('Search cancelled', 'info');
                    showToast('Search was cancelled', 'info');
                } else {
                    console.error('Search error:', error);
                    setStatus('Search failed', 'error');
                    showToast(`Search failed: ${error.message}`, 'error');
                }
                setProgress(0);
            }
        }

        // Enhanced video search with better error handling
        async function searchVideosForChannels(query, pages, perPage, channelIds, onProgress) {
            const apiKey = $('apiKey').value.trim();
            const order = $('order').value;
            const duration = $('duration').value;
            const upload = $('upload').value;
            const region = $('region').value;
            
            let pageToken = '';
            let completed = 0;
            
            for (let page = 0; page < pages; page++) {
                if (!pageToken && page > 0) break;
                if (abortController.signal.aborted) throw new DOMException('Aborted', 'AbortError');
                
                const url = new URL('https://www.googleapis.com/youtube/v3/search');
                url.searchParams.set('part', 'snippet');
                url.searchParams.set('type', 'video');
                url.searchParams.set('q', query);
                url.searchParams.set('maxResults', String(perPage));
                url.searchParams.set('order', order);
                url.searchParams.set('key', apiKey);
                
                if (region) url.searchParams.set('regionCode', region);
                if (duration) url.searchParams.set('videoDuration', duration);
                if (upload) url.searchParams.set('publishedAfter', getPublishedAfterISO(upload));
                if (pageToken) url.searchParams.set('pageToken', pageToken);
                
                const response = await fetch(url.toString(), { 
                    signal: abortController.signal 
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`YouTube API error (${response.status}): ${errorText}`);
                }
                
                const data = await response.json();
                
                // Process results with enhanced filtering
                (data.items || []).forEach(item => {
                    const title = (item.snippet.title || '').toLowerCase();
                    const description = (item.snippet.description || '').toLowerCase();
                    
                    // Enhanced Shorts filtering
                    const isShortsContent = 
                        title.includes('#shorts') || 
                        title.includes('shorts ') || 
                        title.endsWith('shorts') ||
                        description.includes('#shorts') ||
                        description.includes('shorts ');
                    
                    if (!isShortsContent && item.snippet.channelId) {
                        channelIds.add(item.snippet.channelId);
                    }
                });
                
                pageToken = data.nextPageToken || '';
                completed++;
                onProgress(completed);
                
                // Rate limiting
                await sleep(200);
            }
        }

        // Enhanced channel details fetching
        async function fetchChannelDetails(channelIds, onProgress) {
            const apiKey = $('apiKey').value.trim();
            const channels = [];
            const batchSize = 50;
            
            for (let i = 0; i < channelIds.length; i += batchSize) {
                if (abortController.signal.aborted) throw new DOMException('Aborted', 'AbortError');
                
                const batch = channelIds.slice(i, i + batchSize);
                const url = new URL('https://www.googleapis.com/youtube/v3/channels');
                url.searchParams.set('part', 'snippet,statistics,brandingSettings,status');
                url.searchParams.set('id', batch.join(','));
                url.searchParams.set('key', apiKey);
                
                const response = await fetch(url.toString(), { 
                    signal: abortController.signal 
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`YouTube API error (${response.status}): ${errorText}`);
                }
                
                const data = await response.json();
                
                (data.items || []).forEach(channel => {
                    if (!channel.snippet?.title) return;
                    
                    const stats = channel.statistics || {};
                    const snippet = channel.snippet;
                    const branding = channel.brandingSettings || {};
                    const status = channel.status || {};
                    
                    // Enhanced country detection
                    let country = snippet.country || 
                                branding.channel?.country || 
                                branding.channel?.defaultLanguage || '';
                    
                    // Enhanced verification check
                    const isVerified = status.isLinked || 
                                     snippet.customUrl?.includes('/c/') || 
                                     snippet.customUrl?.includes('/@') || 
                                     false;
                    
                    channels.push({
                        title: snippet.title,
                        description: snippet.description || '',
                        channelId: channel.id,
                        subs: Number(stats.subscriberCount || 0),
                        views: Number(stats.viewCount || 0),
                        videos: Number(stats.videoCount || 0),
                        verified: isVerified ? 'Yes' : 'No',
                        avatar: snippet.thumbnails?.high?.url || 
                               snippet.thumbnails?.medium?.url || 
                               snippet.thumbnails?.default?.url || '',
                        banner: branding.image?.bannerExternalUrl || '',
                        country: country,
                        createdAt: snippet.publishedAt?.split('T')[0] || '',
                        customUrl: snippet.customUrl || '',
                        hidden: stats.hiddenSubscriberCount || false
                    });
                });
                
                onProgress((i + batch.length) / channelIds.length);
                await sleep(200); // Rate limiting
            }
            
            return channels;
        }

        function getPublishedAfterISO(timeframe) {
            const date = new Date();
            switch (timeframe) {
                case 'hour': date.setHours(date.getHours() - 1); break;
                case 'today': date.setDate(date.getDate() - 1); break;
                case 'week': date.setDate(date.getDate() - 7); break;
                case 'month': date.setMonth(date.getMonth() - 1); break;
            }
            return date.toISOString();
        }

        /* =========================
           ENHANCED FILTERING & RENDERING
           ========================= */
        function applyClientFiltersAndRender() {
            const minSubs = Number($('minSubs').value || 0);
            const maxSubs = Number($('maxSubs').value || 0);
            const searchTerm = $('searchInResults').value.trim().toLowerCase();
            
            VIEW = LIB.filter(channel => {
                // Subscriber filters
                if (channel.subs < minSubs) return false;
                if (maxSubs > 0 && channel.subs > maxSubs) return false;
                
                // Search filter
                if (searchTerm) {
                    const searchable = [
                        channel.title,
                        channel.channelId,
                        channel.description,
                        channel.country
                    ].join(' ').toLowerCase();
                    
                    if (!searchable.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            // Apply sorting
            const sortBy = $('clientSort').value;
            VIEW.sort((a, b) => {
                switch (sortBy) {
                    case 'subs-desc': return (b.subs || 0) - (a.subs || 0);
                    case 'subs-asc': return (a.subs || 0) - (b.subs || 0);
                    case 'views-desc': return (b.views || 0) - (a.views || 0);
                    case 'views-asc': return (a.views || 0) - (b.views || 0);
                    case 'title-asc': return (a.title || '').localeCompare(b.title || '');
                    case 'title-desc': return (b.title || '').localeCompare(a.title || '');
                    default: return 0;
                }
            });
            
            renderResults();
            updateResultsCount();
            lastExport = VIEW.slice();
        }

        function renderResults() {
            const tbody = $('resultsTbody');
            tbody.innerHTML = '';
            
            if (VIEW.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-muted" style="text-align: center; padding: 40px;">
                            ${LIB.length === 0 ? 'No channels found. Try adjusting your search terms.' : 'No channels match your current filters.'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            VIEW.forEach((channel, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="channel-checkbox" data-index="${index}">
                    </td>
                    <td>
                        <div class="channel-info">
                            <img class="channel-avatar" src="${sanitize(channel.avatar)}" alt="" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iNiIgZmlsbD0iI0Y3RjZGMyIvPgo8cGF0aCBkPSJNMjAgMjZDMjMuMzEzNyAyNiAyNiAyMy4zMTM3IDI2IDIwQzI2IDE2LjY4NjMgMjMuMzEzNyAxNCAyMCAxNEMxNi42ODYzIDE0IDE0IDE2LjY4NjMgMTQgMjBDMTQgMjMuMzEzNyAxNi42ODYzIDI2IDIwIDI2WiIgZmlsbD0iIzlCOUE5NyIvPgo8L3N2Zz4K'">
                            <div>
                                <div class="channel-name">${highlightSearchTerms(sanitize(channel.title))}</div>
                                <div class="channel-id">${sanitize(channel.channelId)}</div>
                            </div>
                        </div>
                    </td>
                    <td>${channel.hidden ? 'Hidden' : formatNumber(channel.subs)}</td>
                    <td>${formatNumber(channel.videos)}</td>
                    <td>${formatNumber(channel.views)}</td>
                    <td>
                        <span style="color: ${channel.verified === 'Yes' ? 'var(--accent-green)' : 'var(--text-secondary)'}">
                            ${channel.verified === 'Yes' ? '✓' : '—'}
                        </span>
                    </td>
                    <td>${sanitize(channel.country) || '—'}</td>
                `;
                
                tr.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        renderChannelDetails(channel);
                    }
                });
                
                tbody.appendChild(tr);
            });
        }

        function highlightSearchTerms(text) {
            const searchTerm = $('searchInResults').value.trim();
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function updateResultsCount() {
            const total = LIB.length;
            const filtered = VIEW.length;
            const text = total === filtered ? 
                `${total} channels found` : 
                `${filtered} of ${total} channels shown`;
            $('resultsCount').textContent = text;
        }

        // Event listeners for real-time filtering
        ['clientSort', 'minSubs', 'maxSubs', 'searchInResults'].forEach(id => {
            $(id).addEventListener('input', debounce(applyClientFiltersAndRender, 300));
            $(id).addEventListener('change', applyClientFiltersAndRender);
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /* =========================
           ENHANCED CHANNEL DETAILS
           ========================= */
        async function renderChannelDetails(channel) {
            $('detailTitle').textContent = channel.title;
            
            const socialLinks = await getSocialLinksFromAboutPage(channel.channelId);
            const videos = await getLatestVideos(channel.channelId, 6);
            
            $('detailContent').innerHTML = `
                <div class="mb-md">
                    <div class="text-sm text-muted mb-md">
                        ${channel.channelId} • ${channel.country || 'Unknown'} • Created: ${channel.createdAt || 'Unknown'}
                    </div>
                    ${channel.customUrl ? `<div class="text-sm text-muted mb-md">Custom URL: ${sanitize(channel.customUrl)}</div>` : ''}
                    ${channel.banner ? `<div style="height: 120px; background: url('${sanitize(channel.banner)}') center/cover; border-radius: var(--border-radius); margin-bottom: var(--space-md); border: 1px solid var(--border-color);"></div>` : ''}
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${formatNumber(channel.subs)}</div>
                        <div class="stat-label">Subscribers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatNumber(channel.views)}</div>
                        <div class="stat-label">Total Views</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatNumber(channel.videos)}</div>
                        <div class="stat-label">Videos</div>
                    </div>
                </div>
                
                ${channel.description ? `
                    <div class="mb-md">
                        <h4>Description</h4>
                        <p class="text-sm text-muted" style="line-height: 1.5; max-height: 120px; overflow-y: auto;">
                            ${sanitize(channel.description).replace(/\n/g, '<br>')}
                        </p>
                    </div>
                ` : ''}
                
                ${Object.keys(socialLinks).length > 0 ? `
                    <div class="mb-md">
                        <h4>Social Links</h4>
                        <div class="flex gap-sm" style="flex-wrap: wrap;">
                            ${Object.entries(socialLinks).map(([platform, url]) => `
                                <a href="${sanitize(url)}" target="_blank" class="btn btn-small">
                                    ${platform.charAt(0).toUpperCase() + platform.slice(1)}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="mb-md">
                    <h4>Latest Videos</h4>
                    <div class="video-grid" id="channelVideos">
                        ${videos.length > 0 ? videos.map(video => `
                            <div class="video-card">
                                <img class="video-thumbnail" src="${sanitize(video.thumbnail)}" alt="" loading="lazy">
                                <div class="video-info">
                                    <div class="video-title">${sanitize(video.title)}</div>
                                    <div class="flex gap-sm mt-sm">
                                        <a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank" class="btn btn-small btn-primary">Watch</a>
                                        <button class="btn btn-small" onclick="previewVideo('${video.videoId}')">Preview</button>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<div class="text-muted">No recent videos found</div>'}
                    </div>
                </div>
            `;
        }

        async function getSocialLinksFromAboutPage(channelId) {
            const proxyUrl = $('corsProxy').value.trim();
            if (!proxyUrl) return {};
            
            try {
                const aboutUrl = `${proxyUrl}https://www.youtube.com/channel/${channelId}/about`;
                const response = await fetch(aboutUrl, { 
                    signal: AbortSignal.timeout(10000) 
                });
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const html = await response.text();
                const socialLinks = {};
                
                // Enhanced social link extraction with better patterns
                const patterns = {
                    twitter: /(?:twitter\.com|x\.com)\/([A-Za-z0-9_]+)/i,
                    instagram: /instagram\.com\/([A-Za-z0-9_.]+)/i,
                    facebook: /facebook\.com\/([A-Za-z0-9.]+)/i,
                    tiktok: /tiktok\.com\/@([A-Za-z0-9_.]+)/i,
                    linkedin: /linkedin\.com\/(?:in|company)\/([A-Za-z0-9-]+)/i,
                    website: /https?:\/\/(?!(?:youtube|twitter|instagram|facebook|tiktok|linkedin)\.com)[A-Za-z0-9.-]+\.[A-Za-z]{2,}/i
                };
                
                for (const [platform, pattern] of Object.entries(patterns)) {
                    const match = html.match(pattern);
                    if (match) {
                        socialLinks[platform] = match[0];
                    }
                }
                
                return socialLinks;
                
            } catch (error) {
                console.warn('Failed to get social links:', error);
                return {};
            }
        }

        async function getLatestVideos(channelId, maxResults = 6) {
            const apiKey = $('apiKey').value.trim();
            if (!apiKey) return [];
            
            try {
                const url = new URL('https://www.googleapis.com/youtube/v3/search');
                url.searchParams.set('part', 'snippet');
                url.searchParams.set('channelId', channelId);
                url.searchParams.set('order', 'date');
                url.searchParams.set('maxResults', String(maxResults));
                url.searchParams.set('type', 'video');
                url.searchParams.set('key', apiKey);
                
                const response = await fetch(url.toString(), { 
                    signal: AbortSignal.timeout(10000) 
                });
                
                if (!response.ok) throw new Error('Failed to fetch videos');
                
                const data = await response.json();
                
                return (data.items || []).map(item => ({
                    videoId: item.id.videoId,
                    title: item.snippet.title,
                    thumbnail: item.snippet.thumbnails?.medium?.url || 
                              item.snippet.thumbnails?.default?.url || '',
                    publishedAt: item.snippet.publishedAt
                }));
                
            } catch (error) {
                console.warn('Failed to get latest videos:', error);
                return [];
            }
        }

        // Global function for video preview
        window.previewVideo = function(videoId) {
            // Remove existing preview
            const existing = document.getElementById('videoPreview');
            if (existing) existing.remove();
            
            const iframe = document.createElement('iframe');
            iframe.id = 'videoPreview';
            iframe.width = '100%';
            iframe.height = '200';
            iframe.src = `https://www.youtube.com/embed/${videoId}`;
            iframe.setAttribute('allowfullscreen', '');
            iframe.style.marginTop = 'var(--space-md)';
            iframe.style.borderRadius = 'var(--border-radius)';
            iframe.style.border = '1px solid var(--border-color)';
            
            $('detailContent').appendChild(iframe);
        };

        /* =========================
           ENHANCED EXPORT & LIBRARY FUNCTIONS
           ========================= */
        $('btnSelectAll').addEventListener('click', () => {
            document.querySelectorAll('.channel-checkbox').forEach(cb => cb.checked = true);
            showToast('All channels selected', 'info');
        });

        $('btnDeselectAll').addEventListener('click', () => {
            document.querySelectorAll('.channel-checkbox').forEach(cb => cb.checked = false);
            showToast('All channels deselected', 'info');
        });

        $('btnExportCSV').addEventListener('click', () => {
            if (VIEW.length === 0) {
                showToast('No data to export', 'error');
                return;
            }
            
            const csv = generateCSV(VIEW);
            downloadFile(csv, 'lead_studio_pro_results.csv', 'text/csv');
            showToast(`Exported ${VIEW.length} channels to CSV`, 'success');
        });

        $('btnExportJSON').addEventListener('click', () => {
            if (VIEW.length === 0) {
                showToast('No data to export', 'error');
                return;
            }
            
            const cleanData = VIEW.map(cleanChannelData);
            const json = JSON.stringify(cleanData, null, 2);
            downloadFile(json, 'lead_studio_pro_results.json', 'application/json');
            showToast(`Exported ${VIEW.length} channels to JSON`, 'success');
        });

        $('btnCopyIDs').addEventListener('click', async () => {
            if (VIEW.length === 0) {
                showToast('No channel IDs to copy', 'error');
                return;
            }
            
            const ids = VIEW.map(c => c.channelId).join('\n');
            await copyToClipboard(ids);
            showToast(`Copied ${VIEW.length} channel IDs to clipboard`, 'success');
        });

        $('btnExportSelected').addEventListener('click', () => {
            const selected = getSelectedChannels();
            if (selected.length === 0) {
                showToast('No channels selected', 'error');
                return;
            }
            
            const csv = generateCSV(selected);
            downloadFile(csv, 'lead_studio_pro_selected.csv', 'text/csv');
            showToast(`Exported ${selected.length} selected channels`, 'success');
        });

        $('btnCopySelected').addEventListener('click', async () => {
            const selected = getSelectedChannels();
            if (selected.length === 0) {
                showToast('No channels selected', 'error');
                return;
            }
            
            const csv = generateCSV(selected);
            await copyToClipboard(csv);
            showToast(`Copied ${selected.length} selected channels to clipboard`, 'success');
        });

        $('btnClearResults').addEventListener('click', async () => {
            const confirmed = await showModal(
                'Clear Results',
                'Are you sure you want to clear all search results? This action cannot be undone.',
                'Clear All',
                'Cancel'
            );
            
            if (confirmed) {
                resetResults();
                showToast('All results cleared', 'info');
            }
        });

        function getSelectedChannels() {
            const selected = [];
            document.querySelectorAll('.channel-checkbox:checked').forEach(cb => {
                const index = parseInt(cb.dataset.index);
                if (VIEW[index]) selected.push(VIEW[index]);
            });
            return selected;
        }

        function generateCSV(channels) {
            const headers = [
                'Channel Name', 'Channel ID', 'Subscribers', 'Videos', 'Views', 
                'Verified', 'Country', 'Created Date', 'Custom URL', 'Description'
            ];
            
            let csv = headers.map(h => `"${h}"`).join(',') + '\n';
            
            channels.forEach(channel => {
                const row = [
                    channel.title,
                    channel.channelId,
                    channel.hidden ? 'Hidden' : channel.subs,
                    channel.videos,
                    channel.views,
                    channel.verified,
                    channel.country,
                    channel.createdAt,
                    channel.customUrl,
                    channel.description.replace(/\n/g, ' ')
                ].map(cell => `"${String(cell).replace(/"/g, '""')}"`);
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        function cleanChannelData(channel) {
            return {
                channelId: channel.channelId,
                title: channel.title,
                subscribers: channel.subs,
                videos: channel.videos,
                views: channel.views,
                verified: channel.verified,
                country: channel.country,
                createdAt: channel.createdAt,
                customUrl: channel.customUrl
            };
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        /* =========================
           ENHANCED LIBRARY MANAGEMENT
           ========================= */
        $('btnSaveLib').addEventListener('click', async () => {
            if (LIB.length === 0) {
                showToast('No channels to save', 'error');
                return;
            }
            
            const confirmed = await showModal(
                'Save Library',
                `Save ${LIB.length} channels to local storage? This will overwrite any existing saved library.`,
                'Save',
                'Cancel'
            );
            
            if (!confirmed) return;
            
            try {
                const libraryData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    userEmail: currentUser?.email,
                    channels: LIB,
                    searchQueries: Array.from($('query').value.split(/[,\n]/).map(q => q.trim()).filter(Boolean))
                };
                
                localStorage.setItem(savedLibraryKey, JSON.stringify(libraryData));
                showToast(`Successfully saved ${LIB.length} channels to library`, 'success');
                
            } catch (error) {
                console.error('Save error:', error);
                showToast('Failed to save library. Storage might be full.', 'error');
            }
        });

        $('btnLoadLib').addEventListener('click', async () => {
            const savedData = localStorage.getItem(savedLibraryKey);
            if (!savedData) {
                showToast('No saved library found', 'error');
                return;
            }
            
            try {
                const libraryData = JSON.parse(savedData);
                
                const confirmed = await showModal(
                    'Load Library',
                    `Load saved library with ${libraryData.channels?.length || 0} channels? This will replace your current results.`,
                    'Load',
                    'Cancel'
                );
                
                if (!confirmed) return;
                
                // Handle different library versions
                if (libraryData.version === '2.0') {
                    LIB = libraryData.channels || [];
                    if (libraryData.searchQueries?.length > 0) {
                        $('query').value = libraryData.searchQueries.join('\n');
                    }
                } else {
                    // Legacy format
                    LIB = Array.isArray(libraryData) ? libraryData : [];
                }
                
                applyClientFiltersAndRender();
                showToast(`Successfully loaded ${LIB.length} channels from library`, 'success');
                
            } catch (error) {
                console.error('Load error:', error);
                showToast('Failed to load library. Data might be corrupted.', 'error');
            }
        });

        /* =========================
           UTILITY FUNCTIONS
           ========================= */
        function resetResults() {
            LIB = [];
            VIEW = [];
            lastExport = [];
            
            $('resultsTbody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-muted" style="text-align: center; padding: 40px;">
                        Enter search terms above to find YouTube channels
                    </td>
                </tr>
            `;
            
            $('resultsCount').textContent = '0 channels found';
            $('detailTitle').textContent = 'Channel Details';
            $('detailContent').innerHTML = `
                <div class="text-muted" style="text-align: center; padding: 40px;">
                    Select a channel from the table to view details
                </div>
            `;
            
            setProgress(0);
            setStatus('Ready', 'info');
            
            // Clear search cache when results are reset
            searchCache.clear();
        }

        /* =========================
           INITIALIZATION
           ========================= */
        function init() {
            initTheme();
            
            // Auto-focus search on load (if authenticated)
            if (currentUser && $('query')) {
                setTimeout(() => $('query').focus(), 100);
            }
            
            // Enhanced keyboard support for auth form
            ['authEmail', 'authPass'].forEach(id => {
                $(id).addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        $('btnSignIn').click();
                    }
                });
            });
            
            console.log('🚀 Lead Studio Pro v2.0 initialized');
        }

        // Initialize when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    </script>
</body>
</html>
